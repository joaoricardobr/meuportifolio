<!DOCTYPE html>
<html lang="pt-BR" class=""> <!-- A classe 'dark' será adicionada/removida pelo JS -->
<head>
    <!-- Meta Tags -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Portfólio de Projetos - João Ricardo">
    <meta name="author" content="João Ricardo">
    <title>João Ricardo - Portfólio de Projetos</title>

    <!-- External Resources -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Tailwind CDN com defer -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio" defer></script>

    <!-- Supabase Client com defer -->
    <script src="https://unpkg.com/@supabase/supabase-js@2" defer></script>

    <!-- ======================================== -->
    <!--                   CSS                  -->
    <!-- ======================================== -->
    <style>
        /* --- SEU CSS COMPLETO PERMANECE AQUI --- */
        :root {
            --brand-brown: #050000; /* Sienna */
            --brand-brown-dark: #050000; /* SaddleBrown */
            --brand-gold: #D4AF37;
            --brand-light-bg: #F8F8F8;
            --brand-dark-bg: #1a1a1a;
            --brand-card-light: #FFFFFF;
            --brand-card-dark: #2D2D2D;
            --text-primary-light: #333;
            --text-primary-dark: #EAEAEA;
            --text-secondary-light: #666;
            --text-secondary-dark: #bbb;
            --border-light: #e5e7eb;
            --border-dark: #4b5563;
            --primary-action: #2563eb; /* Azul para Preview */
            --primary-action-dark: #1d4ed8; /* Azul Escuro Hover */
            --primary-action-alt-dark: var(--brand-gold);
            --secondary-action: #555;
            --secondary-action-dark: #999;
            --neutral-bg-light: #F0F0F0;
            --neutral-bg-dark: #555;
            --radius-sm: 4px; --radius-md: 8px; --radius-lg: 12px; --radius-xl: 16px; --radius-full: 9999px;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05); --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        html { scroll-behavior: smooth; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--brand-light-bg); color: var(--text-primary-light); margin: 0; min-height: 100vh; display: flex; flex-direction: column; transition: background-color 0.3s, color 0.3s; }
        .dark body { background-color: var(--brand-dark-bg); color: var(--text-primary-dark); }
        .container { width: 90%; max-width: 1280px; margin: 0 auto; }
        main.container { padding: 2.5rem 1rem; flex-grow: 1; }
        .site-header { background-color: var(--brand-card-light); box-shadow: var(--shadow-sm); padding: 1rem 0; position: sticky; top: 0; z-index: 30; transition: background-color 0.3s, box-shadow 0.3s; }
        .dark .site-header { background-color: var(--brand-card-dark); box-shadow: var(--shadow-md); }
        .header-container { display: flex; justify-content: space-between; align-items: center; gap: 1rem; }
        .logo { font-weight: 700; font-size: 1.25rem; color: var(--brand-brown); text-decoration: none; transition: color 0.2s; }
        .dark .logo { color: var(--brand-gold); }
        .logo:hover { color: var(--brand-brown-dark); }
        .dark .logo:hover { color: #f0e68c; }
        .header-actions { display: flex; align-items: center; gap: 0.5rem; }
        .header-button { display: inline-flex; align-items: center; justify-content: center; background-color: transparent; border: none; border-radius: var(--radius-md); width: 38px; height: 38px; cursor: pointer; color: #6b7280; transition: background-color 0.2s, color 0.2s, transform 0.1s; font-size: 1.1rem; }
        .header-button:hover { background-color: #f3f4f6; color: var(--brand-brown); transform: scale(1.1); }
        .dark .header-button { color: #9ca3af; }
        .dark .header-button:hover { background-color: #374151; color: var(--brand-gold); transform: scale(1.1); }
        #controls { background-color: var(--brand-card-light); padding: 1.5rem; border-radius: var(--radius-lg); margin-bottom: 2.5rem; box-shadow: var(--shadow-md); transition: background-color 0.3s, box-shadow 0.3s; }
        .dark #controls { background-color: var(--brand-card-dark); box-shadow: var(--shadow-lg); }
        .controls-layout { display: flex; flex-direction: column; gap: 1.5rem; }
        @media (min-width: 1024px) { .controls-layout { flex-direction: row; align-items: flex-end; justify-content: space-between; } .filter-section-wrapper { flex-grow: 1; margin-right: 2rem;} .search-layout-wrapper { flex-shrink: 0; } }
        .filter-section-wrapper { display: flex; flex-direction: column; gap: 1rem; }
        .filter-group-container { display: flex; flex-direction: column; gap: 0.5rem; }
        .filter-label { font-weight: 600; font-size: 0.9rem; color: var(--text-secondary-light); margin-left: 4px; }
        .dark .filter-label { color: var(--text-secondary-dark); }
        .filter-scroll-wrapper { overflow-x: auto; scrollbar-width: none; -ms-overflow-style: none; }
        .filter-scroll-wrapper::-webkit-scrollbar { display: none; }
        .filter-group { display: inline-flex; gap: 0.6rem; padding-bottom: 10px; white-space: nowrap; }
        .filter-btn { padding: 6px 14px; border-radius: var(--radius-md); font-size: 0.8rem; font-weight: 500; transition: all 0.2s ease; border: 1px solid transparent; cursor: pointer; background-color: var(--neutral-bg-light); color: var(--text-secondary-light); line-height: 1.4; flex-shrink: 0; }
        .dark .filter-btn { background-color: var(--neutral-bg-dark); color: var(--text-secondary-dark); }
        .filter-btn:hover { background-color: #E0E0E0; border-color: #ccc; color: var(--text-primary-light); transform: translateY(-2px); box-shadow: var(--shadow-sm); }
        .dark .filter-btn:hover { background-color: #666; border-color: #777; color: var(--text-primary-dark); transform: translateY(-2px); box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .filter-btn.active { background-color: var(--brand-brown); color: white; border-color: var(--brand-brown); }
        .dark .filter-btn.active { background-color: var(--brand-gold); color: #333; border-color: var(--brand-gold); }
        .filter-btn.active:hover { transform: none; box-shadow: none; filter: brightness(1.1); }
        .search-layout-wrapper { display: flex; flex-wrap: wrap; gap: 1rem; align-items: center; }
        .filter-search-container { position: relative; flex-grow: 1; min-width: 200px; max-width: 350px; }
        #filterSearchInput { width: 100%; padding: 0.6rem 0.8rem 0.6rem 2.5rem; border-radius: var(--radius-md); border: 1px solid var(--border-light); background-color: var(--brand-light-bg); color: var(--text-primary-light); font-size: 0.9rem; transition: all 0.2s; }
        .dark #filterSearchInput { background-color: var(--brand-dark-bg); border-color: var(--border-dark); color: var(--text-primary-dark); }
        #filterSearchInput:focus { outline: none; border-color: var(--brand-brown); box-shadow: 0 0 0 2px rgba(160, 82, 45, 0.3); }
        .dark #filterSearchInput:focus { border-color: var(--brand-gold); box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.3); }
        .filter-search-container .search-icon { position: absolute; left: 0.8rem; top: 50%; transform: translateY(-50%); color: var(--text-secondary-light); font-size: 0.9rem; pointer-events: none; }
        .dark .filter-search-container .search-icon { color: var(--text-secondary-dark); }
        .layout-group { display: flex; gap: 0.5rem; align-items: center; flex-shrink: 0; }
        .layout-btn { padding: 7px 12px; border-radius: var(--radius-md); font-size: 0.9rem; font-weight: 500; transition: all 0.2s ease; border: 1px solid transparent; cursor: pointer; background-color: var(--neutral-bg-light); color: var(--text-secondary-light); border-color: var(--border-light); }
        .dark .layout-btn { background-color: var(--neutral-bg-dark); color: var(--text-secondary-dark); border-color: var(--border-dark); }
        .layout-btn:hover { background-color: #E0E0E0; color: var(--text-primary-light); transform: scale(1.05); }
        .dark .layout-btn:hover { background-color: #666; color: var(--text-primary-dark); transform: scale(1.05); }
        .layout-btn.active { background-color: var(--brand-brown); color: white; border-color: var(--brand-brown); }
        .dark .layout-btn.active { background-color: var(--brand-gold); color: #333; border-color: var(--brand-gold); }
        .layout-btn.active:hover { transform: none; filter: brightness(1.1); }
        #project-gallery { display: grid; gap: 24px; grid-template-columns: 1fr; }
        @media (min-width: 640px) { #project-gallery { grid-template-columns: repeat(2, 1fr); } }
        @media (min-width: 1024px) { #project-gallery { grid-template-columns: repeat(3, 1fr); } }
        .project-card { transition: all 0.3s ease; border-radius: var(--radius-lg); background-color: var(--brand-card-light); box-shadow: var(--shadow-md); overflow: hidden; display: flex; flex-direction: column; border: 1px solid transparent; }
        .dark .project-card { background-color: var(--brand-card-dark); box-shadow: var(--shadow-lg); }
        .project-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-lg); }
        .dark .project-card:hover { box-shadow: 0 12px 30px rgba(0, 0, 0, 0.25); }
        .project-card figure { width: 100%; height: 220px; margin: 0; overflow: hidden; flex-shrink: 0; }
        .project-card img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.4s ease; }
        .project-card:hover img { transform: scale(1.05); }
        .project-card .card-content { padding: 1.25rem; display: flex; flex-direction: column; flex-grow: 1; }
        .project-card h3 { font-size: 1.125rem; font-weight: 600; color: var(--text-primary-light); margin-bottom: 0.25rem; }
        .dark .project-card h3 { color: var(--text-primary-dark); }
        .project-card .category-text { font-size: 0.75rem; color: var(--brand-brown); margin-bottom: 0.75rem; text-transform: capitalize; font-weight: 500; }
        .dark .project-card .category-text { color: var(--brand-gold); }
        .project-card .tech-tags { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 0.75rem; }
        .project-card .tech-tag { background-color: #ECECEC; color: #555; font-size: 0.7rem; padding: 3px 8px; border-radius: var(--radius-full); display: inline-block; }
        .dark .project-card .tech-tag { background-color: #444; color: #ccc; }
        .project-card .description-text { font-size: 0.875rem; color: var(--text-secondary-light); margin-bottom: 1rem; flex-grow: 1; line-height: 1.5; }
        .dark .project-card .description-text { color: var(--text-secondary-dark); }
        .project-card .card-actions { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: auto; }
        .project-card .card-button { font-size: 0.8rem; padding: 7px 12px; border-radius: var(--radius-md); transition: all 0.3s ease; border: none; cursor: pointer; font-weight: 500; display: inline-flex; align-items: center; justify-content: center; gap: 0.4rem; flex: 1 1 auto; min-width: 80px; text-decoration: none; }
        .card-button.preview { background-color: var(--primary-action); color: white; }
        .card-button.preview:hover { background-color: var(--primary-action-dark); transform: translateY(-2px); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .card-button.code { background-color: var(--secondary-action); color: white; }
        .dark .card-button.code { background-color: var(--secondary-action-dark); }
        .card-button.code:hover { background-color: #333; transform: translateY(-2px); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .dark .card-button.code:hover { background-color: #aaa; }
        .card-button.visit { background-color: var(--neutral-bg-light); color: var(--text-secondary-light); border: 1px solid var(--border-light); }
        .dark .card-button.visit { background-color: var(--neutral-bg-dark); color: var(--text-secondary-dark); border: 1px solid var(--border-dark); }
        .card-button.visit:hover { background-color: #E0E0E0; color: var(--text-primary-light); transform: translateY(-2px); box-shadow: var(--shadow-sm); }
        .dark .card-button.visit:hover { background-color: #666; color: var(--text-primary-dark); transform: translateY(-2px); box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .card-button.code[href="#"] { display: none; }
        .project-card.hidden-card { opacity: 0; transform: scale(0.95); pointer-events: none; transition: opacity 0.3s ease-out, transform 0.3s ease-out, visibility 0s linear 0.3s, max-height 0s linear 0.3s, margin 0s linear 0.3s, padding 0s linear 0.3s, border 0s linear 0.3s; visibility: hidden; max-height: 0 !important; margin: 0 !important; padding: 0 !important; border-width: 0 !important; overflow: hidden; margin-top: -24px !important; margin-bottom: -24px !important; }
        @media (max-width: 639px) { .project-card.hidden-card { margin-top: 0 !important; margin-bottom: 0 !important; } }
        #no-results { grid-column: 1 / -1; text-align: center; padding: 3rem 1rem; color: var(--text-secondary-light); }
        .dark #no-results { color: var(--text-secondary-dark); }
        #no-results.hidden { display: none; }
        #no-results i { font-size: 2.5rem; margin-bottom: 1rem; opacity: 0.5; }
        #previewModal { position: fixed; inset: 0; z-index: 50; background-color: rgba(0,0,0,0.75); display: flex; align-items: center; justify-content: center; padding: 1rem; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        #previewModal:not(.hidden) { opacity: 1; visibility: visible; }
        #previewModal .modal-content { background-color: var(--brand-card-light); border-radius: var(--radius-lg); width: 100%; height: 90%; max-width: 1200px; box-shadow: var(--shadow-lg); display: flex; flex-direction: column; overflow: hidden; transition: all 0.3s ease-in-out; transform: scale(0.95); }
        .dark #previewModal .modal-content { background-color: var(--brand-card-dark); }
        #previewModal:not(.hidden) .modal-content { transform: scale(1); }
        #previewModal.fullscreen .modal-content { width: 100%; height: 100%; max-width: none; border-radius: 0; }
        #previewModal .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 0.8rem 1.2rem; border-bottom: 1px solid var(--border-light); flex-shrink: 0; background-color: rgba(0,0,0,0.02); }
        .dark #previewModal .modal-header { border-bottom-color: var(--border-dark); background-color: rgba(255,255,255,0.05); }
        #previewModal #modalTitle { font-size: 1.1rem; font-weight: 600; color: var(--text-primary-light); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-right: 1rem; }
        .dark #previewModal #modalTitle { color: var(--text-primary-dark); }
        #previewModal .modal-actions { display: flex; gap: 0.5rem; }
        #previewModal .modal-button { display: inline-flex; align-items: center; justify-content: center; background-color: transparent; border: none; border-radius: var(--radius-md); width: 36px; height: 36px; cursor: pointer; color: #6b7280; transition: all 0.2s; font-size: 1rem; }
        #previewModal .modal-button:hover { background-color: #f3f4f6; color: var(--brand-brown); transform: scale(1.1); }
        .dark #previewModal .modal-button { color: #9ca3af; }
        .dark #previewModal .modal-button:hover { background-color: #374151; color: var(--primary-action-alt-dark); transform: scale(1.1); }
        #previewModal .modal-button.close-btn:hover { color: #EF4444; background-color: #fef2f2; transform: scale(1.1) rotate(90deg); }
        .dark #previewModal .modal-button.close-btn:hover { color: #F87171; background-color: #3f2a2a; transform: scale(1.1) rotate(90deg); }
        #previewModal .modal-body { flex-grow: 1; overflow: hidden; }
        #previewModal iframe { width: 100%; height: 100%; border: none; background-color: #f9fafb; }
        .dark #previewModal iframe { background-color: #111827; }
        .site-footer { background-color: #333; color: #bbb; padding: 1.5rem 1rem; text-align: center; margin-top: auto; font-size: 0.875rem; }
        .dark .site-footer { background-color: #111; }
        .site-footer p { margin-bottom: 0.5rem; }
        .site-footer a { color: var(--brand-gold); font-weight: 500; text-decoration: none; transition: color 0.2s; }
        .site-footer a:hover { color: #F0E68C; text-decoration: underline;}
        .site-footer .instagram-link i { margin-right: 0.3rem; }
        #gallery-loading { grid-column: 1 / -1; text-align: center; padding: 3rem 1rem; color: var(--text-secondary-light); font-size: 1.2rem; }
        .dark #gallery-loading { color: var(--text-secondary-dark); }
        #gallery-loading i { margin-right: 0.5rem; }
        #gallery-error { grid-column: 1 / -1; text-align: center; padding: 3rem 1rem; color: #dc2626; }
        .dark #gallery-error { color: #f87171; }
        #gallery-error i { margin-bottom: 1rem; }
    </style>

    <!-- Script Tailwind Config REMOVIDO -->
    <!-- <script> tailwind.config = { darkMode: 'class' } </script> -->
</head>
<body class="">

    <!-- ======================= Header ======================= -->
    <header class="site-header">
        <div class="container header-container">
            <a href="#" class="logo">João Ricardo Portfólio</a>
            <div class="header-actions">
                <button id="darkModeToggle" title="Alternar Tema" class="header-button">
                    <i class="fas fa-moon" id="darkModeIcon"></i>
                </button>
                <!-- Botão Adicionar Projeto REMOVIDO -->
            </div>
        </div>
    </header>

    <!-- ======================= Main Content ======================= -->
    <main class="container">

        <!-- ======================= Filters ======================= -->
        <section id="controls">
             <div class="controls-layout">
                 <div class="filter-section-wrapper">
                     <div class="filter-group-container">
                         <span class="filter-label">Tecnologia:</span>
                         <div class="filter-scroll-wrapper">
                             <div class="filter-group" data-filter-type="tech">
                                 <button class="filter-btn tech-filter active" data-filter="all">Todos</button>
                                 <button class="filter-btn tech-filter" data-filter="html">HTML</button>
                                 <button class="filter-btn tech-filter" data-filter="css">CSS</button>
                                 <button class="filter-btn tech-filter" data-filter="javascript">JavaScript</button>
                                 <button class="filter-btn tech-filter" data-filter="react">React</button>
                                 <button class="filter-btn tech-filter" data-filter="vue">Vue</button>
                                 <button class="filter-btn tech-filter" data-filter="angular">Angular</button>
                                 <button class="filter-btn tech-filter" data-filter="python">Python</button>
                             </div>
                         </div>
                     </div>
                     <div class="filter-group-container">
                          <span class="filter-label">Categoria:</span>
                          <div class="filter-scroll-wrapper">
                              <div class="filter-group" data-filter-type="category">
                                 <button class="filter-btn cat-filter active" data-filter="all">Todas</button>
                                 <button class="filter-btn cat-filter" data-filter="landing-page">Landing Page</button>
                                 <button class="filter-btn cat-filter" data-filter="portfolio">Portfólio</button>
                                 <button class="filter-btn cat-filter" data-filter="aplicacao">Aplicação</button>
                                 <button class="filter-btn cat-filter" data-filter="e-commerce">E-commerce</button>
                                 <button class="filter-btn cat-filter" data-filter="api">API</button>
                                 <button class="filter-btn cat-filter" data-filter="outro">Outro</button>
                              </div>
                         </div>
                     </div>
                 </div>

                 <div class="search-layout-wrapper">
                     <div class="filter-search-container">
                         <i class="fas fa-search search-icon"></i>
                         <input type="search" id="filterSearchInput" placeholder="Buscar nos projetos...">
                     </div>
                     <div class="layout-group">
                          <span class="filter-label hidden lg:inline">Layout:</span>
                         <button class="layout-btn active" data-layout="grid" title="Grade">
                             <i class="fas fa-th-large"></i>
                         </button>
                         <button class="layout-btn" data-layout="list" title="Lista">
                             <i class="fas fa-list"></i>
                         </button>
                     </div>
                 </div>
             </div>
        </section>

        <!-- ======================= Project Gallery ======================= -->
        <section id="project-gallery">
             <!-- Conteúdo será gerado pelo JS -->
             <div id="gallery-loading" class="sm:col-span-2 lg:col-span-3">
                 <i class="fas fa-spinner fa-spin"></i> Carregando projetos...
             </div>
             <div id="no-results" class="hidden sm:col-span-2 lg:col-span-3 text-center py-10">
                 <i class="fas fa-ghost fa-3x text-gray-400 dark:text-gray-600 mb-4"></i>
                 <p class="text-lg text-gray-600 dark:text-gray-400">Nenhum projeto encontrado.</p>
                 <p class="text-sm text-gray-500 dark:text-gray-500">Tente ajustar seus filtros.</p>
             </div>
        </section>

    </main>

    <!-- Add Project Panel REMOVIDO -->

    <!-- ======================= Preview Modal ======================= -->
    <div id="previewModal" class="hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h4 id="modalTitle">Preview do Projeto</h4>
                <div class="modal-actions">
                    <button id="fullscreenButton" title="Tela Cheia" class="modal-button"> <i class="fas fa-expand"></i> </button>
                    <button id="closeModalButton" title="Fechar" class="modal-button close-btn"> <i class="fas fa-times"></i> </button>
                </div>
            </div>
            <div class="modal-body">
                <iframe id="previewIframe" src="about:blank" frameborder="0" allowfullscreen></iframe>
            </div>
        </div>
    </div>

    <!-- ======================= Footer ======================= -->
    <footer class="site-footer">
         <p>© <span id="currentYear"></span> João Ricardo Portfólio. Todos os direitos reservados.</p>
         <p>Desenvolvido com <i class="fas fa-heart text-red-500"></i> por João Ricardo.</p>
         <p class="mt-2">
             <a href="https://www.instagram.com/joaoricardo.pe" target="_blank" rel="noopener noreferrer" class="instagram-link">
                 <i class="fab fa-instagram"></i> @joaoricardo.pe
             </a>
         </p>
    </footer>

    <!-- ======================= JavaScript (FINAL DO BODY) ======================= -->
    <script>
        // --- Variáveis Globais ---
        let currentFilters = { tech: 'all', category: 'all', search: '' };
        let currentLayout = localStorage.getItem('layout') || 'grid';
        let sbClient; // Será inicializado dentro do DOMContentLoaded

        // --- UTILITY FUNCTIONS ---
        function sanitizeHTML(str) { /* ... (código) ... */
            if (!str) return '';
            const temp = document.createElement('div');
            temp.textContent = str;
            return temp.innerHTML;
        }
        function ensureUrlProtocol(url) { /* ... (código) ... */
            if (!url || url.trim() === '#' || url.trim() === '') return '#';
            let trimmedUrl = url.trim();
            if (!trimmedUrl.startsWith('http://') && !trimmedUrl.startsWith('https://')) {
                return `https://${trimmedUrl}`;
            }
            return trimmedUrl;
        }
        function debounce(func, wait) { /* ... (código) ... */
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func.apply(this, args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        };

        // --- FUNÇÕES DE UI (Definidas antes do DOMContentLoaded para serem acessíveis) ---
        function applyTheme(theme) {
            const darkModeIcon = document.getElementById('darkModeIcon'); // Obter dentro da função
            document.documentElement.classList.toggle('dark', theme === 'dark');
            if (darkModeIcon) darkModeIcon.className = `fas ${theme === 'dark' ? 'fa-sun' : 'fa-moon'}`;
            localStorage.setItem('theme', theme);
        };

        function updateButtonActiveState(groupSelector, activeValue, dataAttr, activeClass = 'active') {
            const controlsContainer = document.getElementById('controls');
            if (!controlsContainer) return;
            const buttons = controlsContainer.querySelectorAll(`${groupSelector} button[${dataAttr}]`);
            buttons.forEach(btn => btn.classList.toggle(activeClass, btn.getAttribute(dataAttr) === activeValue));
        };

        function applyLayout(layout) {
            const gallery = document.getElementById('project-gallery');
            if (!gallery) return;
            gallery.classList.remove('grid', 'grid-cols-1', 'sm:grid-cols-2', 'lg:grid-cols-3', 'list-view', 'gap-6');
            if (layout === 'grid') {
                gallery.classList.add('grid', 'grid-cols-1', 'sm:grid-cols-2', 'lg:grid-cols-3', 'gap-6');
            } else if (layout === 'list') {
                 gallery.classList.add('grid', 'grid-cols-1', 'gap-6');
            }
            const layoutGroup = document.querySelector('#controls .layout-group'); // Obter dentro da função
            if(layoutGroup) {
                 updateButtonActiveState('.layout-group', layout, 'data-layout');
            }
            currentLayout = layout;
            localStorage.setItem('layout', layout);
        };

        function filterAndSearchProjects() {
             const gallery = document.getElementById('project-gallery');
             const filterSearchInput = document.getElementById('filterSearchInput');
             const galleryLoading = document.getElementById('gallery-loading');
             const noResultsDiv = document.getElementById('no-results');

             if (!gallery) return;
             const searchVal = (filterSearchInput?.value || '').toLowerCase().trim();
             currentFilters.search = searchVal; // Atualiza o filtro de busca

             const allCards = gallery.querySelectorAll(':scope > .project-card');
             let visibleCount = 0;

             if (galleryLoading && !galleryLoading.classList.contains('hidden')) {
                 galleryLoading.classList.add('hidden');
             }

             allCards.forEach(card => {
                 try {
                    const techs = (card.dataset.technologies || '').toLowerCase().split(',');
                    const categorySlug = (card.dataset.category || '').toLowerCase();
                    const title = (card.dataset.title || '').toLowerCase();
                    const desc = (card.dataset.description || '').toLowerCase();

                    const techMatch = currentFilters.tech === 'all' || techs.some(t => t.trim() === currentFilters.tech);
                    const catMatch = currentFilters.category === 'all' || categorySlug === currentFilters.category;
                    const normSearchVal = searchVal.normalize("NFD").replace(/[\u0300-\u036f]/g, ""); // Normaliza busca
                    const searchMatch = normSearchVal === '' ||
                        title.normalize("NFD").replace(/[\u0300-\u036f]/g, "").includes(normSearchVal) ||
                        desc.normalize("NFD").replace(/[\u0300-\u036f]/g, "").includes(normSearchVal) ||
                        techs.some(t => t.trim().normalize("NFD").replace(/[\u0300-\u036f]/g, "").includes(normSearchVal)) ||
                        categorySlug.includes(normSearchVal.replace(/\s+/g, '-'));

                    const isVisible = techMatch && catMatch && searchMatch;
                    card.classList.toggle('hidden-card', !isVisible);
                    if (isVisible) visibleCount++;
                 } catch (error) {
                     console.error("Error filtering card:", card, error);
                     card.classList.remove('hidden-card'); visibleCount++;
                 }
             });

             const galleryHasCards = allCards.length > 0;
             if (noResultsDiv) {
                 noResultsDiv.classList.toggle('hidden', !galleryHasCards || visibleCount > 0);
             }
        };

        function openModal(url, title) {
            const modal = document.getElementById('previewModal');
            const previewIframe = document.getElementById('previewIframe');
            const modalTitle = document.getElementById('modalTitle');
            if (!modal || !previewIframe || !modalTitle) return;
            if (!url || url === '#') { console.warn("Preview URL is invalid:", url); return; }
            modalTitle.textContent = title || 'Preview';
            previewIframe.src = 'about:blank';
            setTimeout(() => {
                console.log("Loading preview in iframe:", url);
                previewIframe.src = url;
                previewIframe.onerror = () => {
                     console.error("Failed to load iframe content for:", url);
                     modalTitle.textContent = `Erro ao carregar: ${title}`;
                 };
             }, 50);
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        };

        function closeModal() {
            const modal = document.getElementById('previewModal');
            const previewIframe = document.getElementById('previewIframe');
            const fullscreenButton = document.getElementById('fullscreenButton');
             if (!modal || !previewIframe) return;
             if (document.fullscreenElement) { document.exitFullscreen(); }
             modal.classList.add('hidden');
             if(fullscreenButton) fullscreenButton.querySelector('i').className = 'fas fa-expand';
             previewIframe.src = 'about:blank';
             document.body.style.overflow = '';
        };

        function toggleFullscreen() {
            const modal = document.getElementById('previewModal');
            if (!modal) return;
            const isInFullscreen = document.fullscreenElement;
            const elementToFullscreen = modal.querySelector('.modal-content') || modal;
            try {
                if (!isInFullscreen) {
                    if (elementToFullscreen.requestFullscreen) { elementToFullscreen.requestFullscreen(); }
                    else if (elementToFullscreen.webkitRequestFullscreen) { elementToFullscreen.webkitRequestFullscreen(); }
                    else if (elementToFullscreen.msRequestFullscreen) { elementToFullscreen.msRequestFullscreen(); }
                } else {
                    if (document.exitFullscreen) { document.exitFullscreen(); }
                    else if (document.webkitExitFullscreen) { document.webkitExitFullscreen(); }
                    else if (document.msExitFullscreen) { document.msExitFullscreen(); }
                }
            } catch (err) { console.error("Fullscreen API error:", err); }
        }
        function handleFullscreenChange() {
            const modal = document.getElementById('previewModal');
            const fullscreenButton = document.getElementById('fullscreenButton');
            if (!fullscreenButton || !modal) return;
            const isInFullscreen = !!document.fullscreenElement;
            fullscreenButton.querySelector('i').className = isInFullscreen ? 'fas fa-compress' : 'fas fa-expand';
            modal.classList.toggle('fullscreen', isInFullscreen);
        }


        // --- DATA FETCHING AND RENDERING ---
        async function fetchProjectsFromSupabase() { /* ... (código mantido) ... */
            console.log("Attempting to fetch projects...");
            const galleryLoading = document.getElementById('gallery-loading');
            const gallery = document.getElementById('project-gallery');
            const noResultsDiv = document.getElementById('no-results');

            if (!sbClient) {
                 console.error("Supabase client is not available when trying to fetch.");
                 if (gallery) gallery.innerHTML = '<div id="gallery-error" class="sm:col-span-2 lg:col-span-3 text-center py-10 text-red-600"><p>Erro Crítico: Cliente Supabase não inicializado.</p></div>';
                 if (galleryLoading) galleryLoading.classList.add('hidden');
                 return;
            }

            if (galleryLoading) galleryLoading.classList.remove('hidden');
            if (noResultsDiv) noResultsDiv.classList.add('hidden');
            if (gallery) {
                gallery.querySelectorAll('.project-card').forEach(card => card.remove());
                 if (!gallery.contains(galleryLoading)) gallery.prepend(galleryLoading);
            }

            try {
                console.log("Executing Supabase query: sbClient.from('projects').select(...)");
                const { data: projects, error, status } = await sbClient
                    .from('projects')
                    .select('id, name, url, description, image_url, category, technologies, code_url, created_at')
                    .order('created_at', { ascending: false });

                 console.log("Supabase response status:", status);
                 console.log("Supabase response error:", error);
                 // console.log("Supabase response data:", projects);

                if (error) {
                    console.error("Supabase fetch error details:", error);
                    if (error.message.includes("fetch failed") || status === 0) { throw new Error("Falha na conexão com o Supabase. Verifique sua rede ou a URL."); }
                    else if (status === 404 || error.message.includes("does not exist")) {
                         const missingMatch = error.message.match(/(?:column|relation) \"?(\w+(?:\.\w+)?)\"? does not exist/);
                         const missingItem = missingMatch ? `'${missingMatch[1]}'` : "Tabela 'projects' ou coluna";
                         throw new Error(`${missingItem} não encontrado. Verifique o schema.`);
                     } else if (status === 401 || status === 403) { throw new Error("Acesso não autorizado. Verifique a Anon Key e as políticas RLS."); }
                     throw new Error(`Erro Supabase (${status}): ${error.message}`);
                }

                renderProjects(projects);

            } catch (error) {
                console.error("Error caught in fetchProjectsFromSupabase:", error);
                if (gallery) {
                    if (galleryLoading && gallery.contains(galleryLoading)) gallery.removeChild(galleryLoading);
                    gallery.innerHTML = `
                        <div id="gallery-error" class="sm:col-span-2 lg:col-span-3 text-center py-10 text-red-600">
                            <i class="fas fa-exclamation-triangle fa-3x mb-4"></i>
                            <p class="text-lg font-semibold">Erro ao carregar projetos!</p>
                            <p class="text-sm mt-2">${sanitizeHTML(error.message)}</p>
                        </div>`;
                }
            } finally {
                if (galleryLoading && gallery && gallery.contains(galleryLoading)) {
                    gallery.removeChild(galleryLoading);
                }
            }
        }

        function renderProjects(projects) { /* ... (código mantido) ... */
            const gallery = document.getElementById('project-gallery');
            const noResultsDiv = document.getElementById('no-results');
            const defaultImageUrl = 'https://placehold.co/400x220/e0e7ff/4338ca/png?text=Projeto';

            if (!gallery) { console.error("renderProjects: #project-gallery not found!"); return; }

            gallery.querySelectorAll('.project-card').forEach(card => card.remove());

            if (!projects || projects.length === 0) {
                console.log("No projects received or array is empty.");
                if (noResultsDiv) noResultsDiv.classList.remove('hidden');
                return;
            }

            console.log(`Rendering ${projects.length} projects.`);
            if (noResultsDiv) noResultsDiv.classList.add('hidden');

            projects.forEach((project, index) => {
                const techs = (project.technologies || '').split(',').map(t => t.trim().toLowerCase()).filter(Boolean);
                const title = sanitizeHTML(project.name || 'Projeto Sem Título');
                const category = sanitizeHTML(project.category || 'Outro');
                const categorySlug = category.toLowerCase().replace(/\s+/g, '-').replace(/[^\w-]+/g, '');
                const description = sanitizeHTML(project.description || 'Sem descrição.');
                const imageUrl = project.image_url || defaultImageUrl;
                const liveUrl = ensureUrlProtocol(project.url);
                const codeUrl = ensureUrlProtocol(project.code_url);

                const card = document.createElement('article');
                card.className = 'project-card';
                card.dataset.technologies = techs.join(',');
                card.dataset.category = categorySlug;
                card.dataset.title = title.toLowerCase();
                card.dataset.description = description.toLowerCase();

                card.innerHTML = `
                    <figure>
                        <img src="${imageUrl}" alt="Preview ${title}" loading="lazy" onerror="this.onerror=null; this.src='${defaultImageUrl}';">
                    </figure>
                    <div class="card-content">
                        <h3>${title}</h3>
                        <p class="category-text">${category}</p>
                        <div class="tech-tags">
                            ${techs.length > 0 ? techs.map(t => `<span class="tech-tag">${sanitizeHTML(t)}</span>`).join('') : '<span class="tech-tag text-gray-500">N/A</span>'}
                        </div>
                        <p class="description-text">${description}</p>
                        <div class="card-actions">
                            <button class="card-button preview preview-button" data-preview-url="${liveUrl}" ${liveUrl === '#' ? 'disabled title="Preview indisponível"' : ''}>
                                <i class="fas fa-eye"></i> Preview
                            </button>
                            <a href="${codeUrl}" target="_blank" rel="noopener noreferrer" class="card-button code" ${codeUrl === '#' ? 'style="display:none;"' : ''}>
                                <i class="fab fa-github"></i> Código
                            </a>
                            <a href="${liveUrl}" target="_blank" rel="noopener noreferrer" class="card-button visit" ${liveUrl === '#' ? 'style="display:none;"' : ''}>
                                <i class="fas fa-external-link-alt"></i> Visitar
                            </a>
                        </div>
                    </div>`;
                gallery.appendChild(card);
            });

            // Garante que applyLayout e filterAndSearchProjects estão definidas antes de chamar
            if (typeof applyLayout === 'function' && typeof filterAndSearchProjects === 'function') {
                applyLayout(localStorage.getItem('layout') || 'grid');
                filterAndSearchProjects();
            } else {
                console.error("applyLayout or filterAndSearchProjects is not defined globally or in scope.");
            }
        }

        // --- Event Listener Principal ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM fully loaded and parsed.");

            // --- Inicializa Supabase Client AQUI ---
            const SUPABASE_URL = 'https://hqgcjyujpicmsbtfsbwv.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhxZ2NqeXVqcGljbXNidGZzYnd2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDE5NDYxNTksImV4cCI6MjA1NzUyMjE1OX0.sWuvGLebMDsSo23iuzdci5utbfbqWEO_uPFl7ztQWFk';
            try {
                // Verifica se o objeto global 'supabase' existe (foi carregado pelo script deferido)
                if (typeof supabase !== 'undefined') {
                    sbClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    console.log("Supabase client initialized successfully inside DOMContentLoaded.");
                } else {
                     throw new Error("'supabase' global object not found. Supabase library might not have loaded.");
                }
            } catch (error) {
                 console.error("Error initializing Supabase client inside DOMContentLoaded:", error);
                 const gallery = document.getElementById('project-gallery');
                 const galleryLoading = document.getElementById('gallery-loading');
                 if (gallery) gallery.innerHTML = `<div id="gallery-error" class="sm:col-span-2 lg:col-span-3 text-center py-10 text-red-600"><p>Erro Crítico: Não foi possível inicializar o Supabase.</p></div>`;
                 if (galleryLoading) galleryLoading.classList.add('hidden');
                 return; // Interrompe a execução adicional se o Supabase falhar
            }

            // --- DOM ELEMENTS (Obter após DOM pronto) ---
            const gallery = document.getElementById('project-gallery');
            const noResultsDiv = document.getElementById('no-results');
            const darkModeToggle = document.getElementById('darkModeToggle');
            const controlsContainer = document.getElementById('controls');
            const filterSearchInput = document.getElementById('filterSearchInput');
            const modal = document.getElementById('previewModal');
            const closeModalButton = document.getElementById('closeModalButton');
            const fullscreenButton = document.getElementById('fullscreenButton');
            const currentYearSpan = document.getElementById('currentYear');
            const galleryLoading = document.getElementById('gallery-loading');

            // --- INITIALIZATION ---
            if (currentYearSpan) currentYearSpan.textContent = new Date().getFullYear();
            const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            applyTheme(savedTheme);

            // --- FETCH DATA ON LOAD ---
            fetchProjectsFromSupabase(); // Agora chama com sbClient inicializado

            // --- EVENT LISTENERS ---
            if (darkModeToggle) darkModeToggle.addEventListener('click', () => applyTheme(document.documentElement.classList.contains('dark') ? 'light' : 'dark'));

            if (controlsContainer) {
                controlsContainer.addEventListener('click', (e) => {
                    const target = e.target.closest('button');
                    if (!target) return;
                    if (target.classList.contains('filter-btn')) {
                        const group = target.closest('.filter-group');
                        if (!group) return;
                        const type = group.dataset.filterType;
                        const value = target.dataset.filter;
                        if (currentFilters[type] !== value) {
                            currentFilters[type] = value;
                            updateButtonActiveState(`.filter-group[data-filter-type="${type}"]`, value, 'data-filter');
                            filterAndSearchProjects();
                        }
                    } else if (target.classList.contains('layout-btn')) {
                        const layout = target.dataset.layout;
                        if (currentLayout !== layout) {
                            applyLayout(layout);
                        }
                    }
                });
            }

            if (filterSearchInput) {
                filterSearchInput.addEventListener('input', debounce(filterAndSearchProjects, 350));
            }

            if (gallery) {
                gallery.addEventListener('click', (e) => {
                    const btn = e.target.closest('button.preview-button');
                    if (btn && !btn.disabled) {
                        e.preventDefault();
                        const url = btn.dataset.previewUrl;
                        const card = btn.closest('.project-card');
                        const title = card?.querySelector('h3')?.textContent || 'Preview';
                        openModal(url, title);
                    }
                });
            }

            if (closeModalButton) closeModalButton.addEventListener('click', closeModal);
            if (fullscreenButton) fullscreenButton.addEventListener('click', toggleFullscreen);
            if (modal) modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
            document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && modal && !modal.classList.contains('hidden')) closeModal(); });
            document.addEventListener('fullscreenchange', handleFullscreenChange);
            document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
            document.addEventListener('msfullscreenchange', handleFullscreenChange);

        }); // End DOMContentLoaded
    </script>

</body>
</html>
