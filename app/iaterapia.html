<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plano Terapêutico Personalizado</title>
    <!-- CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        /* --- Root Variables --- */
        :root {
            --primary: #4F46E5;
            --secondary: #6366F1;
            --accent: #C7D2FE;
            --bg-light: #F9FAFB;
            --text-dark: #1F2937;
            --text-light: #f8f9fa;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --info: #3B82F6;
            --light: #F3F4F6;
            --white: #FFFFFF;
            --border-color: #E5E7EB;
        }

        /* --- Body & App Base --- */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-light);
            color: var(--text-dark);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s ease;
        }
        #app { flex-grow: 1; position: relative; z-index: 1; }

        /* --- Navbar --- */
        .navbar {
            background: var(--primary) !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 10;
        }
        .navbar-brand { font-weight: 600; color: var(--white) !important; }
        .nav-link-custom, .settings-btn {
            background-color: rgba(255,255,255,0.2);
            border: none; color: var(--white);
            padding: 0.375rem 0.75rem; border-radius: 0.375rem;
            transition: background-color 0.3s ease;
            margin-left: 0.5rem; /* Default margin for desktop */
            display: inline-flex; align-items: center; justify-content: center;
            text-decoration: none;
        }
        .nav-link-custom:hover, .settings-btn:hover {
             background-color: rgba(255,255,255,0.3); color: var(--white);
        }
        .navbar-toggler { border-color: rgba(255,255,255,0.3); }
        .navbar-toggler-icon { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='rgba%28255, 255, 255, 1%29' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e"); }
        .navbar-toggler:focus { box-shadow: 0 0 0 0.2rem rgba(255,255,255,0.5); }
        .navbar-nav-custom-group { display: flex; align-items: center; }
        @media (max-width: 991.98px) { /* Mobile/Tablet Navbar Collapse */
            .navbar-collapse { padding-top: 1rem; padding-bottom: 1rem; }
            .navbar-nav-custom-group { width: 100%; flex-direction: column; align-items: center !important; gap: 0.75rem; }
            .navbar-nav-custom-group .nav-link-custom,
            .navbar-nav-custom-group .settings-btn { width: 85%; max-width: 250px; text-align: center; justify-content: center; margin-left: 0 !important; }
        }

        /* --- Video Background --- */
        #bgVideo, #videoOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -2; opacity: 0; pointer-events: none; transition: opacity 0.5s ease-in-out; object-fit: cover; }
        #videoOverlay { background-color: rgba(0,0,0,0.5); z-index: -1; }
        body.video-background-active #bgVideo, body.video-background-active #videoOverlay { opacity: 1; }
        body.video-background-active #homeScreen h2, body.video-background-active #homeScreen h3 { color: var(--text-light); text-shadow: 1px 1px 3px rgba(0,0,0,0.7); }
        body:not(.video-background-active) { background-color: var(--bg-light); }

        /* --- Home Screen & Search --- */
        #homeScreen { padding-top: 4rem; padding-bottom: 4rem; min-height: calc(100vh - 56px); display: flex; flex-direction: column; align-items: center; text-align: center; transition: color 0.3s ease; }
        #homeScreen h2 { color: var(--primary); }
        body.video-background-active #homeScreen h2 { color: var(--text-light); }
        .search-container { position: relative; max-width: 500px; margin: 0 auto 2rem auto; }
        .search-container input[type="text"] { width: 100%; padding: 0.85rem 1.2rem; border-radius: 50px; border: 1px solid var(--border-color); font-size: 1rem; padding-right: 3.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05); background: rgba(255,255,255,0.9); }
        body.video-background-active .search-container input[type="text"] { background: rgba(255,255,255,0.2); border-color: rgba(255,255,255,0.3); color: var(--text-light); }
        .search-container input[type="text"]::placeholder { color: #aaa; }
        body.video-background-active .search-container input[type="text"]::placeholder { color: rgba(255,255,255,0.7); }
        .search-container input[type="text"]:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(79,70,229,0.2); outline: none; }
        .search-container button { position: absolute; right: 0.6rem; top: 50%; transform: translateY(-50%); background: var(--primary); border: none; color: var(--white); border-radius: 50%; width: 38px; height: 38px; display: flex; align-items: center; justify-content: center; }
        .search-container button:hover { background-color: var(--secondary); }

        /* --- Sentiment & Topic Buttons --- */
        .sentiment-buttons-row { max-width: 1000px; width: 90%; margin-top: 1rem; } /* Reduced margin-top slightly */
        .sentiment-buttons-row .col-6,
        .sentiment-buttons-row .col-md-4,
        .sentiment-buttons-row .col-lg-3 { display: flex; align-items: stretch; } /* Equal height columns */
        .sentiment-btn {
            background: rgba(255,255,255,0.1); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(255,255,255,0.2); box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            color: var(--text-light); border-radius: 0.75rem; font-weight: 600;
            display: flex; align-items: center; justify-content: center;
            width: 100%; height: 100%; /* Fill column height/width */
            padding: 0.8rem 0.4rem; /* Adjusted padding */
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3); position: relative; overflow: hidden;
            transition: all 0.3s ease; text-align: center;
            font-size: 0.9rem; /* Base size */
        }
        body:not(.video-background-active) .sentiment-btn { background: var(--white); border: 1px solid var(--accent); box-shadow: 0 2px 4px rgba(0,0,0,0.05); color: var(--primary); backdrop-filter: none; text-shadow: none; }
        .sentiment-btn:hover { background: rgba(255,255,255,0.2); box-shadow: 0 0 20px rgba(255,255,255,0.8), 0 6px 25px rgba(0,0,0,0.15); filter: brightness(1.2); transform: translateY(-3px); border-color: rgba(255,255,255,0.4); color: var(--text-light); }
        body:not(.video-background-active) .sentiment-btn:hover { background: var(--accent); box-shadow: 0 0 20px rgba(255,255,255,0.8), 0 6px 12px rgba(79,70,229,0.15); color: var(--primary); }
        .sentiment-btn i { margin-right: 0.5rem; font-size: 1.1rem; /* Slightly smaller icon */ }
        .sentiment-btn span { position: relative; z-index: 2; line-height: 1.2; } /* Improve text wrapping */

        /* Specific styling for Topic buttons if needed, inherits .sentiment-btn */
        #topicsContainer .sentiment-btn {
             font-size: 0.85rem; padding: 0.6rem 0.4rem;
        }
        #topicsContainer h3 {
            color: var(--primary); margin-top: 3rem; margin-bottom: 1.5rem;
        }
        body.video-background-active #topicsContainer h3 {
            color: var(--text-light); text-shadow: 1px 1px 3px rgba(0,0,0,0.7);
        }

        /* --- Other Screens --- */
        #planScreen, #settingsScreen, #historyScreen, #favoritesScreen { padding: 1.5rem; background-color: var(--bg-light); }
        #planScreen h2, #settingsScreen h2, #historyScreen h2, #favoritesScreen h2 { color: var(--primary); font-weight: 600; display: flex; align-items: center; }

        /* --- Plan Display --- */
        .plan-card { background: var(--white); border-radius: 1rem; padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border: 1px solid var(--border-color); }
        .day-header { border-bottom: 2px solid var(--accent); padding-bottom: 0.75rem; margin-bottom: 1.25rem; display: flex; justify-content: space-between; align-items: center; }
        .day-number { font-weight: 600; font-size: 1.2rem; color: var(--primary); }
        .activity-item { padding: 1.25rem; border: 1px solid var(--light); background-color: var(--light); border-radius: 0.5rem; margin-bottom: 1rem; position: relative; }
        .activity-item:last-child { margin-bottom: 0; }
        .activity-item h5 { font-weight: 600; color: var(--text-dark); margin-bottom: 0.25rem; }
        .activity-item p { color: #4B5563; margin-bottom: 1rem; font-size: 0.95rem; line-height: 1.6; }
        .activity-details { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem; }
        .badge { padding: 0.4em 0.8em; font-size: 0.8rem; font-weight: 600; border-radius: 50px; color: var(--white); }
        .badge-category { background-color: var(--secondary); }
        .badge-duration { background-color: var(--info); }
        .badge-benefit { background-color: var(--success); }
        .intensity-badge { font-size: 0.85rem; padding: 0.3rem 0.7rem; border-radius: 5px; color: var(--white); }
        .intensity-leve { background-color: var(--success); }
        .intensity-média { background-color: var(--warning); color: var(--text-dark); }
        .intensity-profunda { background-color: var(--danger); }
        .activity-actions { display: flex; justify-content: flex-end; gap: 0.5rem; border-top: 1px solid var(--border-color); padding-top: 0.75rem; margin-top: 0.5rem; }
        .action-btn { background: none; border: none; color: var(--secondary); font-size: 1.1rem; padding: 0.25rem 0.5rem; border-radius: 4px; transition: background-color 0.2s ease, color 0.2s ease; cursor: pointer; }
        .action-btn:hover { background-color: var(--accent); color: var(--primary); }
        .action-btn.favorited i { color: var(--danger); }

        /* --- Loading, Disclaimer, Plan Intro/Closing --- */
        #loadingIndicator { display: none; text-align: center; padding: 2rem; color: var(--primary); }
        .spinner-border { width: 3rem; height: 3rem; color: var(--primary); }
        .disclaimer { color: var(--danger); font-weight: bold; padding: 1rem; background-color: #FEE2E2; border: 1px solid var(--danger); border-radius: 0.5rem; margin-bottom: 1.5rem; text-align: center; }
        .plan-introduction, .plan-closing { margin-bottom: 1.5rem; padding: 1rem; background-color: var(--white); border-radius: 0.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05); font-style: italic; color: var(--text-dark); }

        /* --- Settings --- */
        .settings-card { background: var(--white); border-radius: 1rem; padding: 2rem; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border: 1px solid var(--border-color); }
        .settings-card .form-label { font-weight: 600; margin-bottom: 0.5rem; }
        .settings-card .form-control { background-color: var(--white); cursor: text; }
        .settings-card .form-control:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(79,70,229,0.2); }
        .settings-card .btn-primary { background-color: var(--primary); border-color: var(--primary); font-weight: 600; }
        .settings-card .btn-primary:hover { background-color: var(--secondary); border-color: var(--secondary); }

        /* --- Share Modal --- */
        #shareModal .modal-body a { display: inline-block; margin: 0.5rem; font-size: 1.5rem; color: var(--primary); transition: transform 0.2s ease; }
        #shareModal .modal-body a:hover { color: var(--secondary); transform: scale(1.1); }

        /* --- Responsive Adjustments --- */
        @media (max-width: 768px) {
            #planScreen h2 { font-size: 1.5rem; }
            .plan-card { padding: 1rem; }
            .activity-item { padding: 1rem; }
            .action-btn { font-size: 1rem; padding: 0.2rem 0.4rem;}
            .sentiment-btn { font-size: 0.85rem; } /* Adjust button size */
            #topicsContainer .sentiment-btn { font-size: 0.8rem; }
        }
        @media (max-width: 576px) {
            #homeScreen { padding-top: 3rem; padding-bottom: 3rem; }
            #homeScreen h2 { font-size: 1.8rem; }
            .search-container { max-width: 90%; margin-bottom: 1.5rem; }
            .activity-actions { gap: 0.3rem; }
            .action-btn { font-size: 0.9rem; padding: 0.15rem 0.3rem;}
            .sentiment-btn { font-size: 0.8rem; padding: 0.6rem 0.3rem; } /* Further adjust size */
            #topicsContainer .sentiment-btn { font-size: 0.75rem; padding: 0.5rem 0.3rem; }
        }
    </style>
</head>
<body>
    <!-- Video Background -->
    <div id="videoOverlay"></div>
    <video autoplay loop muted playsinline id="bgVideo">
        <source src="https://cdn.pixabay.com/video/2024/11/07/240320_large.mp4" type="video/mp4">
        Seu navegador não suporta vídeos HTML5.
    </video>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#" id="homeLink"> <i class="bi bi-heart-pulse-fill me-2"></i>Plano Terapêutico </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavContent" aria-controls="navbarNavContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNavContent">
                <div class="navbar-nav-custom-group ms-lg-auto">
                    <button class="nav-link-custom" id="historyBtn"><i class="bi bi-clock-history me-1"></i> Histórico</button>
                    <button class="nav-link-custom" id="favoritesBtn"><i class="bi bi-heart-fill me-1"></i> Favoritos</button>
                    <button class="settings-btn" id="settingsBtn" aria-label="Configurações"><i class="bi bi-gear-fill"></i></button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main App Container -->
    <div class="container py-4" id="app">

        <!-- Home Screen -->
        <div id="homeScreen">
            <h2 class="mb-3 text-center">Como você está se sentindo hoje?</h2>
            <div class="search-container mb-4">
                <input type="text" id="sentimentInput" placeholder="Digite um sentimento ou tópico..." aria-label="Digite seu sentimento ou tópico">
                <button id="searchBtn" aria-label="Gerar plano"><i class="bi bi-search"></i></button>
            </div>
            <h3 class="text-center mb-4" style="font-weight:400;">Ou escolha uma opção de sentimento:</h3>
            <div class="row g-3 justify-content-center sentiment-buttons-row">
              <div class="col-6 col-md-4 col-lg-3 d-flex"><button class="btn sentiment-btn w-100" data-sentiment="alegria"><span><i class="bi bi-brightness-alt-high"></i> Alegria</span></button></div>
<div class="col-6 col-md-4 col-lg-3 d-flex"><button class="btn sentiment-btn w-100" data-sentiment="esperança"><span><i class="bi bi-stars"></i> Esperança</span></button></div>
<div class="col-6 col-md-4 col-lg-3 d-flex"><button class="btn sentiment-btn w-100" data-sentiment="calma"><span><i class="bi bi-droplet"></i> Calma</span></button></div>
<div class="col-6 col-md-4 col-lg-3 d-flex"><button class="btn sentiment-btn w-100" data-sentiment="inspiração"><span><i class="bi bi-lightbulb"></i> Inspiração</span></button></div>
<div class="col-6 col-md-4 col-lg-3 d-flex"><button class="btn sentiment-btn w-100" data-sentiment="autoestima"><span><i class="bi bi-emoji-smile"></i> Autoestima</span></button></div>
<div class="col-6 col-md-4 col-lg-3 d-flex"><button class="btn sentiment-btn w-100" data-sentiment="resiliência"><span><i class="bi bi-shield-check"></i> Resiliência</span></button></div>
<div class="col-6 col-md-4 col-lg-3 d-flex"><button class="btn sentiment-btn w-100" data-sentiment="equilibrio"><span><i class="bi bi-sliders"></i> Equilíbrio</span></button></div>
<div class="col-6 col-md-4 col-lg-3 d-flex"><button class="btn sentiment-btn w-100" data-sentiment="fé"><span><i class="bi bi-heart-fill"></i> Fé</span></button></div>
<div class="col-6 col-md-4 col-lg-3 d-flex"><button class="btn sentiment-btn w-100" data-sentiment="aceitação"><span><i class="bi bi-check-circle-fill"></i> Aceitação</span></button></div>
<div class="col-6 col-md-4 col-lg-3 d-flex"><button class="btn sentiment-btn w-100" data-sentiment="compaixão"><span><i class="bi bi-people-fill"></i> Compaixão</span></button></div>

<div class="col-6 col-md-4 col-lg-3 d-flex"><button class="btn sentiment-btn w-100" data-sentiment="autocuidado"><span><i class="bi bi-activity"></i> Autocuidado</span></button></div>
<div class="col-6 col-md-4 col-lg-3 d-flex"><button class="btn sentiment-btn w-100" data-sentiment="reflexão"><span><i class="bi bi-journal"></i> Reflexão</span></button></div>
<div class="col-6 col-md-4 col-lg-3 d-flex"><button class="btn sentiment-btn w-100" data-sentiment="perdão"><span><i class="bi bi-unlock"></i> Perdão</span></button></div>
<div class="col-6 col-md-4 col-lg-3 d-flex"><button class="btn sentiment-btn w-100" data-sentiment="aceitação"><span><i class="bi bi-check-lg"></i> Aceitação</span></button></div>
<div class="col-6 col-md-4 col-lg-3 d-flex"><button class="btn sentiment-btn w-100" data-sentiment="espiritualidade"><span><i class="bi bi-cloud-sun"></i> Espiritualidade</span></button></div>
<div class="col-6 col-md-4 col-lg-3 d-flex"><button class="btn sentiment-btn w-100" data-sentiment="empatia"><span><i class="bi bi-hand-thumbs-up"></i> Empatia</span></button></div>
<div class="col-6 col-md-4 col-lg-3 d-flex"><button class="btn sentiment-btn w-100" data-sentiment="presença"><span><i class="bi bi-geo-alt-fill"></i> Presença</span></button></div>
<div class="col-6 col-md-4 col-lg-3 d-flex"><button class="btn sentiment-btn w-100" data-sentiment="aceitação-corporal"><span><i class="bi bi-body-text"></i> Aceitação Corporal</span></button></div>
<div class="col-6 col-md-4 col-lg-3 d-flex"><button class="btn sentiment-btn w-100" data-sentiment="gentileza"><span><i class="bi bi-emoji-heart-eyes"></i> Gentileza</span></button></div>
<div class="col-6 col-md-4 col-lg-3 d-flex"><button class="btn sentiment-btn w-100" data-sentiment="clareza-mental"><span><i class="bi bi-eye"></i> Clareza Mental</span></button></div>

<div class="col-6 col-md-4 col-lg-3 d-flex"><button class="btn sentiment-btn w-100" data-sentiment="organização"><span><i class="bi bi-calendar-week"></i> Organização</span></button></div>
<div class="col-6 col-md-4 col-lg-3 d-flex"><button class="btn sentiment-btn w-100" data-sentiment="produtividade"><span><i class="bi bi-graph-up-arrow"></i> Produtividade</span></button></div>
<div class="col-6 col-md-4 col-lg-3 d-flex"><button class="btn sentiment-btn w-100" data-sentiment="superação"><span><i class="bi bi-trophy-fill"></i> Superação</span></button></div>
<div class="col-6 col-md-4 col-lg-3 d-flex"><button class="btn sentiment-btn w-100" data-sentiment="motivacional"><span><i class="bi bi-megaphone-fill"></i> Motivacional</span></button></div>
<div class="col-6 col-md-4 col-lg-3 d-flex"><button class="btn sentiment-btn w-100" data-sentiment="desapego"><span><i class="bi bi-scissors"></i> Desapego</span></button></div>
<div class="col-6 col-md-4 col-lg-3 d-flex"><button class="btn sentiment-btn w-100" data-sentiment="cura"><span><i class="bi bi-heart-pulse-fill"></i> Cura</span></button></div>
<div class="col-6 col-md-4 col-lg-3 d-flex"><button class="btn sentiment-btn w-100" data-sentiment="conexão"><span><i class="bi bi-link-45deg"></i> Conexão</span></button></div>
<div class="col-6 col-md-4 col-lg-3 d-flex"><button class="btn sentiment-btn w-100" data-sentiment="luz-interior"><span><i class="bi bi-sun"></i> Luz Interior</span></button></div>
<div class="col-6 col-md-4 col-lg-3 d-flex"><button class="btn sentiment-btn w-100" data-sentiment="força"><span><i class="bi bi-bar-chart-fill"></i> Força</span></button></div>
<div class="col-6 col-md-4 col-lg-3 d-flex"><button class="btn sentiment-btn w-100" data-sentiment="sabedoria"><span><i class="bi bi-journal-richtext"></i> Sabedoria</span></button></div>
    <div class="col-6 col-md-4 col-lg-3 d-flex"><button class="btn sentiment-btn w-100" data-sentiment="disciplina"><span><i class="bi bi-brightness-alt-high"></i>Disciplina</span></button></div>
        
                 <div class="col-6 col-md-4 col-lg-3 d-flex"><button class="btn sentiment-btn w-100" data-sentiment="alegria"><span><i class="bi bi-brightness-alt-high"></i> Alegria</span></button></div>
            </div>

         
            <div id="topicsContainer" class="w-100">
                 <h3 class="text-center">Ou explore estes tópicos:</h3>
                 <div id="topicButtonsContainer" class="row g-3 justify-content-center sentiment-buttons-row">
                   
                 </div>
            </div>
        </div>

        <!-- Plan Screen -->
        <div id="planScreen" class="d-none">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0">Seu Plano para - <span id="planTitle"></span></h2>
                <button class="btn btn-outline-primary" id="backToHomeBtn"><i class="bi bi-arrow-left me-1"></i> Voltar</button>
            </div>
            <div id="loadingIndicator" style="display: none;">
                <div class="spinner-border" role="status"><span class="visually-hidden">Gerando...</span></div>
                <p class="mt-2">Gerando seu plano...</p>
            </div>
            <div id="planContainer"></div>
        </div>

        <!-- History Screen -->
        <div id="historyScreen" class="d-none">
            <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 gap-2">
                <h2 class="mb-0"><i class="bi bi-clock-history me-2"></i>Histórico</h2>
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-danger" id="clearHistoryBtn"><i class="bi bi-trash me-1"></i> Limpar Histórico</button>
                    <button class="btn btn-sm btn-outline-primary" id="backToHomeHistoryBtn"><i class="bi bi-arrow-left me-1"></i> Voltar</button>
                </div>
            </div>
            <div id="historyList" class="list-group"></div>
            <p id="historyEmptyMessage" class="text-center text-muted mt-3 d-none">Nenhum plano no histórico.</p>
        </div>

        <!-- Favorites Screen -->
        <div id="favoritesScreen" class="d-none">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0"><i class="bi bi-heart-fill me-2"></i>Favoritos</h2>
                <button class="btn btn-outline-primary" id="backToHomeFavoritesBtn"><i class="bi bi-arrow-left me-1"></i> Voltar</button>
            </div>
            <div id="favoritesList" class="list-group"></div>
            <p id="favoritesEmptyMessage" class="text-center text-muted mt-3 d-none">Nenhuma atividade favoritada ainda.</p>
        </div>

        <!-- Settings Screen -->
        <div id="settingsScreen" class="d-none">
            <div class="d-flex justify-content-between align-items-center mb-4">
                 <h2 class="mb-0"><i class="bi bi-gear-fill me-2"></i>Configurações</h2>
                <button class="btn btn-outline-primary" id="backToAppBtn"><i class="bi bi-arrow-left me-1"></i> Voltar</button>
            </div>
            <div class="settings-card p-4">
                <div class="mb-3">
                    <label for="apiKeyInput" class="form-label">Chave API Gemini</label>
                    <input type="password" class="form-control" id="apiKeyInput" placeholder="Cole sua chave API Google Gemini">
                    <div class="form-text">Sua chave API é salva apenas localmente no seu navegador.</div>
                </div>
                <button class="btn btn-primary" id="saveApiKeyBtn"><i class="bi bi-save me-1"></i> Salvar Chave</button>
            </div>
        </div>
    </div><!-- End #app -->

    <!-- Share Modal -->
    <div class="modal fade" id="shareModal" tabindex="-1" aria-labelledby="shareModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="shareModalLabel">Compartilhar Atividade</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <p id="shareModalText" class="mb-4"></p>
                    <div>
                        <a href="#" id="shareWhatsapp" target="_blank" title="WhatsApp"><i class="bi bi-whatsapp"></i></a>
                        <a href="#" id="shareTwitter" target="_blank" title="Twitter / X"><i class="bi bi-twitter-x"></i></a>
                        <a href="#" id="shareFacebook" target="_blank" title="Facebook"><i class="bi bi-facebook"></i></a>
                        <a href="#" id="shareEmail" target="_blank" title="Email"><i class="bi bi-envelope-fill"></i></a>
                        <a href="#" id="shareTelegram" target="_blank" title="Telegram"><i class="bi bi-telegram"></i></a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Main Application Script -->
    <script>
        // Wrap all JS in a try...catch for global error handling
        try {
            console.log("Script loaded");

            // --- Constants ---
            const API_ENDPOINT_BASE = 'https://generativelanguage.googleapis.com/v1beta/models/';
            const MODEL_NAME = 'gemini-1.5-flash-latest';
            const DEFAULT_API_KEY = ''; // Set your default key here if desired, but settings are preferred
            const DB_NAME = 'TherapyPlannerDB';
            const DB_VERSION = 3; // Ensure this matches the latest required version
            const PLAN_STORE = 'plans';
            const SETTINGS_STORE = 'settings';
            const FAVORITES_STORE = 'favorites';

            // --- State Variables ---
            let currentScreen = 'home';
            let currentInput = null; // Holds the last generated sentiment or topic
            let favorites = []; // In-memory cache of favorites
            let db = null; // Database connection object
            let shareModalInstance = null; // Bootstrap Modal instance

            // --- DOM Element References ---
            const bodyElement = document.body;
            const bgVideo = document.getElementById('bgVideo');
            const homeScreen = document.getElementById('homeScreen');
            const planScreen = document.getElementById('planScreen');
            const historyScreen = document.getElementById('historyScreen');
            const favoritesScreen = document.getElementById('favoritesScreen');
            const settingsScreen = document.getElementById('settingsScreen');
            const planTitle = document.getElementById('planTitle');
            const planContainer = document.getElementById('planContainer');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const sentimentInput = document.getElementById('sentimentInput');
            const apiKeyInput = document.getElementById('apiKeyInput');
            const historyList = document.getElementById('historyList');
            const historyEmptyMessage = document.getElementById('historyEmptyMessage');
            const clearHistoryBtn = document.getElementById('clearHistoryBtn');
            const favoritesList = document.getElementById('favoritesList');
            const favoritesEmptyMessage = document.getElementById('favoritesEmptyMessage');
            const shareModalElement = document.getElementById('shareModal');
            const shareModalTextElement = document.getElementById('shareModalText');
            const shareWhatsapp = document.getElementById('shareWhatsapp');
            const shareTwitter = document.getElementById('shareTwitter');
            const shareFacebook = document.getElementById('shareFacebook');
            const shareEmail = document.getElementById('shareEmail');
            const shareTelegram = document.getElementById('shareTelegram');
            const topicButtonsContainer = document.getElementById('topicButtonsContainer');

            // --- Utility Functions ---

            /**
             * Sanitizes a string to prevent XSS by converting it to text content.
             * @param {string|null|undefined} str The string to sanitize.
             * @returns {string} The sanitized string.
             */
            const sanitize = (str) => {
                const temp = document.createElement('div');
                temp.textContent = String(str ?? ''); // Handle null/undefined
                return temp.innerHTML;
            };

            /**
             * Formats a day key (e.g., 'dia1') into a displayable name ('Dia 1').
             * @param {string} dayKey The day key string.
             * @returns {string} The formatted day name.
             */
            function formatDay(dayKey) {
                const daysMap = { 'dia1':'Dia 1', 'dia2':'Dia 2', 'dia3':'Dia 3', 'dia4':'Dia 4', 'dia5':'Dia 5', 'dia6':'Dia 6', 'dia7':'Dia 7' };
                return daysMap[dayKey] || dayKey.replace('dia', 'Dia ');
            }

            // --- IndexedDB Setup and Helpers ---

            /** Opens the IndexedDB database */
            function openDatabase() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(DB_NAME, DB_VERSION);

                    request.onupgradeneeded = function(event) {
                        db = event.target.result;
                        console.log(`Upgrading DB from ${event.oldVersion} to ${DB_VERSION}`);
                        if (!db.objectStoreNames.contains(PLAN_STORE)) {
                            db.createObjectStore(PLAN_STORE, { keyPath: 'sentiment' }); // Key is the sentiment/topic
                        }
                        if (!db.objectStoreNames.contains(SETTINGS_STORE)) {
                            db.createObjectStore(SETTINGS_STORE, { keyPath: 'id' });
                        }
                        if (!db.objectStoreNames.contains(FAVORITES_STORE)) {
                            db.createObjectStore(FAVORITES_STORE, { keyPath: 'id', autoIncrement: true });
                            console.log("Favorites store created.");
                        }
                    };

                    request.onsuccess = function(event) {
                        db = event.target.result;
                        console.log('DB opened successfully.');
                        resolve(db);
                    };

                    request.onerror = function(event) {
                        console.error('DB open error:', event.target.error);
                        reject(event.target.error);
                    };
                });
            }

            /** Generic function to save data to a store */
            function saveData(storeName, data) {
                if (!db) return Promise.reject('DB not initialized');
                return new Promise((res, rej) => {
                    try {
                        const transaction = db.transaction(storeName, 'readwrite');
                        const store = transaction.objectStore(storeName);
                        const request = store.put(data);
                        request.onsuccess = () => res(request.result);
                        request.onerror = (e) => rej(e.target.error);
                        transaction.onerror = (e) => rej(e.target.error);
                    } catch (e) { rej(e); }
                });
            }

            /** Generic function to get data by key */
            function getData(storeName, key) {
                if (!db) return Promise.resolve(null); // Resolve with null if DB not ready
                return new Promise((res, rej) => {
                    try {
                        const transaction = db.transaction(storeName, 'readonly');
                        const store = transaction.objectStore(storeName);
                        const request = store.get(key);
                        request.onsuccess = () => res(request.result || null);
                        request.onerror = (e) => rej(e.target.error);
                    } catch (e) { rej(e); }
                });
            }

            /** Generic function to get all data from a store */
            function getAllData(storeName) {
                if (!db) return Promise.resolve([]); // Resolve with empty array if DB not ready
                return new Promise((res, rej) => {
                   try {
                        const transaction = db.transaction(storeName, 'readonly');
                        const store = transaction.objectStore(storeName);
                        const request = store.getAll();
                        request.onsuccess = () => res(request.result || []);
                        request.onerror = (e) => rej(e.target.error);
                   } catch (e) { rej(e); }
                });
            }

            /** Generic function to delete data by key */
            function deleteData(storeName, key) {
                if (!db) return Promise.reject('DB not initialized');
                return new Promise((res, rej) => {
                   try {
                        const transaction = db.transaction(storeName, 'readwrite');
                        const store = transaction.objectStore(storeName);
                        const request = store.delete(key);
                        request.onsuccess = () => res();
                        request.onerror = (e) => rej(e.target.error);
                        transaction.onerror = (e) => rej(e.target.error);
                    } catch (e) { rej(e); }
                });
            }

            /** Generic function to clear all data from a store */
            function clearStore(storeName) {
                if (!db) return Promise.reject('DB not initialized');
                return new Promise((res, rej) => {
                    try {
                        const transaction = db.transaction(storeName, 'readwrite');
                        const store = transaction.objectStore(storeName);
                        const request = store.clear();
                        request.onsuccess = () => { console.log(`Store cleared: ${storeName}`); res(); };
                        request.onerror = (e) => { console.error(`Clear Error: ${storeName}`, e.target.error); rej(e.target.error); };
                        transaction.onerror = (e) => { console.error(`Clear Tx Error: ${storeName}`, e.target.error); };
                    } catch (e) { rej(e); }
                });
            }

            // --- API Key Management ---
            async function loadApiKeyFromDB() {
                try {
                    const setting = await getData(SETTINGS_STORE, 'apiKey');
                    apiKeyInput.value = setting?.value || DEFAULT_API_KEY;
                    console.log(setting?.value ? 'API Key loaded.' : 'No API Key found.');
                } catch (error) {
                    console.error("Failed to load API key:", error);
                    apiKeyInput.value = DEFAULT_API_KEY; // Fallback
                }
            }

            async function saveApiKey() {
                const apiKey = apiKeyInput.value.trim();
                try {
                    if (apiKey) {
                        await saveData(SETTINGS_STORE, { id: 'apiKey', value: apiKey });
                        alert('Chave API salva com sucesso localmente!');
                    } else {
                        // Attempt to delete only if key exists (or ignore error)
                        await deleteData(SETTINGS_STORE, 'apiKey').catch(err => {
                            if (err.name !== 'NotFoundError') throw err; // Re-throw other errors
                        });
                         alert('Chave API removida.');
                    }
                } catch (error) {
                    console.error("Failed to save/delete API key:", error);
                    alert(`Erro ao salvar a chave API: ${error.message}`);
                }
            }

            // --- Navigation / Screen Management ---
            function showScreen(screenId) {
                ['homeScreen', 'planScreen', 'historyScreen', 'favoritesScreen', 'settingsScreen'].forEach(id => {
                    document.getElementById(id)?.classList.add('d-none');
                });
                loadingIndicator.style.display = 'none';
                const screenElement = document.getElementById(screenId);
                if (screenElement) {
                    screenElement.classList.remove('d-none');
                } else {
                    console.error(`Screen element missing: ${screenId}. Falling back to home.`);
                    document.getElementById('homeScreen')?.classList.remove('d-none');
                    screenId = 'homeScreen'; // Update state
                }
                currentScreen = screenId;
                bodyElement.classList.toggle('video-background-active', screenId === 'homeScreen');
                window.scrollTo(0, 0);
            }

            function backToHome() {
                showScreen('homeScreen');
                currentInput = null; // Reset last input
                sentimentInput.value = '';
            }

            // --- Plan Generation Logic ---
            async function generatePlan(input) {
                const trimmedInput = input?.trim();
                if (!trimmedInput) {
                    alert('Por favor, insira ou selecione um sentimento/tópico válido.');
                    return;
                }
                currentInput = trimmedInput.toLowerCase(); // Store the input used for generation

                const apiKey = apiKeyInput.value.trim();
                if (!apiKey) {
                    alert('Por favor, insira sua chave API do Google Gemini nas Configurações.');
                    showScreen('settingsScreen');
                    return;
                }

                console.log(`Gerando plano para: ${currentInput}`);
                showScreen('planScreen');
                planTitle.textContent = currentInput.charAt(0).toUpperCase() + currentInput.slice(1); // Set title
                planContainer.innerHTML = ''; // Clear previous plan
                loadingIndicator.style.display = 'block'; // Show loading

                try {
                    console.log(`Iniciando API Fetch para: ${currentInput}`);
                    await fetchGeminiPlan(currentInput, apiKey);
                } catch (error) {
                    console.error(`Erro ao gerar plano para "${currentInput}":`, error);
                    // Ensure error message is displayed if fetchGeminiPlan didn't already
                    if (!planContainer.querySelector('.alert-danger')) {
                         planContainer.innerHTML = `<div class="alert alert-danger">Ocorreu um erro: ${error.message || String(error)}</div>`;
                    }
                    loadingIndicator.style.display = 'none';
                }
            }

            function generateCustomPlan() {
                generatePlan(sentimentInput.value);
            }

            // --- Fetch Plan from Gemini API ---
            async function fetchGeminiPlan(sentimentOrTopic, apiKey) {
                const fullApiUrl = `${API_ENDPOINT_BASE}${MODEL_NAME}:generateContent?key=${apiKey}`;
                console.log(`Fetching plan from: ${API_ENDPOINT_BASE}${MODEL_NAME}:generateContent?key=...`);

                // Enhanced Prompt
                const promptTemplate = (input) => `Gere um plano terapêutico JSON de 7 dias focado em "${input}". Se "${input}" for uma emoção (como ansiedade, tristeza, alegria), adapte as atividades para essa emoção. Se for um tópico (como mindfulness, gratidão, sono), crie atividades relacionadas a esse tópico específico.
Estrutura JSON OBRIGATÓRIA:
{
  "disclaimer": "**Importante:** Esta é uma ferramenta gerada por IA e não substitui o aconselhamento médico ou psicológico profissional. Consulte um especialista para necessidades específicas.",
  "introduction": "(Texto introdutório de 1-2 frases, acolhedor e relevante para '${input}')",
  "dia1": { "atividades": [ { "titulo": "Atividade 1 Curta", "descricao": "(Descrição prática de 2-3 frases, 40-70 palavras)", "duracao": NUMERO_INTEIRO_MINUTOS, "intensidade": "leve/média/profunda", "categoria": "Ex: Mindfulness", "beneficio": "Ex: ${input}" }, {"titulo":"...", "descricao":"...", ...}, {"titulo":"...", "descricao":"...", ...} ] },
  "dia2": { "atividades": [ {...}, {...}, {...} ] }, "dia3": { ... }, "dia4": { ... }, "dia5": { ... }, "dia6": { ... }, "dia7": { ... },
  "closing": "(Mensagem final de 1-2 frases, encorajadora ou de reflexão)"
}
REGRAS E DIRETRIZES:
- **Gere EXATAMENTE 3 atividades distintas para CADA dia.**
- **Inspire-se nestes tipos de tópicos:** técnicas de respiração, meditação, mindfulness, journaling, exercícios físicos leves, alimentação, sono, organização, metas, gratidão, autoconhecimento, expressão criativa, conexão social, limites, comunicação não-violenta.
- Varie os tipos de atividades e categorias.
- Mantenha descrições concisas, práticas e empáticas.
- 'duracao' DEVE ser um número inteiro (minutos).
- 'intensidade' DEVE ser 'leve', 'média', ou 'profunda'.
- Adapte o tom e conteúdo ao input "${input}".
- **A SAÍDA DEVE SER APENAS O JSON VÁLIDO.**`;
                const prompt = promptTemplate(sentimentOrTopic);

                try {
                    const response = await fetch(fullApiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });

                    if (!response.ok) {
                        const errorText = await response.text(); let errorMsg = `Erro na API (${response.status} ${response.statusText}).`; try { const eJson=JSON.parse(errorText); errorMsg+=` Detalhes: ${eJson.error?.message||errorText}`;} catch{errorMsg+=` Resposta: ${errorText}`;}
                        if (response.status === 503) { errorMsg = "Serviço temporariamente indisponível (Erro 503). Tente mais tarde."; }
                        // Add other specific status code checks if needed
                        throw new Error(errorMsg);
                    }

                    const data = await response.json(); console.log('API Response Data:', data);

                    if (data.candidates?.[0]?.content?.parts?.[0]?.text) {
                        let rawPlanText = data.candidates[0].content.parts[0].text; console.log('Raw API Text (first 500 chars):', rawPlanText.substring(0, 500) + '...');
                        let jsonString = rawPlanText.replace(/^```json\s*|\s*```$/g, '').trim();
                        const firstBrace = jsonString.indexOf('{'); const lastBrace = jsonString.lastIndexOf('}');
                        if (firstBrace === -1 || lastBrace < firstBrace) { throw new Error('JSON não encontrado na resposta.'); }
                        jsonString = jsonString.substring(firstBrace, lastBrace + 1);
                        let planJson; try { planJson = JSON.parse(jsonString); } catch (parseError) { try { jsonString = jsonString.replace(/,\s*([}\]])/g, '$1'); planJson = JSON.parse(jsonString); } catch (retryParseError) { throw new Error(`JSON inválido: ${parseError.message}.`); } }
                        if (!planJson || typeof planJson !== 'object' || !planJson.dia1?.atividades || !Array.isArray(planJson.dia1.atividades)) { throw new Error('Estrutura JSON do plano inválida.'); }

                        // Save to History using the input sentiment/topic as the key
                        const planDataToSave = { sentiment: sentimentOrTopic.toLowerCase(), planData: planJson, timestamp: Date.now() };
                        try { await saveData(PLAN_STORE, planDataToSave); console.log(`Plano '${sentimentOrTopic}' salvo no histórico.`); }
                        catch (dbError) { console.error(`Falha ao salvar histórico '${sentimentOrTopic}':`, dbError); /* Log error but continue */ }

                        // Display the plan, passing the identifier for unique IDs
                        displayPlan(planJson, sentimentOrTopic.toLowerCase());

                    } else { // Handle cases where API returns success but no content or is blocked
                        console.error('Resposta da API OK, mas sem conteúdo esperado:', data);
                        const safetyFeedback = data.candidates?.[0]?.safetyRatings;
                        if (safetyFeedback?.some(r => r.blocked)) { throw new Error('Geração bloqueada por políticas de segurança. Tente um termo diferente.'); }
                        throw new Error('Resposta da API não contém o texto do plano.');
                    }
                } catch (error) {
                    console.error('Falha na chamada fetchGeminiPlan:', error);
                    // Display error in the UI
                    planContainer.innerHTML = `<div class="alert alert-danger">Falha ao buscar/processar plano.<br><small>${sanitize(error.message || String(error))}</small></div>`;
                    loadingIndicator.style.display = 'none';
                    throw error; // Re-throw so generatePlan can catch it if needed
                }
            }

            // --- Display Plan ---
             function displayPlan(plan, planIdentifier) {
                if (!planContainer) { console.error("Plan container missing!"); return; }
                planContainer.innerHTML = ''; // Clear previous

                if (!plan || typeof plan !== 'object') {
                    planContainer.innerHTML = `<div class="alert alert-warning">Dados do plano inválidos.</div>`;
                    loadingIndicator.style.display = 'none'; return;
                }

                // Append Disclaimer, Intro, Closing only if they exist and elements are created
                if (plan.disclaimer) { const el=document.createElement('div'); el.className='disclaimer'; el.textContent=plan.disclaimer.replace(/\*\*/g,''); planContainer.appendChild(el); }
                if (plan.introduction) { const el=document.createElement('p'); el.className='plan-introduction'; el.textContent=plan.introduction; planContainer.appendChild(el); }

                const daysOrder = ['dia1','dia2','dia3','dia4','dia5','dia6','dia7'];
                daysOrder.forEach((dayKey) => {
                    const dayData = plan[dayKey];
                    if (dayData && Array.isArray(dayData.atividades) && dayData.atividades.length > 0) {
                        const dayCard = document.createElement('div'); dayCard.className = 'plan-card';
                        const dayHeader = document.createElement('div'); dayHeader.className = 'day-header'; dayHeader.innerHTML = `<span class="day-number">${sanitize(formatDay(dayKey))}</span>`; dayCard.appendChild(dayHeader);

                        dayData.atividades.forEach((activity, activityIndex) => {
                            if (!activity || !activity.titulo || !activity.descricao) { return; } // Skip invalid
                            const activityItem = document.createElement('div'); activityItem.className = 'activity-item';
                            const activityUniqueId = `${planIdentifier}-${dayKey}-activity-${activityIndex}`; // Use identifier
                            activityItem.dataset.activityId = activityUniqueId;
                            activityItem.dataset.activityText = `${activity.titulo}. ${activity.descricao}`;
                            activityItem.dataset.activityTitle = activity.titulo;
                            const intensityClassMap = { 'leve':'intensity-leve', 'média':'intensity-média', 'media':'intensity-média', 'profunda':'intensity-profunda' };
                            const normInt = activity.intensidade?.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "") || 'leve';
                            const intClass = intensityClassMap[normInt] || 'bg-secondary';
                            activityItem.innerHTML = `
                                <h5>${sanitize(activity.titulo)}</h5>
                                <p>${sanitize(activity.descricao)}</p>
                                <div class="activity-details">
                                    <span class="badge badge-category"><i class="bi bi-bookmark-fill me-1"></i> ${sanitize(activity.categoria||'N/A')}</span>
                                    <span class="badge badge-duration"><i class="bi bi-clock-fill me-1"></i> ${sanitize(activity.duracao||'N/A')} min</span>
                                    <span class="badge badge-benefit"><i class="bi bi-emoji-smile-fill me-1"></i> ${sanitize(activity.beneficio||'N/A')}</span>
                                    <span class="badge intensity-badge ${intClass} ms-auto"><i class="bi bi-bar-chart-line-fill me-1"></i> ${sanitize(activity.intensidade?.charAt(0).toUpperCase()+activity.intensidade?.slice(1)||'N/A')}</span>
                                </div>
                                <div class="activity-actions">
                                    <button class="action-btn copy-btn" title="Copiar"><i class="bi bi-clipboard"></i></button>
                                    <button class="action-btn speak-btn" title="Ouvir"><i class="bi bi-volume-up"></i></button>
                                    <button class="action-btn favorite-btn" title="Favoritar"><i class="bi bi-heart"></i></button>
                                    <button class="action-btn share-btn" title="Compartilhar"><i class="bi bi-share"></i></button>
                                </div>`;
                            updateFavoriteButtonState(activityItem.querySelector('.favorite-btn'), activityUniqueId);
                            dayCard.appendChild(activityItem);
                        });
                        planContainer.appendChild(dayCard); // Append day card after activities are added
                    } else {
                        console.warn(`Dados dia '${dayKey}' ausentes/inválidos.`);
                    }
                });

                if (plan.closing) { const el=document.createElement('p'); el.className='plan-closing'; el.textContent=plan.closing; planContainer.appendChild(el); }

                loadingIndicator.style.display = 'none'; // Hide loading indicator
            }


            // --- Action Button Handlers ---
            async function handleCopyClick(button) {
                const activityItem = button.closest('.activity-item');
                const textToCopy = activityItem?.dataset.activityText;
                if (!textToCopy) { alert('Texto não encontrado para copiar.'); return; }
                if (!navigator.clipboard) { alert('Seu navegador não suporta copiar para a área de transferência.'); return; }
                try {
                    await navigator.clipboard.writeText(textToCopy);
                    button.innerHTML = '<i class="bi bi-check-lg"></i>'; // Feedback
                    setTimeout(() => { button.innerHTML = '<i class="bi bi-clipboard"></i>'; }, 1500);
                } catch (err) {
                    console.error('Falha ao copiar:', err); alert('Não foi possível copiar o texto.');
                }
            }

            function handleSpeakClick(button) {
                if (!('speechSynthesis' in window)) { alert('Seu navegador não suporta leitura de texto.'); return; }
                const activityItem = button.closest('.activity-item');
                const textToSpeak = activityItem?.dataset.activityText;
                if (!textToSpeak) { alert('Texto não encontrado para ler.'); return; }

                window.speechSynthesis.cancel(); // Stop previous speech
                const utterance = new SpeechSynthesisUtterance(textToSpeak);
                utterance.lang = 'pt-BR'; utterance.rate = 1.0; utterance.pitch = 1.0;
                const originalIcon = button.innerHTML; // Store original icon
                button.innerHTML = '<i class="bi bi-pause-fill"></i>'; // Show speaking state
                utterance.onend = () => { button.innerHTML = originalIcon; }; // Revert on end
                utterance.onerror = (event) => { console.error('TTS Error:', event.error); button.innerHTML = '<i class="bi bi-volume-mute"></i>'; setTimeout(() => { button.innerHTML = originalIcon; }, 2000); alert(`Erro TTS: ${event.error}`); };
                window.speechSynthesis.speak(utterance);
            }

            // --- Favorite Functionality ---
            async function loadFavoritesFromDB() {
                try {
                    favorites = await getAllData(FAVORITES_STORE);
                    console.log(`Carregados ${favorites.length} favoritos.`);
                    // Refresh display if favorites screen is already visible
                    if (currentScreen === 'favoritesScreen') { showFavorites(); }
                } catch (error) {
                    console.error("Erro ao carregar favoritos:", error); favorites = [];
                }
            }

            function isFavorited(activityId) { return favorites.some(fav => fav.activityId === activityId); }

            function updateFavoriteButtonState(button, activityId) {
                 if (!button) return;
                 const favorited = isFavorited(activityId);
                 button.classList.toggle('favorited', favorited);
                 button.innerHTML = favorited ? '<i class="bi bi-heart-fill"></i>' : '<i class="bi bi-heart"></i>';
                 button.title = favorited ? "Remover Favorito" : "Adicionar Favorito";
            }

            async function handleFavoriteClick(button) {
                const activityItem = button.closest('.activity-item'); if (!activityItem) return;
                const activityId = activityItem.dataset.activityId;
                const activityTitle = activityItem.dataset.activityTitle;
                const activityText = activityItem.dataset.activityText;
                if (!activityId || !activityTitle || !activityText) { alert("Erro ao favoritar: dados incompletos."); return; }

                const existingFavorite = favorites.find(fav => fav.activityId === activityId);
                try {
                    if (existingFavorite) { // Remove
                        await deleteData(FAVORITES_STORE, existingFavorite.id);
                        favorites = favorites.filter(fav => fav.activityId !== activityId);
                        console.log(`Removido Fav: '${activityTitle}'`);
                    } else { // Add
                        const newFavorite = { activityId, title: activityTitle, text: activityText, addedAt: Date.now() };
                        const savedKey = await saveData(FAVORITES_STORE, newFavorite);
                        newFavorite.id = savedKey; // Add the returned auto-incremented ID
                        favorites.push(newFavorite);
                        console.log(`Adicionado Fav: '${activityTitle}' (ID:${savedKey})`);
                    }
                    updateFavoriteButtonState(button, activityId);
                    // Refresh favorites screen if it's currently displayed
                    if (currentScreen === 'favoritesScreen') { showFavorites(); }
                } catch (error) {
                    console.error("Erro ao salvar/remover favorito:", error); alert(`Erro nos favoritos: ${error.message}`);
                }
            }

            // --- Share Functionality ---
            function handleShareClick(button) {
                const activityItem = button.closest('.activity-item');
                const textToShare = activityItem?.dataset.activityText;
                const titleToShare = activityItem?.dataset.activityTitle || "Atividade Terapêutica";
                if (!textToShare) { alert('Texto não encontrado para compartilhar.'); return; }

                const encodedText = encodeURIComponent(textToShare); const encodedTitle = encodeURIComponent(titleToShare); const appUrl = encodeURIComponent(window.location.href);
                shareModalTextElement.textContent = `Compartilhar: "${titleToShare}"`;
                shareWhatsapp.href = `https://wa.me/?text=${encodedText}%0A%0AVia:%20${appUrl}`;
                shareTwitter.href = `https://twitter.com/intent/tweet?text=${encodedText}&url=${appUrl}`;
                shareFacebook.href = `https://www.facebook.com/sharer/sharer.php?u=${appUrl}"e=${encodedText}`;
                shareEmail.href = `mailto:?subject=${encodedTitle}&body=${encodedText}%0A%0AVia:%20${appUrl}`;
                shareTelegram.href = `https://t.me/share/url?url=${appUrl}&text=${encodedText}`;

                if (!shareModalInstance) {
                    if (typeof bootstrap !== 'undefined' && bootstrap.Modal) { shareModalInstance = new bootstrap.Modal(shareModalElement); }
                    else { console.error("Bootstrap Modal JS não carregado."); alert("Erro ao abrir compartilhamento."); return; }
                }
                shareModalInstance.show();
            }

            // --- Event Delegation for Activity Actions ---
            planContainer.addEventListener('click', function(event) {
                const button = event.target.closest('.action-btn'); if (!button) return;
                if (button.classList.contains('copy-btn')) { handleCopyClick(button); }
                else if (button.classList.contains('speak-btn')) { handleSpeakClick(button); }
                else if (button.classList.contains('favorite-btn')) { handleFavoriteClick(button); }
                else if (button.classList.contains('share-btn')) { handleShareClick(button); }
            });

            // --- History Screen ---
            async function showHistory() {
                showScreen('historyScreen'); historyList.innerHTML = ''; historyEmptyMessage.classList.add('d-none');
                try {
                    const allPlans = await getAllData(PLAN_STORE);
                    if (allPlans.length === 0) { historyEmptyMessage.classList.remove('d-none'); return; }
                    allPlans.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0)); // Sort newest first
                    allPlans.forEach(item => {
                        if (!item || !item.sentiment || !item.planData || !item.timestamp) { return; } // Skip invalid items
                        const li = document.createElement('a'); li.href = '#'; li.className = 'list-group-item list-group-item-action flex-column align-items-start';
                        const date = new Date(item.timestamp);
                        li.innerHTML = `<div class="d-flex w-100 justify-content-between"><h5 class="mb-1">${sanitize(item.sentiment.charAt(0).toUpperCase() + item.sentiment.slice(1))}</h5><small>${date.toLocaleDateString('pt-BR')} ${date.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'})}</small></div><small class="text-muted">Clique para visualizar.</small>`;
                        li.onclick = (e) => { e.preventDefault(); currentInput = item.sentiment; showScreen('planScreen'); planTitle.textContent = item.sentiment.charAt(0).toUpperCase() + item.sentiment.slice(1); displayPlan(item.planData, item.sentiment); };
                        historyList.appendChild(li);
                    });
                } catch (error) { console.error("Erro ao carregar histórico:", error); historyList.innerHTML = '<li class="list-group-item text-danger">Erro ao carregar histórico.</li>'; }
            }

            // --- Clear History ---
            async function handleClearHistory() {
                 const confirmed = window.confirm("⚠️ ATENÇÃO! ⚠️\n\nTem certeza que deseja limpar TODO o histórico de planos gerados?\n\nEsta ação não pode ser desfeita (é irreversível).");
                 if (confirmed) {
                    console.log("Confirmado. Limpando histórico..."); loadingIndicator.style.display = 'block'; historyList.innerHTML = ''; historyEmptyMessage.classList.add('d-none');
                    try { await clearStore(PLAN_STORE); alert("Histórico limpo!"); showHistory(); } // Refresh view
                    catch (error) { console.error("Erro ao limpar histórico:", error); alert(`Erro ao limpar: ${error.message}`); showHistory(); } // Refresh anyway
                    finally { loadingIndicator.style.display = 'none'; }
                 } else { console.log("Limpeza cancelada."); }
            }

            // --- Favorites Screen ---
            async function showFavorites() {
                showScreen('favoritesScreen'); favoritesList.innerHTML = ''; favoritesEmptyMessage.classList.add('d-none');
                if (!Array.isArray(favorites) || favorites.length === 0) { await loadFavoritesFromDB(); } // Ensure loaded
                if (favorites.length === 0) { favoritesEmptyMessage.classList.remove('d-none'); return; }
                favorites.sort((a, b) => (b.addedAt || 0) - (a.addedAt || 0)); // Sort newest first
                favorites.forEach(fav => {
                    if (!fav || !fav.id || !fav.activityId || !fav.title || !fav.text) { return; } // Skip invalid
                    const li = document.createElement('div'); li.className = 'list-group-item list-group-item-action flex-column align-items-start mb-2 border rounded p-3';
                    const dateStr = fav.addedAt ? new Date(fav.addedAt).toLocaleDateString('pt-BR') : 'N/A';
                    let sent = '?', day = '?'; const parts = fav.activityId.split('-'); if (parts.length >= 2) { sent = parts[0].charAt(0).toUpperCase() + parts[0].slice(1); day = formatDay(parts[1]); }
                    li.innerHTML = `
                        <div class="d-flex w-100 justify-content-between"> <h5 class="mb-1">${sanitize(fav.title)}</h5> <small class="text-muted">${sanitize(dateStr)}</small> </div>
                        <p class="mb-1">${sanitize(fav.text)}</p>
                        <div class="d-flex justify-content-between align-items-center mt-2"> <small class="text-muted">Origem: ${sanitize(sent)} - ${sanitize(day)}</small> <button class="btn btn-sm btn-outline-danger remove-favorite-btn" data-favorite-db-id="${fav.id}" title="Remover Favorito"><i class="bi bi-trash"></i></button> </div>`;
                    // Add listener for remove button on this specific item
                    const removeBtn = li.querySelector('.remove-favorite-btn');
                    if (removeBtn) {
                        removeBtn.addEventListener('click', async (e) => {
                            e.stopPropagation(); const dbId = parseInt(removeBtn.dataset.favoriteDbId, 10);
                            if (!isNaN(dbId)) {
                                try {
                                    await deleteData(FAVORITES_STORE, dbId);
                                    favorites = favorites.filter(f => f.id !== dbId); // Update cache
                                    showFavorites(); // Re-render list
                                    console.log(`Removido Fav ID ${dbId}`);
                                    // Update button state on plan screen if visible
                                    const activityBtn = planContainer.querySelector(`.activity-item[data-activity-id="${fav.activityId}"] .favorite-btn`);
                                    if (activityBtn) { updateFavoriteButtonState(activityBtn, fav.activityId); }
                                } catch (error) { console.error(`Erro remover fav ID ${dbId}:`, error); alert("Erro ao remover."); }
                            }
                        });
                    }
                    favoritesList.appendChild(li);
                });
            }

           function renderTopicButtons() {
  const topics = [
    "Técnicas de respiração para ansiedade", "Meditação guiada para iniciantes", "Mindfulness para o dia a dia", "Como lidar com crises de pânico", "Técnicas de respiração para ansiedade",
    "Meditação guiada para iniciantes", "Mindfulness para o dia a dia", "Como lidar com crises de pânico", "Terapias alternativas (aromaterapia, cromoterapia)",
    "Benefícios da psicoterapia", "Aplicativos de meditação", "Como identificar gatilhos emocionais", "Exercícios de atenção plena", "Como manter o equilíbrio emocional",
    "Alimentos que ajudam no humor", "Rotina de sono saudável", "Alongamento para relaxamento", "Exercícios para liberar endorfina", "Yoga para aliviar estresse",
    "Suplementos naturais para ansiedade", "Importância da hidratação para o cérebro", "Caminhadas como terapia natural", "Dicas para dormir melhor",
    "Como reduzir o consumo de cafeína", "Visualizações de futuro positivo"
  ];

  const topicButtonsContainer = document.getElementById("topicButtonsContainer");
  if (!topicButtonsContainer) {
    console.error("Topic container missing!");
    return;
  }

  topicButtonsContainer.innerHTML = ''; // Clear first

  topics.forEach(topic => {
    const colDiv = document.createElement('div');
    colDiv.className = 'col-6 col-md-4 col-lg-3 d-flex justify-content-center p-2';

    const button = document.createElement('button');
    button.className = 'btn sentiment-btn w-100';
    button.dataset.topic = topic;
    button.innerHTML = `<span>${sanitize(topic)}</span>`;

    colDiv.appendChild(button);
    topicButtonsContainer.appendChild(colDiv);
  });
}


            // --- Initializing Event Listeners ---
            function initializeEventListeners() {
                // Video Loop
                if (bgVideo) {
                    bgVideo.addEventListener('ended', () => { bgVideo.currentTime = 0; bgVideo.play().catch(e => console.warn("Video restart fail:", e)); });
                    bgVideo.play().catch(e => console.warn("Video autoplay fail:", e)); // Initial play attempt
                }
                // Navbar/Screen Navigation
                document.getElementById('homeLink')?.addEventListener('click', (e) => { e.preventDefault(); backToHome(); });
                document.getElementById('settingsBtn')?.addEventListener('click', () => showScreen('settingsScreen'));
                document.getElementById('historyBtn')?.addEventListener('click', showHistory);
                document.getElementById('favoritesBtn')?.addEventListener('click', showFavorites);
                // Back Buttons
                document.getElementById('backToHomeBtn')?.addEventListener('click', backToHome);
                document.getElementById('backToHomeHistoryBtn')?.addEventListener('click', backToHome);
                document.getElementById('backToHomeFavoritesBtn')?.addEventListener('click', backToHome);
                document.getElementById('backToAppBtn')?.addEventListener('click', () => { showScreen(currentInput ? 'planScreen' : 'homeScreen'); });
                // Settings
                document.getElementById('saveApiKeyBtn')?.addEventListener('click', saveApiKey);
                // Search / Input
                document.getElementById('searchBtn')?.addEventListener('click', generateCustomPlan);
                sentimentInput?.addEventListener('keypress', (e) => { if (e.key === 'Enter') { e.preventDefault(); generateCustomPlan(); } });
                // Clear History
                clearHistoryBtn?.addEventListener('click', handleClearHistory);
                // Delegated Listener for Sentiment & Topic Buttons
                homeScreen.addEventListener('click', function(event) {
                    const button = event.target.closest('.sentiment-btn'); if (!button) return;
                    const sentiment = button.dataset.sentiment; const topic = button.dataset.topic;
                    if (sentiment) { console.log("Sentiment click:", sentiment); sentimentInput.value = sentiment; generatePlan(sentiment); }
                    else if (topic) { console.log("Topic click:", topic); sentimentInput.value = topic; generatePlan(topic); }
                });
                // Note: Activity action button listeners are added via delegation in displayPlan's scope
                // Note: Favorite remove button listeners are added in showFavorites's scope
            }

            // --- Application Initialization ---
            async function initializeApp() {
                try {
                    await openDatabase(); // Wait for DB connection first
                    console.log("Database ready.");
                    // Load initial data dependent on DB
                    await loadApiKeyFromDB();
                    await loadFavoritesFromDB();
                    // Setup UI
                    renderTopicButtons();
                    initializeEventListeners();
                    showScreen('homeScreen'); // Show initial screen
                    console.log('Application initialized successfully.');
                } catch (error) {
                     console.error('Failed to initialize database or app:', error);
                     alert(`Erro crítico na inicialização: ${error.message}. A aplicação pode não funcionar corretamente.`);
                     // Attempt to show home screen as fallback
                     showScreen('homeScreen');
                     renderTopicButtons(); // Still try to render buttons
                     initializeEventListeners(); // Still try to add listeners
                }
            }

            // Start the application initialization
            initializeApp();

        } catch (e) {
            // Catch synchronous errors during initial script execution
            console.error('Fatal script error during setup:', e);
            alert(`Erro Crítico: ${e.message}. Verifique o console.`);
            // Attempt basic UI display as fallback
             document.body.classList.add('video-background-active');
             document.getElementById('homeScreen')?.classList.remove('d-none');
        }
        // --- End of JS ---
    </script>

</body>
</html>
