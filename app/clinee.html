<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chat CLINEE Medicina Estética - Atendimento Direto</title>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400..700;1,400..700&family=Playfair+Display:ital,wght@0,400..900;1,400..900&display=swap" rel="stylesheet">
    <style>
        /* ESTILOS CSS (Mantidos) */
        * { margin: 0; padding: 0; box-sizing: border-box; } html { height: 100%; } body { min-height: 100%; display: flex; flex-direction: column; font-family: 'Lora', serif; background: linear-gradient(135deg, #F5E6E8, #D3A7B0); color: #54162B; line-height: 1.6; overflow-x: hidden; }
        .main-content { flex: 1; display: flex; justify-content: center; align-items: center; padding: 20px 15px; width: 100%; }
        .chat-container { width: 100%; max-width: 750px; background: #FFFFFF; border-radius: 15px; box-shadow: 0 10px 35px rgba(84, 22, 43, 0.2); display: flex; flex-direction: column; height: 85vh; max-height: 700px; overflow: hidden; border: 1px solid #D3A7B0; }
        .chat-header { padding: 18px 25px; background: #F5E6E8; border-bottom: 1px solid #D3A7B0; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .chat-header h1 { font-family: 'Playfair Display', serif; font-size: 1.6em; font-weight: 600; color: #54162B; margin: 0; }
        .chat-body { flex: 1; padding: 25px; overflow-y: auto; background: #FFFFFF; scroll-behavior: smooth; scrollbar-width: thin; scrollbar-color: #D3A7B0 #F5E6E8; }
        .chat-body::-webkit-scrollbar { width: 8px; } .chat-body::-webkit-scrollbar-track { background: #F5E6E8; border-radius: 10px; } .chat-body::-webkit-scrollbar-thumb { background-color: #D3A7B0; border-radius: 10px; border: 2px solid #F5E6E8; } .chat-body::-webkit-scrollbar-thumb:hover { background-color: #B4182D; }
        .message { margin-bottom: 18px; padding: 14px 20px; border-radius: 18px; max-width: 85%; line-height: 1.5; box-shadow: 0 3px 5px rgba(84, 22, 43, 0.08); word-wrap: break-word; clear: both; } .user-message { background: #D3A7B0; color: #FFFFFF; margin-left: auto; border-bottom-right-radius: 5px; float: right; } .bot-message { background: #F5E6E8; color: #54162B; margin-right: auto; border-bottom-left-radius: 5px; float: left; padding-bottom: 5px; } .bot-message.thinking { font-style: italic; opacity: 0.8; background: #e9dde0; padding-bottom: 14px; } .bot-message strong { color: #B4182D; font-weight: 600; } .bot-message a { color: #B4182D; text-decoration: none; font-weight: 600; border-bottom: 1px solid #d89eaa; transition: color 0.3s ease, border-bottom-color 0.3s ease; } .bot-message a:hover { color: #54162B; border-bottom-color: #54162B; } .bot-message ul { list-style-position: outside; padding-left: 25px; margin-top: 8px; margin-bottom: 5px; } .bot-message li { margin-bottom: 6px; } .sub-message { font-size: 0.9em; margin-top: 10px; padding: 8px 12px; background: rgba(211, 167, 176, 0.2); border-radius: 10px; display: inline-block; border: 1px solid rgba(211, 167, 176, 0.5); }
        .options-container { margin-top: 15px; padding-top: 10px; border-top: 1px dashed rgba(84, 22, 43, 0.1); display: flex; flex-direction: column; gap: 8px; } .option-button { display: block; width: 100%; padding: 10px 15px; background-color: #FFFFFF; color: #54162B; border: 1px solid #D3A7B0; border-radius: 8px; text-align: left; font-family: 'Lora', serif; font-size: 0.95em; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 4px rgba(84, 22, 43, 0.06); } .option-button:hover { background-color: #D3A7B0; color: #FFFFFF; border-color: #B4182D; transform: translateY(-1px); box-shadow: 0 4px 8px rgba(84, 22, 43, 0.1); } .option-button:disabled { background-color: #f0eaea; color: #a09396; border-color: #e0d0d4; cursor: not-allowed; box-shadow: none; transform: none; } .option-button .option-letter { font-weight: 700; margin-right: 8px; color: #B4182D; display: inline-block; min-width: 15px; } .option-button:hover .option-letter { color: #FFFFFF; } .option-button:disabled .option-letter { color: #a09396; }
        .chat-footer { padding: 15px 25px; background: #F5E6E8; display: flex; align-items: center; gap: 12px; border-top: 1px solid #D3A7B0; flex-shrink: 0; } .chat-input { flex: 1; padding: 14px 22px; border: 1px solid #D3A7B0; background: #FFFFFF; color: #54162B; border-radius: 25px; outline: none; font-size: 1.05em; font-family: 'Lora', serif; resize: none; transition: border-color 0.3s ease, box-shadow 0.3s ease; } .chat-input:focus { border-color: #B4182D; box-shadow: 0 0 0 3px rgba(180, 24, 45, 0.15); } .chat-input::placeholder { color: #b18c94; opacity: 0.9; } .send-button { width: 48px; height: 48px; border: none; background: #B4182D url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgZmlsbD0iI2ZmZiIgdmlld0JveD0iMCAwIDI0IDI0Ij48cGF0aCBkPSJNM i4wMSAyMSAyMyAxMiAyLjAxIDMgMiAxMGw١NSAyLTggMnpNMCAwaDI0djI0SDB6IiBmaWxsPSJub25lIi8+PHBhdGggZD0iTTIuMDEgM0wyMyAxMiAyLjAxIDIxIDIgMTBsMTUtMi0xNS0yeiIvPjwvc3ZnPg==') no-repeat center; background-size: 50%; border-radius: 50%; cursor: pointer; transition: background-color 0.3s ease, transform 0.2s ease; box-shadow: 0 4px 10px rgba(180, 24, 45, 0.2); flex-shrink: 0; } .send-button:hover { background-color: #54162B; transform: scale(1.05); } .send-button:active { transform: scale(0.95); }
        .page-footer { flex-shrink: 0; width: 100%; padding: 15px 20px; background-color: #F5E6E8; border-top: 1px solid #D3A7B0; text-align: center; margin-top: auto; } .social-icons { display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 10px; } .social-icons a { display: inline-flex; justify-content: center; align-items: center; width: 36px; height: 36px; background-color: rgba(211, 167, 176, 0.3); border-radius: 50%; transition: background-color 0.3s ease, transform 0.3s ease; border: 1px solid transparent; } .social-icons a svg { width: 18px; height: 18px; fill: #54162B; transition: fill 0.3s ease; } .social-icons a:hover { background-color: #D3A7B0; transform: translateY(-2px); border: 1px solid #B4182D; } .social-icons a:hover svg { fill: #FFFFFF; } .footer-text { font-size: 0.8em; color: #54162B; opacity: 0.8; } .footer-text a { color: #B4182D; text-decoration: none; font-weight: 600; } .footer-text a:hover { text-decoration: underline; }

        /* Responsividade */
        @media (max-width: 768px) { .main-content { padding: 10px; align-items: flex-start; padding-top: 10px; } .chat-container { height: calc(100vh - 90px); max-height: none; border-radius: 10px; } .chat-header h1 { font-size: 1.3em; } .chat-body { padding: 15px; } .message { max-width: 90%; padding: 10px 15px; margin-bottom: 15px;} .chat-footer { padding: 10px 15px; gap: 10px;} .chat-input { padding: 12px 18px; font-size: 1em; } .send-button { width: 42px; height: 42px; } .page-footer { padding: 12px 15px; } .social-icons { gap: 15px; margin-bottom: 8px; } .social-icons a { width: 32px; height: 32px; } .social-icons a svg { width: 16px; height: 16px; } .footer-text { font-size: 0.75em; } .option-button { padding: 8px 12px; font-size: 0.9em;} }
        @media (max-width: 480px) { .main-content { padding: 5px; padding-top: 5px; } .chat-container { height: calc(100vh - 75px); border-radius: 5px;} .chat-header h1 { font-size: 1.1em; } .chat-header { padding: 12px 15px;} .chat-body { padding: 10px; } .message { max-width: 95%; } .chat-footer { padding: 8px 10px; gap: 8px; } .chat-input { padding: 10px 15px; font-size: 0.95em; } .send-button { width: 38px; height: 38px; } .page-footer { padding: 10px; } .social-icons { gap: 12px; } .footer-text { font-size: 0.7em; } .option-button { font-size: 0.85em;} }
    </style>
</head>
<body>

    <div class="main-content">
        <div class="chat-container">
            <div class="chat-header"><h1>CLINEE Medicina Estética</h1></div>
            <div class="chat-body" id="chatBody">
                <div class="message bot-message thinking" style="display: none;">Processando sua solicitação... ✨</div>
            </div>
            <div class="chat-footer">
                <input type="text" class="chat-input" id="userInput" placeholder="Digite sua dúvida ou escolha uma opção..." aria-label="Campo de mensagem">
                <button class="send-button" onclick="sendMessage()" aria-label="Enviar mensagem"></button>
            </div>
        </div>
    </div>

    <footer class="page-footer">
        <div class="social-icons">
             <!-- Links Mantidos da CLINEE -->
             <a href="https://www.clinee.com.br/" target="_blank" aria-label="Instagram"> <svg viewBox="0 0 24 24"><path d="M7.8,2H16.2C19.4,2 22,4.6 22,7.8V16.2C22,19.4 19.4,22 16.2,22H7.8C4.6,22 2,19.4 2,16.2V7.8C2,4.6 4.6,2 7.8,2M7.6,4A3.6,3.6 0 0,0 4,7.6V16.4C4,18.39 5.61,20 7.6,20H16.4C18.39,20 20,18.39 20,16.4V7.6C20,5.61 18.39,4 16.4,4H7.6M17.25,5.5A1.25,1.25 0 0,1 18.5,6.75A1.25,1.25 0 0,1 17.25,8A1.25,1.25 0 0,1 16,6.75A1.25,1.25 0 0,1 17.25,5.5M12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9Z"/></svg> </a>
             <a href="https://www.clinee.com.br/" target="_blank" aria-label="Facebook"> <svg viewBox="0 0 24 24"><path d="M12 2.04C6.5 2.04 2 6.53 2 12.06C2 17.06 5.66 21.21 10.44 21.96V14.96H7.9V12.06H10.44V9.81C10.44 7.31 11.93 5.96 14.22 5.96C15.31 5.96 16.45 6.15 16.45 6.15V8.62H15.19C13.95 8.62 13.56 9.39 13.56 10.18V12.06H16.34L15.89 14.96H13.56V21.96A10.01 10.01 0 0 0 22 12.06C22 6.53 17.5 2.04 12 2.04Z"/></svg> </a>
             <a href="https://wa.me/5511955888451?text=Olá,%20gostaria%20de%20mais%20informações%20da%20Clínica%20Clinee%20Medicina%20Estética!" target="_blank" aria-label="WhatsApp"> <svg viewBox="0 0 24 24"><path d="M12.04 2C6.58 2 2.13 6.45 2.13 12C2.13 13.8 2.64 15.5 3.57 16.96L2 22L7.19 20.53C8.6 21.4 10.27 21.94 12.04 21.94C17.5 21.94 21.95 17.5 21.95 12C21.95 6.45 17.5 2 12.04 2M12.04 3.67C16.56 3.67 20.28 7.39 20.28 12C20.28 16.61 16.56 20.33 12.04 20.33C10.47 20.33 8.96 19.86 7.7 19.05L7.26 18.79L4.6 19.5L5.37 17L5.09 16.54C4.24 15.21 3.79 13.65 3.79 12C3.79 7.39 7.51 3.67 12.04 3.67M16.58 14.53C16.41 14.44 15.3 13.91 15.12 13.85C14.93 13.79 14.79 13.76 14.66 13.93C14.53 14.11 14.02 14.71 13.86 14.88C13.71 15.06 13.56 15.08 13.27 14.99C12.98 14.9 12.07 14.61 10.99 13.66C10.16 12.91 9.61 12.04 9.45 11.76C9.3 11.47 9.43 11.34 9.56 11.21C9.68 11.09 9.83 10.9 9.97 10.73C10.1 10.56 10.16 10.44 10.25 10.27C10.34 10.1 10.28 9.96 10.22 9.83C10.16 9.7 9.65 8.41 9.46 7.94C9.28 7.47 9.1 7.53 8.95 7.53C8.79 7.53 8.65 7.53 8.51 7.53C8.37 7.53 8.13 7.59 7.92 7.8C7.71 8.02 7.16 8.54 7.16 9.73C7.16 10.92 7.95 12.04 8.09 12.22C8.23 12.39 10.18 15.31 13.11 16.76C13.91 17.11 14.54 17.32 15.01 17.48C15.7 17.7 16.23 17.66 16.66 17.6C17.13 17.54 18.12 17 18.33 16.41C18.54 15.83 18.54 15.34 18.45 15.21C18.37 15.08 18.23 15.02 18.06 14.93C17.89 14.84 16.75 14.31 16.58 14.25" fill-rule="evenodd"/></svg> </a>
             <a href="https://www.clinee.com.br/" target="_blank" aria-label="Website Principal"> <svg viewBox="0 0 24 24"><path d="M10.59,13.41C11,13.8 11,14.44 10.59,14.83C10.2,15.22 9.56,15.22 9.17,14.83C7.22,12.88 7.22,9.71 9.17,7.76V7.76L12,10.59L14.83,7.76C15.22,7.37 15.86,7.37 16.25,7.76C16.64,8.15 16.64,8.79 16.25,9.18L13.41,12L16.25,14.83C16.64,15.22 16.64,15.86 16.25,16.25C15.86,16.64 15.22,16.64 14.83,16.25L12,13.41L9.17,16.25C8.78,16.64 8.14,16.64 7.75,16.25C7.36,15.86 7.36,15.22 7.75,14.83L10.59,12L7.75,9.17C7.36,8.78 7.36,8.14 7.75,7.75C8.14,7.36 8.78,7.36 9.17,7.75L12,10.59L14.83,7.75C15.22,7.36 15.86,7.36 16.25,7.75C16.64,8.14 16.64,8.78 16.25,9.17L13.41,12L16.25,14.83C16.64,15.22 16.64,15.86 16.25,16.25C15.86,16.64 15.22,16.64 14.83,16.25L12,13.41Z M19,3H5C3.89,3 3,3.9 3,5V19C3,20.1 3.9,21 5,21H19C20.1,21 21,20.1 21,19V5C21,3.9 20.1,3 19,3Z" /></svg> </a>
             <a href="https://www.google.com/search?sca_esv=882d27ba7320b5a9&sxsrf=AHTn8zp1cHpmdStFQ7T78lz6QV2-MfYeHA:1745801826650&si=APYL9bs7Hg2KMLB-4tSoTdxuOx8BdRvHbByC_AuVpNyh0x2KzY2-jSaVlFnO4Os7ZYm9m_HhZq6_xG0kdDlZARQ5dYbqxH5Ssek-iyObzU77IY2qLCXpyEBrD_YDODjPve7I_kYzjIr5S3EkS2CmzwQ4Aro1H6bzAg%3D%3D&q=Clin%C3%A9e+Medicina+Est%C3%A9tica+Coment%C3%A1rios&sa=X&ved=2ahUKEwj_9-bNwvmMAxWppZUCHfNIF30Q0bkNegQIIRAE&biw=1600&bih=692&dpr=1" target="_blank" aria-label="Avalie no Google"> <svg viewBox="0 0 24 24"><path d="M21.35 11.1H12.18V13.83H18.69C18.36 17.64 15.19 19.27 12.19 19.27C8.36 19.27 5.03 16.41 5.03 12.5C5.03 8.59 8.36 5.73 12.19 5.73C15.1 5.73 17.33 7.95 17.33 7.95L19.78 5.73C19.78 5.73 16.94 3 12.19 3C6.92 3 3.06 7.03 3.06 12.5C3.06 17.97 6.92 22 12.19 22C17.61 22 21.31 18.47 21.31 13.36C21.31 12.41 21.35 11.77 21.35 11.1Z"/></svg> </a>
        </div>
        <div class="footer-text">
            © 2025 Clinée Medicina Estética. Todos os direitos reservados. | <a href="https://www.clinee.com.br/" target="_blank">Sobre Clinée Medicina Estética</a>
        </div>
      <div class="footer-text">
            Feito Por Joao Ricardo - Engenheiro da Computação | <a href="https://instagram.com/joaoricardo.pe" target="_blank">Meu Instagram</a>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // --- CONFIGURAÇÕES ---
        const SUPABASE_URL = 'https://wrsjjnlpwwtrwekjhjcy.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indyc2pqbmxwd3d0cndla2poamN5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQ4MDY5MjcsImV4cCI6MjA2MDM4MjkyN30.5hjlREAHW6Zd-PKTB3eGuKSbJFHSW5s8OCGd_jr-f4o'; // ANON KEY
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const WHATSAPP_NUMBER = '5511955888451'; // Número CLINEE

        // --- ESTADO DA APLICAÇÃO ---
        let userData = { name: null, phone: null, protocol: null };
        let chatHistory = [];
        let isWaitingFor = 'name_phone';
        let currentProcedure = null;
        let isProcessing = false;

        // --- ELEMENTOS DO DOM ---
        const chatBody = document.getElementById('chatBody');
        const userInput = document.getElementById('userInput');
        const thinkingMessageDiv = chatBody.querySelector('.thinking');

        // --- DADOS DOS PROCEDIMENTOS (RESTAURADOS da versão Lorraine Botura) ---
        const procedureDetails = {
            'botox': { key: 'botox', name: 'Botox', description: '🌸 **Botox**<br>O Botox é aplicado para suavizar linhas de expressão e prevenir a formação de rugas. Atua relaxando a musculatura local de forma segura e controlada.', details: '<strong>Resultados esperados:</strong> aparência mais jovem e descansada, sem alterar sua expressão natural.' },
            'labial': { key: 'labial', name: 'Preenchimento Labial', description: '🌸 **Preenchimento Labial**<br>O preenchimento labial é feito com ácido hialurônico para dar mais volume, definir o contorno e hidratar os lábios. O procedimento é rápido, com resultados imediatos e naturais.', details: '<strong>Resultados esperados:</strong> lábios mais volumosos, definidos e hidratados.' },
            'micro': { key: 'micro', name: 'Microagulhamento', description: '🌸 **Microagulhamento**<br>O microagulhamento utiliza pequenas agulhas para estimular o colágeno e renovar a pele. É ideal para melhorar cicatrizes, linhas finas, manchas e textura da pele.', details: '<strong>Resultados esperados:</strong> pele mais uniforme, firme e rejuvenescida.' },
            'limpeza': { key: 'limpeza', name: 'Limpeza de Pele Profunda', description: '🌸 **Limpeza de Pele Profunda**<br>A limpeza de pele profunda remove cravos, impurezas e células mortas, promovendo a renovação celular e preparando a pele para absorver melhor os ativos hidratantes.', details: '<strong>Resultados esperados:</strong> pele mais limpa, fresca e revitalizada.' },
            'laser': { key: 'laser', name: 'Depilação a Laser', description: '🌸 **Depilação a Laser**<br>A depilação a laser elimina os pelos de forma progressiva e duradoura, atuando diretamente na raiz dos pelos com tecnologia de ponta e conforto.', details: '<strong>Resultados esperados:</strong> pele lisa, livre de pelos e muito mais prática no dia a dia.' },
            'corpo': { key: 'corpo', name: 'Tratamentos para Estrias e Celulite', description: '🌸 **Tratamentos para Estrias e Celulite**<br>Tratamentos personalizados que combinam técnicas como laser, radiofrequência, bioestimuladores e drenagem para suavizar a textura da pele e melhorar a aparência de estrias e celulite.', details: '<strong>Resultados esperados:</strong> pele mais uniforme, firme e bonita.' },
            'remodel': { key: 'remodel', name: 'Remodelagem Corporal', description: '🌸 **Remodelagem Corporal**<br>A remodelagem corporal visa reduzir medidas, modelar o contorno do corpo e melhorar a firmeza da pele, utilizando técnicas como ultrassom, radiofrequência e massagens especializadas.', details: '<strong>Resultados esperados:</strong> corpo mais definido, com curvas realçadas de forma natural.' },
            'peeling': { key: 'peeling', name: 'Peeling Químico', description: '🌸 **Peeling Químico**<br>O peeling químico utiliza agentes renovadores para tratar manchas, rugas finas, acne e melhorar a textura da pele. A escolha do tipo de peeling é personalizada conforme o tipo de pele.', details: '<strong>Resultados esperados:</strong> pele renovada, mais lisa, iluminada e uniforme.' },
            'hidragloss': { key: 'hidragloss', name: 'Hidragloss Labial', description: '🌸 **Hidragloss Labial**<br>Tratamento de hidratação profunda e revitalização dos lábios, usando ativos potentes que melhoram o volume natural, a cor e a textura sem necessidade de preenchimento.', details: '<strong>Resultados esperados:</strong> lábios mais macios, vibrantes e rejuvenescidos.' },
             'facial_harmony': {key: 'facial_harmony', name: 'Harmonização Facial', description: '🌸 **Harmonização Facial**<br>A harmonização facial é um conjunto de procedimentos estéticos minimamente invasivos que realçam a beleza natural, equilibrando os traços do rosto. Pode incluir preenchimentos, botox e outros ajustes personalizados para valorizar o formato facial.', details: '<strong>Resultados esperados:</strong> rosto mais harmônico, jovial e simétrico.'}
        };
        // RESTAURADO da versão Lorraine Botura
        const procedureLetterMap = {'A': 'botox', 'B': 'labial', 'C': 'micro', 'D': 'limpeza', 'E': 'laser', 'F': 'corpo', 'G': 'remodel', 'H': 'peeling', 'I': 'hidragloss', 'K': 'facial_harmony'};

        // --- MAPA DE KEYWORDS (RESTAURADO da versão Lorraine Botura) ---
        const keywordToActionMap = {
            // Procedimentos (mapeia para a key em procedureDetails)
            'harmonização facial': ['facial_harmony', 0], 'harmonizacao facial': ['facial_harmony', 0], 'rosto': ['facial_harmony', 0],
            'botox': ['botox', 0], 'rugas': ['botox', 0], 'marcas de expressão': ['botox', 0], 'linhas de expressão': ['botox', 0], 'testa': ['botox', 0], 'rejuvenescimento': ['botox', 0],
            'labial': ['labial', 0], 'lábio': ['labial', 0], 'lábios': ['labial', 0], 'boca': ['labial', 0], 'preenchimento labial': ['labial', 0], 'preenchimento': ['labial', 0], 'ácido hialurônico': ['labial', 0], 'lábios finos': ['labial', 0],
            'microagulhamento': ['micro', 0], 'micro agulhamento': ['micro', 0], 'agulha': ['micro', 0], 'colágeno': ['micro', 0], 'cicatrizes de acne': ['micro', 0],
            'limpeza de pele': ['limpeza', 0], 'limpeza': ['limpeza', 0], 'pele oleosa': ['limpeza', 0], 'cravo': ['limpeza', 0], 'poros': ['limpeza', 0], 'pele seca': ['limpeza', 0],
            'depilação a laser': ['laser', 0], 'depilacao a laser': ['laser', 0], 'depilação': ['laser', 0], 'laser': ['laser', 0], 'pelo': ['laser', 0], 'pelos': ['laser', 0],
            'estrias': ['corpo', 0], 'celulite': ['corpo', 0], 'flacidez': ['corpo', 0], 'pele flácida': ['corpo', 0],
            'remodelagem corporal': ['remodel', 0], 'remodelagem': ['remodel', 0], 'modelar': ['remodel', 0], 'gordura': ['remodel', 0], 'gordura localizada': ['remodel', 0], 'contorno': ['remodel', 0], 'ultrassom': ['remodel', 0], 'radiofrequência': ['remodel', 0], 'massagens estéticas': ['remodel', 0], 'detox corporal': ['remodel', 0], // Associando massagem e detox a remodelagem
            'peeling químico': ['peeling', 0], 'peeling quimico': ['peeling', 0], 'peeling': ['peeling', 0], 'manchas': ['peeling', 0], 'pele sem brilho': ['peeling', 0],
            'hidragloss labial': ['hidragloss', 0], 'hidragloss': ['hidragloss', 0], 'gloss': ['hidragloss', 0], 'lábios ressecados': ['hidragloss', 0],

            // Ações Gerais com Prioridade Alta
            'agendar': ['schedule_general', 2], 'agenda': ['schedule_general', 2], 'marcar': ['schedule_general', 2], 'consulta': ['schedule_general', 2], 'avaliação': ['schedule_general', 2], 'sessão': ['schedule_general', 2], 'quero agendar': ['schedule_general', 2], 'quero marcar': ['schedule_general', 2],
            'preço': ['price', 2], 'valor': ['price', 2], 'quanto custa': ['price', 2], 'orçamento': ['price', 2],
            'promoção': ['promo', 2], 'promocao': ['promo', 2], 'desconto': ['promo', 2], 'oferta': ['promo', 2],
            'pagamento': ['payment', 2], 'pagar': ['payment', 2], 'cartão': ['payment', 2], 'pix': ['payment', 2],
            'ajuda': ['talk_human', 2], 'atendente': ['talk_human', 2], 'humano': ['talk_human', 2], 'falar com alguém': ['talk_human', 2], 'preciso de ajuda': ['talk_human', 2], 'socorro': ['talk_human', 2], 'atendimento': ['talk_human', 2], 'falar com atendente': ['talk_human', 2], 'conversar com atendente': ['talk_human', 2], 'dúvida': ['talk_human', 2], 'duvida': ['talk_human', 2], // Dúvida com prioridade alta para humano

            // Ações de Info com Prioridade Média
            'endereço': ['info_address', 1], 'local': ['info_address', 1], 'onde fica': ['info_address', 1],
            'horário': ['info_hours', 1], 'horario': ['info_hours', 1], 'horas': ['info_hours', 1], 'funcionamento': ['info_hours', 1], 'abre': ['info_hours', 1], 'fecha': ['info_hours', 1],
            'telefone': ['info_phone', 1], 'whatsapp': ['info_phone', 1], 'contato': ['info_phone', 1],
            'informações': ['info', 1], 'informacoes': ['info', 1],

            // Ações Genéricas com Prioridade Baixa
            'tratamento': ['procedure', -1], 'estética': ['procedure', -1], 'procedimento': ['procedure', -1], 'quero fazer': ['procedure', -1], 'quero saber mais': ['procedure', -1], // Adicionado
            'necessidade estética': ['procedure', -1] // Adicionado
        };


        // --- FUNÇÕES DE VALIDAÇÃO --- (Mantidas)
        function validateName(name) { return name.trim().length > 2 && (name.includes(' ') || name.trim().length > 3); }
        function validatePhone(phone) { const cleaned = phone.replace(/\D/g, ''); return /^\d{10,11}$/.test(cleaned); }

        // --- FUNÇÕES DE UTILIDADE --- (Mantidas)
        function generateProtocol() { const now = new Date(); const ts = now.toISOString().replace(/[-T:.Z]/g, '').slice(0, 14); const rnd = String(Math.floor(1000 + Math.random() * 9000)); return `${ts}-${rnd}`; }
        function generateWhatsAppLink(context = '', procName = '', userPref = '') { const userPart = userData.name ? `${userData.name} (${userData.protocol || 'N/A'})` : `Protocolo: ${userData.protocol || 'N/A'}`; let txt = 'Olá! '; switch(context){ case 'agendamento': const pN = procName==='Avaliação Geral'?'uma avaliação geral':`uma avaliação para ${procName}`; const uP = userPref?` para ${userPref}`:''; txt += `Gostaria de confirmar ${pN}${uP}. ${userPart}`; break; case 'promocoes': const prN = procName?` para ${procName}`:''; txt += `Gostaria de saber sobre promoções atuais${prN}. ${userPart}`; break; case 'orcamento': txt += `Gostaria de um orçamento personalizado. ${userPart}`; break; case 'talk_human': txt += `Gostaria de falar com um atendente. ${userPart}`; break; case 'duvidas': default: txt += `Tenho dúvidas/Gostaria de mais informações. ${userPart}`; break; } return `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(txt)}`; }

        // --- FUNÇÕES DE CHAT --- (Mantidas)
         function addMessage(content, isUser, options = null) { /* ... (com geração de botões) ... */
             if (!content.startsWith('⚠️') && !(thinkingMessageDiv && content === thinkingMessageDiv.innerHTML) ) { chatHistory.push({ role: isUser ? 'user' : 'model', parts: [{ text: content + (options ? '\n[Opções apresentadas]' : '') }] }); } const messageDiv = document.createElement('div'); messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`; messageDiv.innerHTML = content.replace(/<script.*?>.*?<\/script>/gi, ''); if (!isUser && options) { const optsCont = document.createElement('div'); optsCont.className = 'options-container'; options.forEach(opt => { const btn = document.createElement('button'); btn.className = 'option-button'; btn.setAttribute('data-choice', opt.action); btn.onclick = () => handleButtonClick(opt.action, `${opt.letter}) ${opt.text}`); btn.innerHTML = `<span class="option-letter">${opt.letter})</span> ${opt.text}`; optsCont.appendChild(btn); }); messageDiv.appendChild(optsCont); } if (thinkingMessageDiv && chatBody.contains(thinkingMessageDiv)) { chatBody.insertBefore(messageDiv, thinkingMessageDiv); } else { chatBody.appendChild(messageDiv); } scrollToBottom();
         }
        function scrollToBottom() { chatBody.scrollTo({ top: chatBody.scrollHeight, behavior: 'smooth' }); }
        function showThinking(show = true) { if (!thinkingMessageDiv) return; thinkingMessageDiv.style.display = show ? 'block' : 'none'; if(show) scrollToBottom(); }
        function disablePreviousButtons() { const prevBtns = chatBody.querySelectorAll('.option-button:not(:disabled)'); prevBtns.forEach(btn => { const msgCont = btn.closest('.message.bot-message'); const lastBotMsg = chatBody.querySelector('.message.bot-message:has(.options-container):last-of-type'); if (msgCont !== lastBotMsg) { btn.disabled = true; } }); }

        // --- FUNÇÃO SALVAR/ATUALIZAR (UPSERT) --- (Mantida)
        async function saveOrUpdateConversation() { if (!userData.protocol) return; const hist = chatHistory.map(i => ({ sender: i.role, message: i.parts[0].text })); try { const { error } = await supabase.from('conversations').upsert({ protocol: userData.protocol, name: userData.name, phone: userData.phone, chat_history: hist }, { onConflict: 'protocol' }); if (error) console.error('Erro upsert:', error); } catch (err) { console.error('Catch upsert:', err); } }

        // --- GERADORES DE MENU COM BOTÕES (Atualizado inicial) ---
        function sendInitialMenu() {
            const text = `Agora me diga, como posso te ajudar hoje? ✨`;
            const options = [
                { letter: 'A', text: 'Saber sobre <strong>procedimento</strong>', action: 'procedure'},
                { letter: 'B', text: '<strong>Agendar avaliação</strong> geral', action: 'schedule_general'},
                { letter: 'C', text: '<strong>Informações da clínica</strong>', action: 'info'},
                { letter: 'D', text: '💬 Falar com um <strong>atendente</strong>', action: 'talk_human'}, // Mantido
                { letter: 'E', text: '<strong>Outra dúvida</strong>', action: 'other_doubt'} // Mantido
            ];
            addMessage(text, false, options);
            isWaitingFor = 'initial_choice';
        }
        // (Outras funções send...Menu mantidas - usando procedureLetterMap restaurado)
        function sendProcedureListMenu() { const txt = `Maravilha, ${userData.name}! 😊 Qual deles desperta seu interesse?`; const opts = Object.entries(procedureLetterMap).map(([l, k]) => ({ letter: l, text: procedureDetails[k]?.name || k, action: k })); opts.push({ letter: 'J', text: 'Outro', action: 'other_proc' }); addMessage(txt, false, opts); isWaitingFor = 'procedure_choice'; }
        function sendProcedureActionMenu(procKey) { const name = procedureDetails[procKey]?.name || 'este proc.'; const txt = `Sobre <strong>${name}</strong>, o que gostaria?`; const opts = [ { letter: 'A', text: 'Mais <strong>detalhes</strong>', action: 'details' }, { letter: 'B', text: '<strong>Agendar avaliação</strong>', action: 'schedule_specific' }, { letter: 'C', text: 'Verificar <strong>promoções</strong>', action: 'promo' }, { letter: 'D', text: 'Ver <strong>outro procedimento</strong>', action: 'other_procedure' } ]; addMessage(txt, false, opts); isWaitingFor = 'procedure_action'; }
        function sendDetailsSubMenu(procKey) { const name = procedureDetails[procKey]?.name || 'este proc.'; const txt = `Gostaria de agendar para ${name}? 😊`; const opts = [ { letter: 'A', text: 'Sim, <strong>agendar</strong>!', action: 'schedule_specific' }, { letter: 'B', text: `Saber <strong>promoções</strong> p/ ${name}`, action: 'promo' }, { letter: 'C', text: `<strong>Outra dúvida</strong> sobre ${name}`, action: 'other_doubt_proc' }, { letter: 'D', text: 'Ver <strong>outros</strong>', action: 'other_procedure' } ]; addMessage(txt, false, opts); isWaitingFor = 'procedure_action_after_details'; }
        function sendInfoClinicSubMenu() { const txt = `Precisa de mais informações, ${userData.name}?`; const opts = [ { letter: 'A', text: 'Formas de <strong>Pagamento</strong>', action: 'payment' }, { letter: 'B', text: 'Ver <strong>procedimentos</strong>', action: 'procedure' }, { letter: 'C', text: '<strong>Agendar</strong> avaliação', action: 'schedule_general' }, { letter: 'D', text: 'Não, obrigada!', action: 'end' } ]; addMessage(txt, false, opts); isWaitingFor = 'info_choice'; }
        function sendFinalConfirmationMenu() { const txt = `Posso te ajudar com mais algo, ${userData.name}? 😊`; const opts = [ { letter: 'A', text: 'Ver <strong>outro procedimento</strong>', action: 'procedure' }, { letter: 'B', text: '<strong>Informações da clínica</strong>', action: 'info' }, { letter: 'C', text: 'Não, obrigada!', action: 'end' } ]; addMessage(txt, false, opts); isWaitingFor = 'final_confirmation'; }

        // --- FUNÇÃO DE REDIRECIONAMENTO (Mantida) ---
        function sendWhatsappRedirect(context = 'duvidas', procName = '', userPref = '') { /* ... (Mantida) ... */
             let message = ''; let link = ''; if (context === 'agendamento') { const pN=procName==='Avaliação Geral'?'Avaliação Geral':procName; link=generateWhatsAppLink(context,pN,userPref); message=`Perfeito, ${userData.name}! 😊 Para confirmar ${pN}${userPref?` para ${userPref}`:''} e horários...<br><br>➡️ <a href="${link}" target="_blank">Confirmar ${pN} via WhatsApp</a>`; } else if (context === 'promocoes') { link=generateWhatsAppLink(context,procName); message=`Adoramos mimos! 💖 Para saber promoções${procName?` para ${procName}`:''}...<br><br>➡️ <a href="${link}" target="_blank">Ver Promoções no WhatsApp</a>`; } else if (context === 'orcamento') { link=generateWhatsAppLink(context); message=`Nossos valores são personalizados... Orçamento detalhado no WhatsApp. 😉<br><br>➡️ <a href="${link}" target="_blank">Solicitar Orçamento via WhatsApp</a>`; } else if (context === 'talk_human') { link=generateWhatsAppLink(context); message = `Com certeza, ${userData.name}! Nossa equipe está pronta para te atender... Clique abaixo: 😊<br><br>➡️ <a href="${link}" target="_blank">Falar com Atendente via WhatsApp</a>`; } else { link=generateWhatsAppLink('duvidas'); message=`Entendi, ${userData.name}. Para dúvidas específicas...<br><br>➡️ <a href="${link}" target="_blank">Falar com a Equipe no WhatsApp</a>`; } addMessage(message, false); if (['orcamento', 'talk_human', 'duvidas'].includes(context)) { isWaitingFor = 'message'; } else { setTimeout(sendFinalConfirmationMenu, 600); }
        }

         // --- FUNÇÕES INFO CLÍNICA (Atualizadas com dados CLINEE) ---
         function showAddress() {
             addMessage(`📍 Nosso endereço é:<br><strong>Avenida das Américas, 500<br>Bloco 11, loja 108 – Barra da Tijuca<br>Rio de Janeiro – RJ</strong><br>(Shopping Downtown)<br><br>Será um prazer recebê-la! 😊`, false);
             setTimeout(sendFinalConfirmationMenu, 600);
         }
         function showHours() {
             // !! ATENÇÃO: Confirmar e ajustar este horário para o real da CLINEE !!
             addMessage(`⏰ Nosso horário de funcionamento é:<br><strong>Segunda a Sexta: 09:00h às 19:00h</strong><br><strong>Sábado: 09:00h às 13:00h</strong><br>(Atendemos com hora marcada!)`, false);
             setTimeout(sendFinalConfirmationMenu, 600);
         }
         function showPhone() {
             addMessage(`📞 Nosso principal contato é via WhatsApp:<br><strong>(11) 95588-8451</strong><br><br>Clique aqui para chamar: <a href="${generateWhatsAppLink('duvidas')}" target="_blank">(11) 95588-8451</a>`, false);
             setTimeout(sendFinalConfirmationMenu, 600);
         }
         function showPayment() {
             addMessage(`Aceitamos: <strong>Dinheiro, PIX, Cartões de Débito e Crédito</strong>. Condições de parcelamento via WhatsApp. 😊`, false);
             setTimeout(sendFinalConfirmationMenu, 600);
         }

        // --- FUNÇÃO PARA PROCESSAR KEYWORDS (Mantida) ---
        function processKeywords(text) { /* ... (Mantida da resposta anterior) ... */
            const lowerText = text.toLowerCase().trim(); let matchedAction = null; let highestPriority = -1; const map = keywordToActionMap;
            for (const [keyword, actionData] of Object.entries(map)) { const action = Array.isArray(actionData) ? actionData[0] : actionData; const priority = Array.isArray(actionData) ? actionData[1] : 0; if (lowerText.includes(keyword)) { if (priority > highestPriority) { matchedAction = action; highestPriority = priority; } } } console.log("Keyword check:", lowerText, "-> Matched Action:", matchedAction, "Priority:", highestPriority); return matchedAction;
        }

        // --- PROCESSAMENTO CENTRAL (ATUALIZADO COM FALLBACK ESTRITO) ---
        async function processMessage(message, isButtonClick = false) {
            if (isProcessing && !isButtonClick) return;

            const inputText = isButtonClick ? message : message; // Ação ou texto

            if (!isButtonClick) { addMessage(inputText, true); userInput.value = ''; }

            isProcessing = true; userInput.disabled = true; showThinking(true); disablePreviousButtons();

            let keywordAction = null;
            let actionProcessedSuccessfully = false; // Flag para controlar se a ação foi tratada

            try {
                // --- 0. Verifica Keywords (APENAS para input digitado) ---
                if (!isButtonClick && isWaitingFor !== 'name_phone') {
                    keywordAction = processKeywords(inputText);
                }

                // --- LÓGICA PRINCIPAL ---
                const currentAction = keywordAction || inputText; // Usa keyword se houver, senão usa input/ação do botão

                // 1. Trata Ações Diretas (identificadas por keyword ou botão)
                if (['price', 'talk_human', 'info_address', 'info_hours', 'info_phone', 'payment'].includes(currentAction)) {
                    actionProcessedSuccessfully = true; // Ação direta foi identificada
                    switch(currentAction) {
                        case 'price': sendWhatsappRedirect('orcamento'); break;
                        case 'talk_human': sendWhatsappRedirect('talk_human'); break;
                        case 'info_address': showAddress(); break;
                        case 'info_hours': showHours(); break;
                        case 'info_phone': showPhone(); break;
                        case 'payment': showPayment(); break;
                    }
                }
                // 2. Trata Procedimentos (identificados por keyword ou botão)
                else if (procedureDetails[currentAction]) {
                    actionProcessedSuccessfully = true;
                    currentProcedure = currentAction;
                    addMessage(procedureDetails[currentAction].description, false);
                    sendProcedureActionMenu(currentAction);
                }
                 // 3. Trata Ações Genéricas baseadas no ESTADO ATUAL
                 else {
                     console.log("Processing State:", isWaitingFor, "Input/Action:", currentAction);
                     // Valida se a currentAction (seja de botão ou keyword menos prioritária) é válida para o estado atual
                     let isValidForState = false;
                     switch (isWaitingFor) {
                         case 'initial_choice':
                             isValidForState = ['procedure', 'schedule_general', 'info', 'talk_human', 'other_doubt'].includes(currentAction);
                             if (isValidForState) {
                                 actionProcessedSuccessfully = true;
                                 if (currentAction === 'procedure') { sendProcedureListMenu(); }
                                 else if (currentAction === 'schedule_general') { currentProcedure = 'general'; addMessage(`Ótimo! Qual <strong>dia</strong> e <strong>período</strong>?`, false); isWaitingFor = 'scheduling_preference'; }
                                 else if (currentAction === 'info') { addMessage(`Com prazer... 📍 <strong>Endereço:</strong>... ⏰ <strong>Horário:</strong> ...`, false); sendInfoClinicSubMenu(); }
                                 else if (currentAction === 'other_doubt') { sendWhatsappRedirect('duvidas'); }
                                 else if (currentAction === 'talk_human') { sendWhatsappRedirect('talk_human');} // Trata botão D
                             }
                             break;
                         case 'procedure_choice':
                              isValidForState = (procedureDetails[currentAction] || currentAction === 'other_proc');
                              if (isValidForState) {
                                 actionProcessedSuccessfully = true;
                                 if (procedureDetails[currentAction]) { currentProcedure = currentAction; addMessage(procedureDetails[currentAction].description, false); sendProcedureActionMenu(currentAction); }
                                 else if (currentAction === 'other_proc') { addMessage(`Qual outro procedimento?`, false); isWaitingFor = 'message'; }
                              }
                              break;
                         case 'procedure_action':
                              isValidForState = ['details', 'schedule_specific', 'promo', 'other_procedure'].includes(currentAction);
                              if(isValidForState) {
                                 actionProcessedSuccessfully = true;
                                 if (currentAction === 'details' && currentProcedure) { addMessage(procedureDetails[currentProcedure].details || `Info extra...`, false); sendDetailsSubMenu(currentProcedure); }
                                 else if (currentAction === 'schedule_specific' && currentProcedure) { addMessage(`Agendar ${procedureDetails[currentProcedure].name}... Qual <strong>dia</strong> e <strong>período</strong>?`, false); isWaitingFor = 'scheduling_preference'; }
                                 else if (currentAction === 'promo') { sendWhatsappRedirect('promocoes', procedureDetails[currentProcedure]?.name); }
                                 else if (currentAction === 'other_procedure') { sendProcedureListMenu(); }
                              }
                              break;
                          case 'procedure_action_after_details':
                               isValidForState = ['schedule_specific', 'promo', 'other_doubt_proc', 'other_procedure'].includes(currentAction);
                               if(isValidForState){
                                  actionProcessedSuccessfully = true;
                                  if (currentAction === 'schedule_specific' && currentProcedure) { addMessage(`Ótimo! Agendar ${procedureDetails[currentProcedure].name}... Qual <strong>dia</strong> e <strong>período</strong>?`, false); isWaitingFor = 'scheduling_preference'; }
                                  else if (currentAction === 'promo') { sendWhatsappRedirect('promocoes', procedureDetails[currentProcedure]?.name); }
                                  else if (currentAction === 'other_doubt_proc') { sendWhatsappRedirect('duvidas', `Dúvida sobre ${procedureDetails[currentProcedure]?.name}`); }
                                  else if (currentAction === 'other_procedure') { sendProcedureListMenu(); }
                               }
                               break;
                          case 'info_choice':
                               isValidForState = ['payment', 'procedure', 'schedule_general', 'end'].includes(currentAction);
                               if(isValidForState){
                                   actionProcessedSuccessfully = true;
                                   if(currentAction === 'payment') { showPayment(); }
                                   else if (currentAction === 'procedure') { sendProcedureListMenu(); }
                                   else if (currentAction === 'schedule_general') { currentProcedure = 'general'; addMessage(`Agendar avaliação geral! Qual <strong>dia</strong> e <strong>período</strong>?`, false); isWaitingFor = 'scheduling_preference'; }
                                   else if (currentAction === 'end') { addMessage(`Perfeito, ${userData.name}! ... 🌸`, false); isWaitingFor = 'message'; }
                               }
                               break;
                           case 'final_confirmation':
                                isValidForState = ['procedure', 'info', 'end'].includes(currentAction);
                                if(isValidForState){
                                    actionProcessedSuccessfully = true;
                                    if (currentAction === 'procedure') { sendProcedureListMenu(); }
                                    else if (currentAction === 'info') { addMessage(`Claro! O que mais?`, false); sendInfoClinicSubMenu(); }
                                    else if (currentAction === 'end') { addMessage(`Tudo bem, ${userData.name}! ... 💕 Até breve! 🌸`, false); isWaitingFor = 'message'; }
                                }
                                break;
                           case 'scheduling_preference': actionProcessedSuccessfully = true; const userPreference = currentAction; const procName = currentProcedure==='general'?'Avaliação Geral':procedureDetails[currentProcedure]?.name||'sua avaliação'; sendWhatsappRedirect('agendamento', procName, userPreference); break;
                           case 'name_phone':
                                actionProcessedSuccessfully = true; // A validação ocorre aqui
                                const parts=inputText.split(/,|\s(\d{10,11})$/); let pName=null; let pPhone=null; if(parts&&parts.length>=2){pName=parts[0]?.trim(); const pMatch=inputText.match(/(\d{10,11})\s*$/); if(pMatch){pPhone=pMatch[1]; pName=inputText.replace(pMatch[0],'').trim().replace(/,$/,'').trim();}else{pPhone=parts[1]?.replace(/\D/g,'');}}
                                if(pName&&pPhone&&validateName(pName)&&validatePhone(pPhone)){userData.name=pName.split(' ').map(w=>w[0].toUpperCase()+w.slice(1).toLowerCase()).join(' '); userData.phone=pPhone; userData.protocol=generateProtocol(); await saveOrUpdateConversation(); addMessage(`Que prazer, ${userData.name}! 💖 Protocolo: <strong>${userData.protocol}</strong>.`, false); sendInitialMenu();}
                                else{addMessage(`Desculpe... tente nome completo e telefone com DDD (Ex: Maria Silva, 11987654321). 🙏`, false); isWaitingFor = 'name_phone';}
                                break;
                           case 'message': // Estado aberto, qualquer input é "válido" mas pode cair no fallback abaixo
                                actionProcessedSuccessfully = false; // Força fallback se não foi tratado por keyword
                                break;
                           default: console.warn("Estado não reconhecido:", isWaitingFor); break;
                     } // Fim do Switch(isWaitingFor)
                 } // Fim do Else (Trata Ações Genéricas / Estado)

                // --- 4. Fallback ESTRITO ---
                // Só executa se NENHUMA keyword prioritária foi pega E a ação NÃO foi válida para o estado atual
                if (!actionProcessedSuccessfully && isWaitingFor !== 'name_phone') {
                    console.log("Executing Fallback: Unrecognized input/action.", "Input:", inputText, "State:", isWaitingFor);
                    const escapedInput = inputText.replace(/</g, "<").replace(/>/g, ">");
                    addMessage(`Desculpe, não tenho uma resposta programada para "<strong>${escapedInput}</strong>". Posso te ajudar com informações sobre procedimentos, agendamentos ou sobre a clínica.`, false);
                    sendInitialMenu(); // Volta ao menu inicial
                }
                 // --- Fim da Lógica Principal ---

                if (isWaitingFor !== 'name_phone') { await saveOrUpdateConversation(); }

            } catch (error) {
                console.error("Erro GERAL no processamento:", error);
                addMessage("⚠️ Ocorreu um erro inesperado. Tente novamente.", false);
                isWaitingFor = 'message'; // Reseta para estado aberto
            } finally {
                showThinking(false); isProcessing = false; userInput.disabled = false;
                if (!isButtonClick && isWaitingFor !== 'name_phone') { userInput.focus(); }
                scrollToBottom();
            }
        }

        // --- FUNÇÃO PARA LIDAR COM CLIQUE NO BOTÃO ---
        function handleButtonClick(choiceAction, choiceText) {
            if (isProcessing) return;
            // REMOVIDO: addMessage(choiceText, true); // Não mostra mais o texto do botão como msg de usuário
            processMessage(choiceAction, true); // Processa a AÇÃO interna do botão
        }

        // --- FUNÇÃO DE ENVIO PRINCIPAL ---
        function sendMessage() {
            const message = userInput.value.trim();
            if (message === '') return;
            processMessage(message, false); // Processa texto digitado
        }

        // --- INICIALIZAÇÃO ---
        function initializeChat() {
            chatHistory = []; userData = { name: null, phone: null, protocol: null }; isWaitingFor = 'name_phone'; currentProcedure = null; isProcessing = false; userInput.disabled = false;
            const messages = chatBody.querySelectorAll('.message:not(.thinking)'); messages.forEach(msg => msg.remove()); showThinking(false);
            addMessage('Olá! 🌸 Sou a assistente virtual da <strong>Clinée Medicina Estética</strong>... informe seu <strong>nome completo</strong> e <strong>telefone com DDD</strong>, por favor?<br>(Exemplo: Maria Silva, 11987654321)', false);
            userInput.focus();
        }

        // --- EVENT LISTENER ---
        userInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });

        // --- START ---
        document.addEventListener('DOMContentLoaded', initializeChat);

    </script>

</body>
</html>
