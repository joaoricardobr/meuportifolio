<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot - Cl√≠nica Lorraine Botura</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }
        body {
            background: linear-gradient(135deg, #B4182D, #54162B);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        .chat-container {
            width: 100%;
            max-width: 900px;
            background: #181A2F;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            display: flex;
            height: 85vh;
            overflow: hidden;
            position: relative;
        }
        .sidebar {
            width: 250px;
            background: #181A2F;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            border-right: 1px solid #FDA481;
        }
        .sidebar a {
            background: #242E49;
            color: #FDA481;
            text-decoration: none;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.3s ease;
            border: 1px solid #37415C;
        }
        .sidebar a:hover {
            background: #37415C;
            color: #fff;
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .chat-header {
            padding: 20px;
            background: #181A2F;
            color: #FDA481;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #FDA481;
        }
        .chat-header h1 {
            font-size: 1.3em;
            font-weight: 500;
            margin: 0;
        }
        .settings-icon {
            cursor: pointer;
            width: 24px;
            height: 24px;
            background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgZmlsbD0iI0ZEQTQ4MSIgdmlld0JveD0iMCAwIDI0IDI0Ij48cGF0aCBkPSJNMTIgMTJjLTEuMSAwLTIuMDQtLjA5LTIuOTktLjI1bC0yLjA3IDIuMDdDOC41NSAyMS4zNSA3Ljg1IDIxLjUgNy4yIDIxLjVsLTIuMDctMi4wN0M1LjUgMjAuODUgNS4zNSAyMC4xNSA0Ljk5IDE5LjVsMi4wNy0yLjA3QzYuOTEgMTcuMDQgNiAxNS45OCA2IDE0LjhjMCAtMS1xLjA5LTIuMDQuMjUtMi45OWwtMi4wNy0yLjA3QzIuNjUgOC41NSAyLjUgNy44NSAyLjUgNy4ybDIuMDctMi4wN0MzLjE1IDQuNSA0LjE1IDQuMzUgNC45OSA0LjA5bDIuMDcgMi4wN0M4LjA0IDYuMjUgOS4wMiA6IDEwLjEyIDZjMS1xIDAgMi4wNC4wESAyLjk5LjI1bDIuMDctMi4wN0MxNS41NSAyLjY1IDE2LjI1IDIuNSAxNi45IDIuNWwyLjA3IDIuMDdDMjAuODUgMy4xNSAyMSAyMy44NSAyMS4wMSAyNC41bC0yLjA3IDIuMDdDMjAuMDkgNi45MSAxOS4wMiA3IDE3LjkyIDdjLTEuMSAwLTIuMDQtLjA5LTIuOTktLjI1bC0yLjA3IDIuMDdDMjAuMDkgNi45MSAxOS4wMiA3IDE3LjkyIDdjLTEuMSAwLTIuMDQtLjA5LTIuOTktLjI1bC0yLjA3IDIuMDdDMjAuMDkgNi9uZ2h0PSIxLjUiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCI+PHBhdGggZD0iTTEyIDE1YTQgNCAwIDEgMCAwLTggNCA0IDAgMCAwIDAgOHptMCAyYTUgNSAwIDEgMCAwLTEwIDUgNSAwIDAgMCAwIDEwem0wIDNhNiA2IDAgMCAwIDAtMTIgNiA2IDAgMCAwIDAgMTJ6bTAtNGE3IDcgMCAwIDAgMC0xNCA3IDcgMCAwIDAgMCAxNHoiLz48L3N2Zz4=') no-repeat center;
        }
        .chat-body {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #181A2F;
        }
        .message {
            margin: 10px 0;
            padding: 12px 18px;
            border-radius: 15px;
            max-width: 75%;
            font-size: 0.95em;
            line-height: 1.4;
        }
        .user-message {
            background: #FDA481;
            color: #181A2F;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }
        .bot-message {
            background: #242E49;
            color: #fff;
            margin-right: auto;
            border-bottom-left-radius: 5px;
        }
        .bot-message a {
            color: #FDA481;
            text-decoration: underline;
        }
        .bot-message ul {
            list-style: none;
            padding: 0;
            margin: 10px 0;
        }
        .bot-message ul li {
            padding: 5px 0;
            border-bottom: 1px solid #37415C;
        }
        .bot-message ul li:last-child {
            border-bottom: none;
        }
        .bot-message strong {
            color: #FDA481;
        }
        .chat-footer {
            padding: 15px 20px;
            background: #181A2F;
            display: flex;
            align-items: center;
            gap: 10px;
            border-top: 1px solid #FDA481;
        }
        .chat-input {
            flex: 1;
            padding: 12px 18px;
            border: none;
            background: #242E49;
            color: #fff;
            border-radius: 25px;
            outline: none;
            font-size: 0.95em;
        }
        .chat-input::placeholder {
            color: #FDA481;
        }
        .send-button {
            width: 40px;
            height: 40px;
            border: none;
            background: #FDA481 url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgZmlsbD0iIzE4MUEyRiIgdmlld0JveD0iMCAwIDI0IDI0Ij48cGF0aCBkPSJNMTIgMTJjLTIuMjEgMC00LTEuNzktNC00cyAxLjc5LTQgNC00IDQgMS43OSA0IDQtMS43OSA0LTQtNHptLTMgM2MtLjU1IDAtMS0uNDUtMS0xcy40NS0xIDEtMXMxIC40NSAxIDEtLjQ1IDEtMSAxem0zIDBjLS41NSAwLTEtLjQ1LTEtMXMuNDUtMSAxLTFzMSAuNDUgMSAxLS40NSAxLTEgMXptMyAwYy0uNTUgMC0xLS40NS0xLTFzLjQ1LTEgMS0xczEgLjQ1IDEgMS0uNDUgMS0xIDF6bS0zLTdjLS41NSAwLTEtLjQ1LTEtMXMuNDUtMSAxLTFzMSAuNDUgMSAxLS40NSAxLTEgMXoiLz48L3N2Zz4=') no-repeat center;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }
        .send-button:hover {
            background: #B4182D url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgZmlsbD0iI2ZmZiIgdmlld0JveD0iMCAwIDI0IDI0Ij48cGF0aCBkPSJNMTIgMTJjLTIuMjEgMC00LTEuNzktNC00cyAxLjc5LTQgNC00IDQgMS43OSA0IDQtMS43OSA0LTQtNHptLTMgM2MtLjU1IDAtMS0uNDUtMS0xcy40NS0xIDEtMXMxIC40NSAxIDEtLjQ1IDEtMSAxem0zIDBjLS41NSAwLTEtLjQ1LTEtMXMuNDUtMSAxLTFzMSAuNDUgMSAxLS40NSAxLTEgMXptMyAwYy0uNTUgMC0xLS40NS0xLTFzLjQ1LTEgMS0xczEgLjQ1IDEgMS0uNDUgMS0xIDF6bS0zLTdjLS41NSAwLTEtLjQ1LTEtMXMuNDUtMSAxLTFzMSAuNDUgMSAxLS40NSAxLTEgMXoiLz48L3N2Zz4=') no-repeat center;
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        .bio-link {
            padding: 15px 20px;
            background: #181A2F;
            text-align: center;
            border-top: 1px solid #FDA481;
        }
        .bio-link a {
            display: inline-block;
            background: #242E49;
            color: #FDA481;
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .bio-link a:hover {
            background: #37415C;
            color: #fff;
            transform: scale(1.05);
        }
        .settings-modal {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #181A2F;
            border-radius: 20px;
            flex-direction: column;
            padding: 20px;
            box-sizing: border-box;
        }
        .settings-modal.show {
            display: flex;
        }
        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .settings-header h2 {
            font-size: 1.1em;
            font-weight: 500;
            margin: 0;
            color: #FDA481;
        }
        .close-settings {
            cursor: pointer;
            width: 24px;
            height: 24px;
            background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgZmlsbD0iI0ZEQTQ4MSIgdmlld0JveD0iMCAwIDI4IDI0Ij48cGF0aCBkPSJNMTguMyA1LjcxYy0uMzktLjM5LTEuMDItLjM5LTEuNDEgMGwtNC44OSA0Ljg5LTQuODktNC44OWMtLjM5LS4zES0xLjQxIDAtLjM5LjM5LS4zESAxLjAyIDAgMS40MWw0Ljg5IDQuODktNC44OSA0Ljg5Yy0uMzkuMzktLjM5IDEuMDIgMCAxLjQxLjM5LjM5IDEuMDIuMzkgMS40MSAwbDQuODktNC44OSA0Ljg5IDQuODljLjM5LjM5IDEuMDIuMzkgMS40MSAwIC4zES0uMzkuMzktMS4wMiAwLTEuNDFsLTQuODktNC44OSA0Ljg5LTQuODljLjM5LS4zES4zES0xLjAyIDAtMS40MXoiLz48L3N2Zz4=') no-repeat center;
        }
        .settings-body textarea {
            width: 100%;
            height: 200px;
            padding: 12px;
            border: 1px solid #FDA481;
            border-radius: 10px;
            resize: none;
            font-size: 0.95em;
            outline: none;
            background: #242E49;
            color: #fff;
        }
        .settings-footer {
            margin-top: 20px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        .settings-footer button {
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.95em;
        }
        .save-button {
            background: #FDA481;
            color: #181A2F;
        }
        .cancel-button {
            background: #242E49;
            color: #fff;
        }
        @media (max-width: 768px) {
            .chat-container {
                flex-direction: column;
                height: 100vh;
                border-radius: 0;
            }
            .sidebar {
                width: 100%;
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: center;
                border-right: none;
                border-bottom: 1px solid #FDA481;
            }
            .sidebar a {
                flex: 1 1 45%;
                margin: 5px;
            }
            .chat-area {
                flex: 1;
            }
            .bio-link {
                padding: 10px;
            }
            .bio-link a {
                font-size: 0.85em;
                padding: 8px 15px;
            }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="sidebar">
            <a href="https://www.instagram.com/lorrainebotura/" target="_blank">INSTAGRAM</a>
            <a href="https://www.facebook.com/lorrainebotura" target="_blank">FACEBOOK</a>
            <a href="https://lorrainebotura.com.br/clinicasaojosedoscampos/" target="_blank">CL√çNICA S√ÉO JOS√â DOS CAMPOS</a>
            <a href="https://lorrainebotura.com.br/clinicacaraguatatuba/" target="_blank">CL√çNICA CARAGUATATUBA</a>
            <a href="https://wa.me/5512992061898?text=Ol√°,%20gostaria%20de%20agendar%20uma%20avalia√ß√£o%20na%20Cl√≠nica%20Lorraine%20Botura!" target="_blank">AGENDE SEU PROCEDIMENTO</a>
            <a href="https://www.google.com/search?kgmid=/g/11gpgszlsj&hl=pt-BR&q=Lorraine+Botura+Est%C3%A9tica&shndl=30&source=sh/x/loc/osrp/m5/1&kgs=719c6f2276454cec#" target="_blank">ME AVALIE NO GOOGLE</a>
        </div>
        <div class="chat-area">
            <div class="chat-header">
                <h1>Cl√≠nica Lorraine Botura</h1>
                <div class="settings-icon" onclick="openSettings()"></div>
            </div>
            <div class="chat-body" id="chatBody">
                <div class="message bot-message">Ol√°, seja muito bem-vindo(a) √† Cl√≠nica Lorraine Botura! üå∏ Para iniciar seu atendimento, poderia me informar seu nome e telefone, por favor?</div>
            </div>
            <div class="chat-footer">
                <input type="text" class="chat-input" id="userInput" placeholder="Digite sua mensagem...">
                <button class="send-button" onclick="sendMessage()"></button>
            </div>
            <div class="bio-link">
                <a href="https://lorrainebotura.com.br/biografia/" target="_blank">Conhe√ßa mais sobre Lorraine Botura</a>
            </div>
        </div>
    </div>

    <div class="settings-modal" id="settingsModal">
        <div class="settings-header">
            <h2>Configura√ß√µes de Atendimento</h2>
            <div class="close-settings" onclick="closeSettings()"></div>
        </div>
        <div class="settings-body">
            <textarea id="agentPrompt"># üéÄ Prompt para Agente Virtual - Cl√≠nica de Est√©tica Lorraine Botura üéÄ

Voc√™ √© o agente virtual oficial da **Cl√≠nica de Est√©tica Lorraine Botura**.  
Seu objetivo √© **acolher, informar e orientar clientes** de maneira **atenciosa, elegante e eficiente**.  
Use sempre um **tom de voz gentil, acolhedor, confiante e emp√°tico**, transmitindo o **carinho** e a **excel√™ncia** da cl√≠nica.

---

## üõéÔ∏è Suas Fun√ß√µes:

- Recepcionar clientes com **sauda√ß√£o calorosa**.
- Coletar **informa√ß√µes b√°sicas** de forma delicada (nome, telefone, e-mail).
- Esclarecer d√∫vidas sobre:
  - Procedimentos est√©ticos oferecidos.
  - Benef√≠cios, diferenciais e indica√ß√µes dos tratamentos.
  - Dura√ß√£o, recomenda√ß√µes pr√© e p√≥s-procedimento.
  - Promo√ß√µes ou pacotes dispon√≠veis.
- Informar que os **valores** s√£o personalizados e o or√ßamento ser√° enviado via **WhatsApp**.
- Fornecer **endere√ßo, hor√°rio de funcionamento e formas de pagamento** aceitas.
- **Agendar avalia√ß√µes** ou sess√µes.
- Encaminhar o contato para o **atendimento humano** (quando necess√°rio, especialmente para d√∫vidas m√©dicas).

---

## üó£Ô∏è Tom de Voz:

- Elegante, acolhedor, emp√°tico e motivador.
- Sempre use palavras **positivas e reconfortantes**.
- Evite termos t√©cnicos complicados (ou explique de forma simples).
- Reforce que **cada atendimento √© √∫nico e personalizado**.

---

## ‚ú® Frases √öteis:

- "Ol√°, seja muito bem-vindo(a) √† Cl√≠nica Lorraine Botura! üå∏ Para iniciar seu atendimento, poderia me informar seu nome e telefone, por favor?"
- "Ficamos felizes em saber que voc√™ busca real√ßar ainda mais sua beleza! Me conte, qual procedimento desperta seu interesse?"
- "Nossos hor√°rios s√£o flex√≠veis para se encaixar na sua rotina. Vamos agendar sua avalia√ß√£o gratuita?"
- "Todos os nossos procedimentos s√£o realizados por profissionais altamente qualificados, com todo carinho e responsabilidade que voc√™ merece."
- "Sua beleza √© √∫nica, e nossos tratamentos tamb√©m! Para valores e pacotes especiais, nossa equipe entrar√° em contato pelo WhatsApp."
- "Caso tenha alguma condi√ß√£o de sa√∫de espec√≠fica, orientamos uma breve avalia√ß√£o inicial para garantir o melhor cuidado."

---

## üå∏ Procedimentos que voc√™ pode citar:

- Harmoniza√ß√£o facial
- Botox
- Preenchimento labial
- Microagulhamento
- Limpeza de pele profunda
- Depila√ß√£o a laser
- Tratamentos para estrias e celulite
- Remodelagem corporal
- Peeling qu√≠mico
- Hidragloss labial

*(Adapte conforme os servi√ßos reais da cl√≠nica)*

---

## üö´ Restri√ß√µes Importantes:

- Nunca fazer diagn√≥sticos.
- Nunca prometer resultados sem avalia√ß√£o presencial.
- N√£o prescrever produtos ou medicamentos.
- N√£o informar valores diretamente; sempre redirecionar ao atendimento humano via WhatsApp.

---

## üìç Informa√ß√µes da Cl√≠nica:

- **Endere√ßo:** Av. Andr√¥meda, 3808 - sala 1 - Bosque dos Eucaliptos, S√£o Jos√© dos Campos - SP, 12233-380
- **Telefone/WhatsApp:** (12) 99206-1898
- **Hor√°rio de funcionamento:** 
  - Fechado atualmente.
  - Aberto √†s ter√ßas-feiras a partir das 11:00h.

---

## üìã Exemplos de Atendimento:

### üéØ Agendamento:
"Que maravilhoso saber que voc√™ se interessou pela harmoniza√ß√£o facial! Para te atender com todo cuidado, posso agendar uma avalia√ß√£o sem compromisso. Qual seria o melhor dia e hor√°rio para voc√™?"

### üåø D√∫vidas sobre Procedimentos:
"A limpeza de pele profunda √© perfeita para revitalizar sua pele! Ela inclui extra√ß√£o, hidrata√ß√£o e m√°scara calmante. Recomenda-se realizar a cada 30 a 45 dias, dependendo do seu tipo de pele."

### üéÅ Promo√ß√µes:
"Neste m√™s, estamos com condi√ß√µes especiais para tratamentos corporais! Posso enviar todos os detalhes para voc√™ no WhatsApp, tudo bem?"

---

## üåü Extras que voc√™ pode adicionar no futuro:

- Roteiros prontos para cada procedimento.
- Fluxo de agendamento autom√°tico.
- Mensagens especiais de boas-vindas e p√≥s-atendimento.

---

**Pronto! Agora o agente virtual da Cl√≠nica Lorraine Botura est√° completo, profissional e acolhedor.**  
üå∏‚ú®</textarea>
        </div>
        <div class="settings-footer">
            <button class="cancel-button" onclick="closeSettings()">Cancelar</button>
            <button class="save-button" onclick="saveAgentPrompt()">Salvar</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Configura√ß√£o do Supabase
        const SUPABASE_URL = 'https://wrsjjnlpwwtrwekjhjcy.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indyc2pqbmxwd3d0cndla2poamN5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQ4MDY5MjcsImV4cCI6MjA2MDM4MjkyN30.5hjlREAHW6Zd-PKTB3eGuKSbJFHSW5s8OCGd_jr-f4o';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Configura√ß√£o da Gemini API
        const GEMINI_API_KEY = 'AIzaSyBsWK-qUzEts9UjoVP2wDmDLBKpfR4kMtQ';
        const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent';

        // N√∫mero do WhatsApp da cl√≠nica
        const WHATSAPP_NUMBER = '5512992061898';

        // Estado da conversa
        let userData = { name: null, phone: null, protocol: null };
        let chatHistory = [];
        let isFirstMessage = true;

        // Fun√ß√£o para gerar protocolo √∫nico (YYYYMMDD-HHMMSS-XXXX)
        function generateProtocol() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            const random = String(Math.floor(1000 + Math.random() * 9000)); // N√∫mero aleat√≥rio de 4 d√≠gitos
            return `${year}${month}${day}-${hours}${minutes}${seconds}-${random}`;
        }

        // Fun√ß√£o para salvar a conversa no Supabase
        async function saveConversation() {
            try {
                const { error } = await supabase
                    .from('conversations')
                    .insert({
                        protocol: userData.protocol,
                        name: userData.name,
                        phone: userData.phone,
                        chat_history: chatHistory,
                        created_at: new Date().toISOString()
                    });

                if (error) {
                    console.error('Erro ao salvar conversa no Supabase:', error.message);
                    throw error;
                }
            } catch (error) {
                console.error('Erro ao salvar conversa:', error.message);
            }
        }

        // Fun√ß√£o para gerar o link do WhatsApp com a d√∫vida do usu√°rio e protocolo
        function generateWhatsAppLink(message, isScheduling = false) {
            const encodedMessage = encodeURIComponent(
                isScheduling 
                    ? `Ol√°, gostaria de agendar uma avalia√ß√£o na Cl√≠nica Lorraine Botura! Protocolo de Atendimento: ${userData.protocol}`
                    : `Ol√°, tenho uma d√∫vida: ${message} - Protocolo de Atendimento: ${userData.protocol}`
            );
            return `https://wa.me/${WHATSAPP_NUMBER}?text=${encodedMessage}`;
        }

        // Fun√ß√£o para adicionar mensagem ao chat e ao hist√≥rico
        function addMessage(content, isUser) {
            const chatBody = document.getElementById('chatBody');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`;
            messageDiv.innerHTML = content;
            chatBody.appendChild(messageDiv);
            chatBody.scrollTop = chatBody.scrollHeight;

            // Adicionar ao hist√≥rico
            chatHistory.push({ sender: isUser ? 'user' : 'bot', message: content, timestamp: new Date().toISOString() });
        }

        // Fun√ß√£o para verificar se a mensagem indica inten√ß√£o de agendamento
        function isSchedulingIntent(message) {
            const schedulingKeywords = [
                'agendar', 'marcar', 'consulta', 'avalia√ß√£o', 'hor√°rio', 'sess√£o', 
                'quero agendar', 'posso agendar', 'marcar uma consulta', 'agendar uma avalia√ß√£o'
            ];
            const lowerMessage = message.toLowerCase();
            return schedulingKeywords.some(keyword => lowerMessage.includes(keyword));
        }

        // Fun√ß√£o para verificar se a mensagem pergunta sobre tratamentos
        function isTreatmentQuery(message) {
            const treatmentKeywords = [
                'tratamentos', 'procedimentos', 'servi√ßos', 'o que voc√™s oferecem',
                'harmoniza√ß√£o', 'botox', 'preenchimento', 'microagulhamento', 'limpeza de pele',
                'depila√ß√£o', 'estrias', 'celulite', 'remodelagem', 'peeling', 'hidragloss'
            ];
            const lowerMessage = message.toLowerCase();
            return treatmentKeywords.some(keyword => lowerMessage.includes(keyword));
        }

        // Fun√ß√£o para verificar se a mensagem pergunta sobre hor√°rios
        function isHoursQuery(message) {
            const hoursKeywords = [
                'hor√°rio', 'funcionamento', 'aberto', 'fecha', 'atendimento'
            ];
            const lowerMessage = message.toLowerCase();
            return hoursKeywords.some(keyword => lowerMessage.includes(keyword));
        }

        // Fun√ß√£o para verificar se a resposta √© insatisfat√≥ria
        function isUnsatisfactoryResponse(response) {
            const genericResponses = [
                'desculpe, n√£o sei responder isso',
                'n√£o sei',
                'n√£o tenho essa informa√ß√£o',
                'desculpe, n√£o entendi'
            ];
            const lowerResponse = response.toLowerCase();
            return response.length < 20 || genericResponses.some(phrase => lowerResponse.includes(phrase));
        }

        // Fun√ß√£o para formatar resposta sobre tratamentos
        function formatTreatmentsResponse() {
            return `
                Ficamos felizes em compartilhar os tratamentos que oferecemos para real√ßar sua beleza! üå∏ Confira abaixo:

                <ul>
                    <li><strong>Harmoniza√ß√£o Facial:</strong> Real√ßa os tra√ßos do rosto com equil√≠brio e naturalidade.</li>
                    <li><strong>Botox:</strong> Reduz linhas de express√£o para uma apar√™ncia rejuvenescida.</li>
                    <li><strong>Preenchimento Labial:</strong> D√° volume e contorno aos l√°bios de forma personalizada.</li>
                    <li><strong>Microagulhamento:</strong> Estimula o col√°geno para uma pele mais firme e renovada.</li>
                    <li><strong>Limpeza de Pele Profunda:</strong> Remove impurezas e revitaliza a pele.</li>
                    <li><strong>Depila√ß√£o a Laser:</strong> Solu√ß√£o duradoura para remo√ß√£o de pelos.</li>
                    <li><strong>Tratamentos para Estrias e Celulite:</strong> Melhora a textura da pele com t√©cnicas avan√ßadas.</li>
                    <li><strong>Remodelagem Corporal:</strong> Modela o corpo com seguran√ßa e efic√°cia.</li>
                    <li><strong>Peeling Qu√≠mico:</strong> Renova a pele, tratando manchas e imperfei√ß√µes.</li>
                    <li><strong>Hidragloss Labial:</strong> Hidrata e d√° brilho aos l√°bios com efeito natural.</li>
                </ul>

                Qual desses desperta seu interesse? Posso te ajudar com mais detalhes!
            `;
        }

        // Fun√ß√£o para formatar resposta sobre hor√°rios
        function formatHoursResponse() {
            return `
                Aqui est√£o os detalhes do nosso hor√°rio de funcionamento:

                <ul>
                    <li><strong>Atualmente:</strong> Fechado.</li>
                    <li><strong>Ter√ßas-feiras:</strong> Aberto a partir das 11:00h.</li>
                </ul>

                Gostaria de agendar uma avalia√ß√£o para a pr√≥xima ter√ßa-feira?
            `;
        }

        // Fun√ß√£o para formatar resposta de agendamento
        function formatSchedulingResponse() {
            const link = generateWhatsAppLink('', true);
            return `
                Que maravilhoso saber do seu interesse! Para te atender com todo o cuidado, posso agendar uma avalia√ß√£o sem compromisso. Clique no link abaixo para escolher o melhor dia e hor√°rio com nossa equipe:

                <a href="${link}" target="_blank">Agendar via WhatsApp</a>
            `;
        }

        // Fun√ß√£o para chamar a Gemini API
        async function callGeminiAPI(prompt, agentPrompt = '') {
            try {
                const response = await fetch(`${GEMINI_API_URL}?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: agentPrompt ? `${agentPrompt}\n\nUsu√°rio: ${prompt}` : prompt
                            }]
                        }]
                    })
                });

                if (!response.ok) {
                    throw new Error('Erro na chamada da API');
                }

                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error('Erro:', error);
                return 'Desculpe, houve um erro ao processar sua solicita√ß√£o. Tente novamente mais tarde.';
            }
        }

        // Fun√ß√£o para validar telefone (formato simples)
        function validatePhone(phone) {
            const phoneRegex = /^\d{10,11}$/;
            return phoneRegex.test(phone);
        }

        // Fun√ß√£o para enviar mensagem
        async function sendMessage() {
            const userInput = document.getElementById('userInput');
            const message = userInput.value.trim();

            if (message === '') return;

            // Adiciona mensagem do usu√°rio ao chat e ao hist√≥rico
            addMessage(message, true);
            userInput.value = '';

            // Primeira mensagem: coletar nome
            if (isFirstMessage) {
                userData.name = message;
                addMessage('Obrigada por informar seu nome! Agora, poderia me passar seu telefone, por favor? (Exemplo: 11987654321)', false);
                isFirstMessage = false;
                return;
            }

            // Segunda mensagem: coletar telefone e gerar protocolo
            if (!userData.phone) {
                if (!validatePhone(message)) {
                    addMessage('Por favor, informe um telefone v√°lido (apenas n√∫meros, 10 ou 11 d√≠gitos). Exemplo: 11987654321', false);
                    return;
                }
                userData.phone = message;
                userData.protocol = generateProtocol();
                addMessage(`Perfeito, ${userData.name}! Seu protocolo de atendimento √©: <strong>${userData.protocol}</strong>. Como posso ajudar voc√™ hoje?`, false);
                return;
            }

            // Verifica palavras-chave para respostas organizadas
            if (isSchedulingIntent(message)) {
                addMessage(formatSchedulingResponse(), false);
                await saveConversation();
                return;
            }

            if (isTreatmentQuery(message)) {
                addMessage(formatTreatmentsResponse(), false);
                await saveConversation();
                return;
            }

            if (isHoursQuery(message)) {
                addMessage(formatHoursResponse(), false);
                await saveConversation();
                return;
            }

            // Obt√©m o prompt do agente do Supabase
            let agentPrompt = '';
            try {
                const { data, error } = await supabase
                    .from('agent_prompts')
                    .select('prompt')
                    .eq('id', 1)
                    .single();

                if (error) {
                    console.error('Erro ao buscar prompt:', error.message);
                    throw error;
                }
                agentPrompt = data?.prompt || document.getElementById('agentPrompt').value;
            } catch (error) {
                console.error('Erro ao buscar prompt:', error.message);
                agentPrompt = document.getElementById('agentPrompt').value;
                addMessage('‚ö†Ô∏è N√£o foi poss√≠vel conectar ao banco de dados para carregar o prompt. Usando o prompt padr√£o.', false);
            }

            // Chama a Gemini API para obter resposta
            const botResponse = await callGeminiAPI(message, agentPrompt);

            // Verifica se a resposta √© insatisfat√≥ria
            if (isUnsatisfactoryResponse(botResponse)) {
                const vipResponse = `Estamos direcionando voc√™ para um atendimento VIP. Seu protocolo √©: <strong>${userData.protocol}</strong>. Clique aqui para continuar no WhatsApp: <a href="${generateWhatsAppLink(message)}" target="_blank">Atendimento VIP</a>`;
                addMessage(vipResponse, false);
                await saveConversation();
            } else {
                addMessage(botResponse, false);
                await saveConversation();
            }
        }

        // Fun√ß√£o para abrir o modal de configura√ß√µes
        function openSettings() {
            const modal = document.getElementById('settingsModal');
            modal.classList.add('show');

            // Carrega o prompt atual do Supabase
            supabase
                .from('agent_prompts')
                .select('prompt')
                .eq('id', 1)
                .single()
                .then(({ data, error }) => {
                    if (data) {
                        document.getElementById('agentPrompt').value = data.prompt || document.getElementById('agentPrompt').value;
                    } else if (error) {
                        console.error('Erro ao carregar prompt:', error.message);
                    }
                })
                .catch(error => {
                    console.error('Erro ao carregar prompt:', error.message);
                });
        }

        // Fun√ß√£o para fechar o modal de configura√ß√µes
        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('show');
        }

        // Fun√ß√£o para salvar o prompt do agente
        async function saveAgentPrompt() {
            const prompt = document.getElementById('agentPrompt').value;

            try {
                const { data, error } = await supabase
                    .from('agent_prompts')
                    .upsert({ id: 1, prompt })
                    .select();

                if (error) {
                    console.error('Erro ao salvar prompt:', error.message);
                    throw error;
                }
                alert('Prompt salvo com sucesso!');
                closeSettings();
            } catch (error) {
                console.error('Erro ao salvar o prompt:', error.message);
                alert('Erro ao salvar o prompt. Verifique se a tabela "agent_prompts" foi criada no Supabase.');
            }
        }

        // Enviar mensagem ao pressionar Enter
        document.getElementById('userInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
</body>
</html>
