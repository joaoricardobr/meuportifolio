<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot - Cl√≠nica Lorraine Botura</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }
        body {
            background: linear-gradient(135deg, #B4182D, #54162B);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        .chat-container {
            width: 100%;
            max-width: 900px;
            background: #181A2F;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            display: flex;
            height: 85vh;
            overflow: hidden;
            position: relative;
        }
        .sidebar {
            width: 250px;
            background: #181A2F;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            border-right: 1px solid #FDA481;
        }
        .sidebar a {
            background: #242E49;
            color: #FDA481;
            text-decoration: none;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.3s ease;
            border: 1px solid #37415C;
        }
        .sidebar a:hover {
            background: #37415C;
            color: #fff;
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        .chat-header {
            padding: 20px;
            background: #181A2F;
            color: #FDA481;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #FDA481;
        }
        .chat-header h1 {
            font-size: 1.3em;
            font-weight: 500;
            margin: 0;
        }
        .settings-icon {
            cursor: pointer;
            width: 24px;
            height: 24px;
            background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgZmlsbD0iI0ZEQTQ4MSIgdmlld0JveD0iMCAwIDI0IDI0Ij48cGF0aCBkPSJNMTIgMTJjLTEuMSAwLTIuMDQtLjA5LTIuOTktLjI1bC0yLjA3IDIuMDdDOC41NSAyMS4zNSA3Ljg1IDIxLjUgNy4yIDIxLjVsLTIuMDctMi4wN0M1LjUgMjAuODUgNS4zNSAyMC4xNSA0Ljk5IDE5LjVsMi4wNy0yLjA3QzYuOTEgMTcuMDQgNiAxNS45OCA2IDE0LjhjMCAtMS1xLjA5LTIuMDQuMjUtMi45OWwtMi4wNy0yLjA3QzIuNjUgOC41NSAyLjUgNy44NSAyLjUgNy4ybDIuMDctMi4wN0MzLjE1IDQuNSA0LjE1IDQuMzUgNC45OSA0LjA5bDIuMDcgMi4wN0M4LjA0IDYuMjUgOS4wMiA2IDEwLjEyIDZjMS1xIDAgMi4wNC4wESAyLjk5LjI1bDIuMDctMi4wN0MxNS41NSAyLjY1IDE2LjI1IDIuNSAxNi45IDIuNWwyLjA3IDIuMDdDMjAuODUgMy4xNSAyMSAyMy44NSAyMS4wMSAyNC41bC0yLjA3IDIuMDdDMjAuMDkgNi45MSAxOS4wMiA3IDE3LjkyIDdjLTEuMSAwLTIuMDQtLjA5LTIuOTktLjI1bC0yLjA3IDIuMDdDMjAuMDkgNi45MSAxOS4wMiA3IDE3LjkyIDdjLTEuMSAwLTIuMDQtLjA5LTIuOTktLjI1bC0yLjA3IDIuMDdDMjAuMDkgNi9uZ2h0PSIxLjUiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCI+PHBhdGggZD0iTTEyIDE1YTQgNCAwIDEgMCAwLTggNCA0IDAgMCAwIDAgOHptMCAyYTUgNSAwIDEgMCAwLTEwIDUgNSAwIDAgMCAwIDEwem0wIDNhNiA2IDAgMCAwIDAtMTIgNiA2IDAgMCAwIDAgMTJ6bTAtNGE3IDcgMCAwIDAgMC0xNCA3IDcgMCAwIDAgMCAxNHoiLz48L3N2Zz4=') no-repeat center;
        }
        .chat-body {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #181A2F;
            scroll-behavior: smooth;
            position: relative;
        }
        .message {
            margin: 10px 0;
            padding: 12px 18px;
            border-radius: 15px;
            max-width: 75%;
            font-size: 0.95em;
            line-height: 1.4;
        }
        .user-message {
            background: #FDA481;
            color: #181A2F;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }
        .bot-message {
            background: #242E49;
            color: #fff;
            margin-right: auto;
            border-bottom-left-radius: 5px;
        }
        .bot-message a {
            color: #FDA481;
            text-decoration: underline;
        }
        .bot-message ul {
            list-style: none;
            padding: 0;
            margin: 10px 0;
        }
        .bot-message ul li {
            padding: 5px 0;
            border-bottom: 1px solid #37415C;
        }
        .bot-message ul li:last-child {
            border-bottom: none;
        }
        .bot-message strong {
            color: #FDA481;
        }
        .sub-message {
            font-size: 0.85em;
            margin-top: 8px;
            padding: 8px 12px;
            background: #37415C;
            border-radius: 10px;
            display: inline-block;
        }
        .chat-footer {
            padding: 15px 20px;
            background: #181A2F;
            display: flex;
            align-items: center;
            gap: 10px;
            border-top: 1px solid #FDA481;
            position: sticky;
            bottom: 0;
            z-index: 10;
        }
        .chat-input {
            flex: 1;
            padding: 12px 18px;
            border: none;
            background: #242E49;
            color: #fff;
            border-radius: 25px;
            outline: none;
            font-size: 0.95em;
        }
        .chat-input::placeholder {
            color: #FDA481;
        }
        .send-button {
            width: 40px;
            height: 40px;
            border: none;
            background: #FDA481 url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgZmlsbD0iIzE4MUEyRiIgdmlld0JveD0iMCAwIDI0IDI0Ij48cGF0aCBkPSJNMTIgMTJjLTIuMjEgMC00LTEuNzktNC00cyAxLjc5LTQgNC00IDQgMS43OSA0IDQtMS43OSA0LTQtNHptLTMgM2MtLjU1IDAtMS0uNDUtMS0xcy40NS0xIDEtMXMxIC40NSAxIDEtLjQ1IDEtMSAxem0zIDBjLS41NSAwLTEtLjQ1LTEtMXMuNDUtMSAxLTFzMSAuNDUgMSAxLS40NSAxLTEgMXptMyAwYy0uNTUgMC0xLS40NS0xLTFzLjQ1LTEgMS0xczEgLjQ1IDEgMS0uNDUgMS0xIDF6bS0zLTdjLS41NSAwLTEtLjQ1LTEtMXMuNDUtMSAxLTFzMSAuNDUgMSAxLS40NSAxLTEgMXoiLz48L3N2Zz4=') no-repeat center;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }
        .send-button:hover {
            background: #B4182D url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgZmlsbD0iI2ZmZiIgdmlld0JveD0iMCAwIDI0IDI0Ij48cGF0aCBkPSJNMTIgMTJjLTIuMjEgMC00LTEuNzktNC00cyAxLjc5LTQgNC00IDQgMS43OSA0IDQtMS43OSA0LTQtNHptLTMgM2MtLjU1IDAtMS0uNDUtMS0xcy40NS0xIDEtMXMxIC40NSAxIDEtLjQ1IDEtMSAxem0zIDBjLS41NSAwLTEtLjQ1LTEtMXMuNDUtMSAxLTFzMSAuNDUgMSAxLS40NSAxLTEgMXptMyAwYy0uNTUgMC0xLS40NS0xLTFzLjQ1LTEgMS0xczEgLjQ1IDEgMS0uNDUgMS0xIDF6bS0zLTdjLS41NSAwLTEtLjQ1LTEtMXMuNDUtMSAxLTFzMSAuNDUgMSAxLS40NSAxLTEgMXoiLz48L3N2Zz4=') no-repeat center;
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        .bio-link {
            padding: 15px 20px;
            background: #181A2F;
            text-align: center;
            border-top: 1px solid #FDA481;
        }
        .bio-link a {
            display: inline-block;
            background: #242E49;
            color: #FDA481;
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .bio-link a:hover {
            background: #37415C;
            color: #fff;
            transform: scale(1.05);
        }
        .settings-modal {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #181A2F;
            border-radius: 20px;
            flex-direction: column;
            padding: 20px;
            box-sizing: border-box;
        }
        .settings-modal.show {
            display: flex;
        }
        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .settings-header h2 {
            font-size: 1.1em;
            font-weight: 500;
            margin: 0;
            color: #FDA481;
        }
        .close-settings {
            cursor: pointer;
            width: 24px;
            height: 24px;
            background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgZmlsbD0iI0ZEQTQ4MSIgdmlld0JveD0iMCAwIDI4IDI0Ij48cGF0aCBkPSJNMTguMyA1LjcxYy0uMzktLjM5LTEuMDItLjM5LTEuNDEgMGwtNC44OSA0Ljg5LTQuODktNC44OWMtLjM5LS4zES0xLjQxIDAtLjM5LjM5LS4zESAxLjAyIDAgMS40MWw0Ljg5IDQuODktNC44OSA0Ljg5Yy0uMzkuMzktLjM5IDEuMDIgMCAxLjQxLjM5LjM5IDEuMDIuMzkgMS40MSAwbDQuODktNC44OSA0Ljg5IDQuODljLjM5LjM5IDEuMDIuMzkgMS40MSAwIC4zES0uMzkuMzktMS4wMiAwLTEuNDFsLTQuODktNC44OSA0Ljg5LTQuODljLjM5LS4zES4zES0xLjAyIDAtMS40MXoiLz48L3N2Zz4=') no-repeat center;
        }
        .settings-body textarea {
            width: 100%;
            height: 200px;
            padding: 12px;
            border: 1px solid #FDA481;
            border-radius: 10px;
            resize: none;
            font-size: 0.95em;
            outline: none;
            background: #242E49;
            color: #fff;
        }
        .settings-footer {
            margin-top: 20px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        .settings-footer button {
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.95em;
        }
        .save-button {
            background: #FDA481;
            color: #181A2F;
        }
        .cancel-button {
            background: #242E49;
            color: #fff;
        }
        @media (max-width: 768px) {
            .chat-container {
                flex-direction: column;
                height: 100vh;
                border-radius: 0;
                padding-bottom: 80px;
            }
            .sidebar {
                width: 100%;
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: center;
                border-right: none;
                border-bottom: 1px solid #FDA481;
            }
            .sidebar a {
                flex: 1 1 45%;
                margin: 5px;
            }
            .chat-area {
                flex: 1;
                position: relative;
            }
            .chat-body {
                -webkit-overflow-scrolling: touch;
                height: calc(100vh - 220px);
                overflow-y: auto;
            }
            .chat-body::-webkit-scrollbar {
                width: 6px;
            }
            .chat-body::-webkit-scrollbar-track {
                background: #181A2F;
            }
            .chat-body::-webkit-scrollbar-thumb {
                background: #FDA481;
                border-radius: 10px;
                opacity: 0.5;
            }
            .chat-body::-webkit-scrollbar-thumb:hover {
                background: #B4182D;
            }
            .chat-footer {
                position: fixed;
                bottom: 0;
                width: 100%;
                padding: 10px 20px;
                background: #181A2F;
                border-top: 1px solid #FDA481;
            }
            .bio-link {
                padding: 10px;
            }
            .bio-link a {
                font-size: 0.85em;
                padding: 8px 15px;
            }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="sidebar">
            <a href="https://www.instagram.com/lorrainebotura/" target="_blank">INSTAGRAM</a>
            <a href="https://www.facebook.com/lorrainebotura" target="_blank">FACEBOOK</a>
            <a href="https://lorrainebotura.com.br/clinicasaojosedoscampos/" target="_blank">CL√çNICA S√ÉO JOS√â DOS CAMPOS</a>
            <a href="https://lorrainebotura.com.br/clinicacaraguatatuba/" target="_blank">CL√çNICA CARAGUATATUBA</a>
            <a href="https://wa.me/5512992061898?text=Ol√°,%20gostaria%20de%20agendar%20uma%20avalia√ß√£o%20na%20Cl√≠nica%20Lorraine%20Botura!" target="_blank">AGENDE SEU PROCEDIMENTO</a>
            <a href="https://www.google.com/search?kgmid=/g/11gpgszlsj&hl=pt-BR&q=Lorraine+Botura+Est%C3%A9tica&shndl=30&source=sh/x/loc/osrp/m5/1&kgs=719c6f2276454cec#" target="_blank">ME AVALIE NO GOOGLE</a>
        </div>
        <div class="chat-area">
            <div class="chat-header">
                <h1>Cl√≠nica Lorraine Botura</h1>
                <div class="settings-icon" onclick="openSettings()"></div>
            </div>
            <div class="chat-body" id="chatBody">
                <div class="message bot-message">Ol√°, seja bem-vindo(a) √† Cl√≠nica Lorraine Botura! üå∏ Para um atendimento mais personalizado, poderia me informar seu nome e telefone, por favor?</div>
            </div>
            <div class="chat-footer">
                <input type="text" class="chat-input" id="userInput" placeholder="Digite sua mensagem...">
                <button class="send-button" onclick="sendMessage()"></button>
            </div>
            <div class="bio-link">
                <a href="https://lorrainebotura.com.br/biografia/" target="_blank">Conhe√ßa mais sobre Lorraine Botura</a>
            </div>
        </div>
    </div>

    <div class="settings-modal" id="settingsModal">
        <div class="settings-header">
            <h2>Configura√ß√µes de Atendimento</h2>
            <div class="close-settings" onclick="closeSettings()"></div>
        </div>
        <div class="settings-body">
            <textarea id="agentPrompt"># üéÄ Prompt para Agente Virtual - Cl√≠nica de Est√©tica Lorraine Botura üéÄ

Voc√™ √© o agente virtual oficial da **Cl√≠nica de Est√©tica Lorraine Botura**.  
Seu objetivo √© **acolher, informar e orientar clientes** de maneira **atenciosa, elegante e eficiente**.  
Use sempre um **tom de voz gentil, acolhedor, confiante e emp√°tico**, transmitindo o **carinho** e a **excel√™ncia** da cl√≠nica.

---

## üõéÔ∏è Suas Fun√ß√µes:

- Recepcionar clientes com **sauda√ß√£o calorosa**.
- Coletar **informa√ß√µes b√°sicas** de forma delicada (nome, telefone, e-mail).
- Esclarecer d√∫vidas sobre:
  - Procedimentos est√©ticos oferecidos.
  - Benef√≠cios, diferenciais e indica√ß√µes dos tratamentos.
  - Dura√ß√£o, recomenda√ß√µes pr√© e p√≥s-procedimento.
  - Promo√ß√µes ou pacotes dispon√≠veis.
- Informar que os **valores** s√£o personalizados e o or√ßamento ser√° enviado via **WhatsApp**.
- Fornecer **endere√ßo, hor√°rio de funcionamento e formas de pagamento** aceitas.
- **Agendar avalia√ß√µes** ou sess√µes.
- Encaminhar o contato para o **atendimento humano** (quando necess√°rio, especialmente para d√∫vidas m√©dicas).

---

## üó£Ô∏è Tom de Voz:

- Elegante, acolhedor, emp√°tico e motivador.
- Sempre use palavras **positivas e reconfortantes**.
- Evite termos t√©cnicos complicados (ou explique de forma simples).
- Reforce que **cada atendimento √© √∫nico e personalizado**.

---

## ‚ú® Frases √öteis:

- "Ol√°, seja muito bem-vindo(a) √† Cl√≠nica Lorraine Botura! üå∏ Para iniciar seu atendimento, poderia me informar seu nome e telefone, por favor?"
- "Ficamos felizes em saber que voc√™ busca real√ßar ainda mais sua beleza! Me conte, qual procedimento desperta seu interesse?"
- "Nossos hor√°rios s√£o flex√≠veis para se encaixar na sua rotina. Vamos agendar sua avalia√ß√£o gratuita?"
- "Todos os nossos procedimentos s√£o realizados por profissionais altamente qualificados, com todo carinho e responsabilidade que voc√™ merece."
- "Sua beleza √© √∫nica, e nossos tratamentos tamb√©m! Para valores e pacotes especiais, nossa equipe entrar√° em contato pelo WhatsApp."
- "Caso tenha alguma condi√ß√£o de sa√∫de espec√≠fica, orientamos uma breve avalia√ß√£o inicial para garantir o melhor cuidado."

---

## üå∏ Procedimentos que voc√™ pode citar:

- Harmoniza√ß√£o facial
- Botox
- Preenchimento labial
- Microagulhamento
- Limpeza de pele profunda
- Depila√ß√£o a laser
- Tratamentos para estrias e celulite
- Remodelagem corporal
- Peeling qu√≠mico
- Hidragloss labial

*(Adapte conforme os servi√ßos reais da cl√≠nica)*

---

## üö´ Restri√ß√µes Importantes:

- Nunca fazer diagn√≥sticos.
- Nunca prometer resultados sem avalia√ß√£o presencial.
- N√£o prescrever produtos ou medicamentos.
- N√£o informar valores diretamente; sempre redirecionar ao atendimento humano via WhatsApp.

---

## üìç Informa√ß√µes da Cl√≠nica:

- **Endere√ßo:** Av. Andr√¥meda, 3808 - sala 1 - Bosque dos Eucaliptos, S√£o Jos√© dos Campos - SP, 12233-380
- **Telefone/WhatsApp:** (12) 99206-1898
- **Hor√°rio de funcionamento:** 
  - Fechado atualmente.
  - Aberto √†s ter√ßas-feiras a partir das 11:00h.

---

## üìã Exemplos de Atendimento:

### üéØ Agendamento:
"Que maravilhoso saber que voc√™ se interessou pela harmoniza√ß√£o facial! Para te atender com todo cuidado, posso agendar uma avalia√ß√£o sem compromisso. Qual seria o melhor dia e hor√°rio para voc√™?"

### üåø D√∫vidas sobre Procedimentos:
"A limpeza de pele profunda √© perfeita para revitalizar sua pele! Ela inclui extra√ß√£o, hidrata√ß√£o e m√°scara calmante. Recomenda-se realizar a cada 30 a 45 dias, dependendo do seu tipo de pele."

### üéÅ Promo√ß√µes:
"Neste m√™s, estamos com condi√ß√µes especiais para tratamentos corporais! Posso enviar todos os detalhes para voc√™ no WhatsApp, tudo bem?"

---

## üåü Extras que voc√™ pode adicionar no futuro:

- Roteiros prontos para cada procedimento.
- Fluxo de agendamento autom√°tico.
- Mensagens especiais de boas-vindas e p√≥s-atendimento.

---

**Pronto! Agora o agente virtual da Cl√≠nica Lorraine Botura est√° completo, profissional e acolhedor.**  
üå∏‚ú®</textarea>
        </div>
        <div class="settings-footer">
            <button class="cancel-button" onclick="closeSettings()">Cancelar</button>
            <button class="save-button" onclick="saveAgentPrompt()">Salvar</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Configura√ß√£o do Supabase
        const SUPABASE_URL = 'https://wrsjjnlpwwtrwekjhjcy.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indyc2pqbmxwd3d0cndla2poamN5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQ4MDY5MjcsImV4cCI6MjA2MDM4MjkyN30.5hjlREAHW6Zd-PKTB3eGuKSbJFHSW5s8OCGd_jr-f4o';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Configura√ß√£o da Gemini API
        const GEMINI_API_KEY = 'AIzaSyBsWK-qUzEts9UjoVP2wDmDLBKpfR4kMtQ';
        const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent';

        // N√∫mero do WhatsApp da cl√≠nica
        const WHATSAPP_NUMBER = '5512992061898';

        // Estado da conversa
        let userData = { name: null, phone: null, protocol: null };
        let chatHistory = [];
        let isFirstMessage = true;

        // Fun√ß√£o para validar o nome (n√£o aceitar "oi", "ol√°", etc.)
        function validateName(name) {
            const invalidNames = [
                'oi', 'ol√°', 'bom dia', 'boa tarde', 'boa noite', 'ola', 'oi tudo bem',
                'tudo bem', 'oi como vai', 'oi tudo ok', 'oi boa tarde', 'oi bom dia'
            ];
            const lowerName = name.toLowerCase().trim();
            if (invalidNames.includes(lowerName)) return false;
            return name.length > 3 || name.split(' ').length >= 2;
        }

        // Fun√ß√£o para gerar protocolo √∫nico (YYYYMMDD-HHMMSS-XXXX)
        function generateProtocol() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            const random = String(Math.floor(1000 + Math.random() * 9000));
            return `${year}${month}${day}-${hours}${minutes}${seconds}-${random}`;
        }

        // Fun√ß√£o para salvar a conversa no Supabase
        async function saveConversation() {
            try {
                const { error } = await supabase
                    .from('conversations')
                    .insert({
                        protocol: userData.protocol,
                        name: userData.name,
                        phone: userData.phone,
                        chat_history: chatHistory,
                        created_at: new Date().toISOString()
                    });

                if (error) {
                    console.error('Erro ao salvar conversa no Supabase:', error.message);
                    addMessage('‚ö†Ô∏è N√£o foi poss√≠vel salvar a conversa no banco de dados. Por favor, informe ao administrador que a tabela "conversations" precisa ser criada no Supabase.', false);
                    throw error;
                }
            } catch (error) {
                console.error('Erro ao salvar conversa:', error.message);
                addMessage('‚ö†Ô∏è N√£o foi poss√≠vel salvar a conversa no banco de dados. Por favor, informe ao administrador que a tabela "conversations" precisa ser criada no Supabase.', false);
            }
        }

        // Fun√ß√£o para gerar o link do WhatsApp com a d√∫vida do usu√°rio e protocolo
        function generateWhatsAppLink(message, isScheduling = false) {
            const encodedMessage = encodeURIComponent(
                isScheduling 
                    ? `Ol√°, gostaria de agendar uma avalia√ß√£o na Cl√≠nica Lorraine Botura! Protocolo de Atendimento: ${userData.protocol}`
                    : `Ol√°, tenho uma d√∫vida: ${message} - Protocolo de Atendimento: ${userData.protocol}`
            );
            return `https://wa.me/${WHATSAPP_NUMBER}?text=${encodedMessage}`;
        }

        // Fun√ß√£o para adicionar mensagem ao chat e ao hist√≥rico
        function addMessage(content, isUser) {
            const chatBody = document.getElementById('chatBody');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`;
            messageDiv.innerHTML = content;
            chatBody.appendChild(messageDiv);

            // Rolagem autom√°tica suave
            chatBody.scrollTo({
                top: chatBody.scrollHeight,
                behavior: 'smooth'
            });

            // Adicionar ao hist√≥rico
            chatHistory.push({ sender: isUser ? 'user' : 'bot', message: content, timestamp: new Date().toISOString() });
        }

        // Fun√ß√£o para verificar palavras-chave
        function checkKeywords(message) {
            const lowerMessage = message.toLowerCase().trim();
            const keywords = {
                procedures: ['procedimentos', 'tratamentos', 'servi√ßos', 'o que voc√™s oferecem'],
                specificTreatment: [
                    'harmoniza√ß√£o', 'botox', 'preenchimento', 'microagulhamento', 'limpeza de pele',
                    'depila√ß√£o', 'estrias', 'celulite', 'remodelagem', 'peeling', 'hidragloss'
                ],
                scheduling: ['agendar', 'marcar', 'consulta', 'avalia√ß√£o', 'hor√°rio', 'sess√£o', 'quero agendar', 'posso agendar'],
                hours: ['hor√°rio', 'funcionamento', 'aberto', 'fecha', 'atendimento'],
                location: ['endere√ßo', 'onde fica', 'localiza√ß√£o', 'como chegar'],
                promotions: ['promo√ß√£o', 'desconto', 'pacotes', 'ofertas']
            };

            if (keywords.procedures.some(keyword => lowerMessage.includes(keyword))) {
                return 'procedures';
            }
            if (keywords.scheduling.some(keyword => lowerMessage.includes(keyword))) {
                return 'scheduling';
            }
            if (keywords.hours.some(keyword => lowerMessage.includes(keyword))) {
                return 'hours';
            }
            if (keywords.location.some(keyword => lowerMessage.includes(keyword))) {
                return 'location';
            }
            if (keywords.promotions.some(keyword => lowerMessage.includes(keyword))) {
                return 'promotions';
            }
            for (const keyword of keywords.specificTreatment) {
                if (lowerMessage.includes(keyword)) {
                    return `treatment_${keyword}`;
                }
            }
            return null;
        }

        // Fun√ß√£o para verificar se a mensagem pergunta sobre um tratamento espec√≠fico
        function getSpecificTreatment(message) {
            const treatments = {
                'harmoniza√ß√£o facial': 'harmoniza√ß√£o',
                'botox': 'botox',
                'preenchimento labial': 'preenchimento',
                'microagulhamento': 'microagulhamento',
                'limpeza de pele': 'limpeza de pele',
                'depila√ß√£o a laser': 'depila√ß√£o',
                'estrias e celulite': 'estrias',
                'remodelagem corporal': 'remodelagem',
                'peeling qu√≠mico': 'peeling',
                'hidragloss labial': 'hidragloss'
            };
            const lowerMessage = message.toLowerCase();
            for (const [treatment, keyword] of Object.entries(treatments)) {
                if (lowerMessage.includes(keyword)) {
                    return treatment;
                }
            }
            return null;
        }

        // Fun√ß√£o para formatar resposta sobre procedimentos gerais
        function formatProceduresResponse() {
            return `
                Aqui est√£o os procedimentos que oferecemos para real√ßar sua beleza! üå∏ Confira abaixo:

                <ul>
                    <li><strong>Harmoniza√ß√£o Facial:</strong> Real√ßa os tra√ßos do rosto com equil√≠brio e naturalidade.</li>
                    <li><strong>Botox:</strong> Reduz linhas de express√£o para uma apar√™ncia rejuvenescida.</li>
                    <li><strong>Preenchimento Labial:</strong> D√° volume e contorno aos l√°bios de forma personalizada.</li>
                    <li><strong>Microagulhamento:</strong> Estimula o col√°geno para uma pele mais firme e renovada.</li>
                    <li><strong>Limpeza de Pele Profunda:</strong> Remove impurezas e revitaliza a pele.</li>
                    <li><strong>Depila√ß√£o a Laser:</strong> Solu√ß√£o duradoura para remo√ß√£o de pelos.</li>
                    <li><strong>Tratamentos para Estrias e Celulite:</strong> Melhora a textura da pele com t√©cnicas avan√ßadas.</li>
                    <li><strong>Remodelagem Corporal:</strong> Modela o corpo com seguran√ßa e efic√°cia.</li>
                    <li><strong>Peeling Qu√≠mico:</strong> Renova a pele, tratando manchas e imperfei√ß√µes.</li>
                    <li><strong>Hidragloss Labial:</strong> Hidrata e d√° brilho aos l√°bios com efeito natural.</li>
                </ul>

                Qual desses desperta seu interesse? Posso te ajudar com mais detalhes!
            `;
        }

        // Fun√ß√£o para formatar detalhes de um tratamento espec√≠fico
        function formatSpecificTreatmentResponse(treatment) {
            const treatmentsDetails = {
                'harmoniza√ß√£o facial': {
                    description: 'A Harmoniza√ß√£o Facial real√ßa os tra√ßos do rosto com equil√≠brio e naturalidade, utilizando t√©cnicas como preenchimento e botox para harmonizar propor√ß√µes.',
                    benefits: 'Resultados naturais, rejuvenescimento e simetria facial.',
                    duration: 'Cerca de 1 hora, com resultados vis√≠veis imediatamente.'
                },
                'botox': {
                    description: 'O Botox reduz linhas de express√£o e rugas, relaxando os m√∫sculos faciais de forma segura e eficaz.',
                    benefits: 'Pele mais lisa, apar√™ncia rejuvenescida e preven√ß√£o de novas rugas.',
                    duration: 'A aplica√ß√£o leva cerca de 20 minutos, com resultados vis√≠veis em 3 a 7 dias.'
                },
                'preenchimento labial': {
                    description: 'O Preenchimento Labial d√° volume e contorno aos l√°bios com √°cido hialur√¥nico, de forma personalizada para um resultado natural.',
                    benefits: 'L√°bios mais definidos, hidratados e com apar√™ncia rejuvenescida.',
                    duration: 'Aproximadamente 30 minutos, com resultados imediatos.'
                },
                'microagulhamento': {
                    description: 'O Microagulhamento estimula a produ√ß√£o de col√°geno com microagulhas, promovendo a renova√ß√£o da pele.',
                    benefits: 'Melhora de textura, redu√ß√£o de cicatrizes de acne e rejuvenescimento.',
                    duration: 'Cerca de 1 hora, com recomenda√ß√£o de 3 a 4 sess√µes.'
                },
                'limpeza de pele': {
                    description: 'A Limpeza de Pele Profunda remove impurezas, cravos e c√©lulas mortas, revitalizando a pele com hidrata√ß√£o e m√°scaras calmantes.',
                    benefits: 'Pele mais limpa, hidratada e com poros menos vis√≠veis.',
                    duration: 'Dura cerca de 1 hora, recomendada a cada 30 a 45 dias.'
                },
                'depila√ß√£o a laser': {
                    description: 'A Depila√ß√£o a Laser elimina os pelos de forma duradoura, utilizando tecnologia que destr√≥i o fol√≠culo piloso.',
                    benefits: 'Redu√ß√£o de pelos, pele mais suave e menos irrita√ß√£o.',
                    duration: 'Depende da √°rea, mas geralmente 15 a 45 minutos por sess√£o.'
                },
                'estrias e celulite': {
                    description: 'Os Tratamentos para Estrias e Celulite utilizam tecnologias avan√ßadas para melhorar a textura da pele e reduzir imperfei√ß√µes.',
                    benefits: 'Pele mais uniforme, redu√ß√£o de estrias e celulite vis√≠vel.',
                    duration: 'Cerca de 1 hora por sess√£o, com pacotes de 5 a 10 sess√µes.'
                },
                'remodelagem corporal': {
                    description: 'A Remodelagem Corporal modela o corpo com t√©cnicas n√£o invasivas, reduzindo gordura localizada e melhorando o contorno.',
                    benefits: 'Corpo mais definido, redu√ß√£o de medidas e melhora da autoestima.',
                    duration: 'Aproximadamente 1 hora por sess√£o, com pacotes personalizados.'
                },
                'peeling qu√≠mico': {
                    description: 'O Peeling Qu√≠mico renova a pele com a aplica√ß√£o de √°cidos, tratando manchas, acne e sinais de envelhecimento.',
                    benefits: 'Pele mais clara, redu√ß√£o de manchas e textura mais lisa.',
                    duration: 'Cerca de 30 minutos, com 3 a 5 sess√µes recomendadas.'
                },
                'hidragloss labial': {
                    description: 'O Hidragloss Labial hidrata profundamente os l√°bios com √°cido hialur√¥nico, proporcionando brilho e efeito natural.',
                    benefits: 'L√°bios hidratados, com brilho natural e apar√™ncia saud√°vel.',
                    duration: 'Aproximadamente 20 minutos, com resultados imediatos.'
                }
            };

            const details = treatmentsDetails[treatment];
            const link = generateWhatsAppLink('', true);
            return `
                <strong>${treatment.toUpperCase()}</strong><br>
                <strong>Descri√ß√£o:</strong> ${details.description}<br>
                <strong>Benef√≠cios:</strong> ${details.benefits}<br>
                <strong>Dura√ß√£o:</strong> ${details.duration}<br>
                <div class="sub-message">Gostaria de agendar uma avalia√ß√£o para este procedimento? <a href="${link}" target="_blank">Clique aqui para agendar via WhatsApp</a></div>
            `;
        }

        // Fun√ß√£o para formatar resposta sobre hor√°rios
        function formatHoursResponse() {
            return `
                Aqui est√£o os detalhes do nosso hor√°rio de funcionamento:

                <ul>
                    <li><strong>Atualmente:</strong> Fechado.</li>
                    <li><strong>Ter√ßas-feiras:</strong> Aberto a partir das 11:00h.</li>
                </ul>

                Gostaria de agendar uma avalia√ß√£o para a pr√≥xima ter√ßa-feira?
            `;
        }

        // Fun√ß√£o para formatar resposta sobre localiza√ß√£o
        function formatLocationResponse() {
            return `
                Estamos localizados em:

                <ul>
                    <li><strong>Endere√ßo:</strong> Av. Andr√¥meda, 3808 - sala 1 - Bosque dos Eucaliptos, S√£o Jos√© dos Campos - SP, 12233-380</li>
                    <li><strong>Telefone/WhatsApp:</strong> (12) 99206-1898</li>
                </ul>

                Ficaremos felizes em receber voc√™! Deseja agendar uma visita?
            `;
        }

        // Fun√ß√£o para formatar resposta sobre promo√ß√µes
        function formatPromotionsResponse() {
            const link = generateWhatsAppLink('Gostaria de saber mais sobre as promo√ß√µes dispon√≠veis.', false);
            return `
                Neste m√™s, estamos com condi√ß√µes especiais para diversos tratamentos! Para mais detalhes sobre nossas promo√ß√µes, clique no link abaixo e nossa equipe ir√° te atender com todo carinho:

                <a href="${link}" target="_blank">Saiba mais via WhatsApp</a>
            `;
        }

        // Fun√ß√£o para formatar resposta de agendamento
        function formatSchedulingResponse() {
            const link = generateWhatsAppLink('', true);
            return `
                Que √≥timo saber do seu interesse! Para agendar sua avalia√ß√£o com todo o cuidado, clique no link abaixo e escolha o melhor dia e hor√°rio com nossa equipe:

                <a href="${link}" target="_blank">Agendar via WhatsApp</a>
            `;
        }

        // Fun√ß√£o para chamar a Gemini API
        async function callGeminiAPI(prompt, agentPrompt = '') {
            try {
                const response = await fetch(`${GEMINI_API_URL}?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: agentPrompt ? `${agentPrompt}\n\nUsu√°rio: ${prompt}` : prompt
                            }]
                        }]
                    })
                });

                if (!response.ok) {
                    throw new Error('Erro na chamada da API');
                }

                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error('Erro:', error);
                return 'Desculpe, houve um erro ao processar sua solicita√ß√£o. Tente novamente mais tarde.';
            }
        }

        // Fun√ß√£o para validar telefone (formato simples)
        function validatePhone(phone) {
            const phoneRegex = /^\d{10,11}$/;
            return phoneRegex.test(phone);
        }

        // Fun√ß√£o para verificar se a resposta √© insatisfat√≥ria
        function isUnsatisfactoryResponse(response) {
            const genericResponses = [
                'desculpe, n√£o sei responder isso',
                'n√£o sei',
                'n√£o tenho essa informa√ß√£o',
                'desculpe, n√£o entendi'
            ];
            const lowerResponse = response.toLowerCase();
            return response.length < 20 || genericResponses.some(phrase => lowerResponse.includes(phrase));
        }

        // Fun√ß√£o para enviar mensagem
        async function sendMessage() {
            const userInput = document.getElementById('userInput');
            const message = userInput.value.trim();

            if (message === '') return;

            // Adiciona mensagem do usu√°rio ao chat e ao hist√≥rico
            addMessage(message, true);
            userInput.value = '';

            // Primeira mensagem: coletar nome
            if (isFirstMessage) {
                if (!validateName(message)) {
                    addMessage('Por favor, informe um nome v√°lido (exemplo: Maria Silva). N√£o posso aceitar sauda√ß√µes como "oi" ou "ol√°".', false);
                    return;
                }
                userData.name = message;
                addMessage('Obrigada por informar seu nome! Agora, poderia me passar seu telefone, por favor? (Exemplo: 11987654321)', false);
                isFirstMessage = false;
                return;
            }

            // Segunda mensagem: coletar telefone e gerar protocolo
            if (!userData.phone) {
                if (!validatePhone(message)) {
                    addMessage('Por favor, informe um telefone v√°lido (apenas n√∫meros, 10 ou 11 d√≠gitos). Exemplo: 11987654321', false);
                    return;
                }
                userData.phone = message;
                userData.protocol = generateProtocol();
                addMessage(`Perfeito, ${userData.name}! Seu protocolo de atendimento √©: <strong>${userData.protocol}</strong>. Como posso ajudar voc√™ hoje?`, false);
                await saveConversation();
                return;
            }

            // Verifica palavras-chave para respostas espec√≠ficas
            const keywordMatch = checkKeywords(message);
            if (keywordMatch) {
                if (keywordMatch === 'procedures') {
                    addMessage(formatProceduresResponse(), false);
                    await saveConversation();
                    return;
                }
                if (keywordMatch === 'scheduling') {
                    addMessage(formatSchedulingResponse(), false);
                    await saveConversation();
                    return;
                }
                if (keywordMatch === 'hours') {
                    addMessage(formatHoursResponse(), false);
                    await saveConversation();
                    return;
                }
                if (keywordMatch === 'location') {
                    addMessage(formatLocationResponse(), false);
                    await saveConversation();
                    return;
                }
                if (keywordMatch === 'promotions') {
                    addMessage(formatPromotionsResponse(), false);
                    await saveConversation();
                    return;
                }
                if (keywordMatch.startsWith('treatment_')) {
                    const specificTreatment = getSpecificTreatment(message);
                    if (specificTreatment) {
                        addMessage(formatSpecificTreatmentResponse(specificTreatment), false);
                        await saveConversation();
                        return;
                    }
                }
            }

            // Obt√©m o prompt do agente do Supabase
            let agentPrompt = '';
            try {
                const { data, error } = await supabase
                    .from('agent_prompts')
                    .select('prompt')
                    .eq('id', 1)
                    .single();

                if (error) {
                    console.error('Erro ao buscar prompt:', error.message);
                    throw error;
                }
                agentPrompt = data?.prompt || document.getElementById('agentPrompt').value;
            } catch (error) {
                console.error('Erro ao buscar prompt:', error.message);
                agentPrompt = document.getElementById('agentPrompt').value;
                addMessage('‚ö†Ô∏è N√£o foi poss√≠vel conectar ao banco de dados para carregar o prompt. Usando o prompt padr√£o.', false);
            }

            // Chama a Gemini API para obter resposta
            const botResponse = await callGeminiAPI(message, agentPrompt);

            // Verifica se a resposta √© insatisfat√≥ria
            if (isUnsatisfactoryResponse(botResponse)) {
                const vipResponse = `Estamos direcionando voc√™ para um atendimento VIP. Seu protocolo √©: <strong>${userData.protocol}</strong>. Clique aqui para continuar no WhatsApp: <a href="${generateWhatsAppLink(message)}" target="_blank">Atendimento VIP</a>`;
                addMessage(vipResponse, false);
                await saveConversation();
            } else {
                addMessage(botResponse, false);
                await saveConversation();
            }
        }

        // Fun√ß√£o para abrir o modal de configura√ß√µes
        function openSettings() {
            const modal = document.getElementById('settingsModal');
            modal.classList.add('show');

            // Carrega o prompt atual do Supabase
            supabase
                .from('agent_prompts')
                .select('prompt')
                .eq('id', 1)
                .single()
                .then(({ data, error }) => {
                    if (data) {
                        document.getElementById('agentPrompt').value = data.prompt || document.getElementById('agentPrompt').value;
                    } else if (error) {
                        console.error('Erro ao carregar prompt:', error.message);
                    }
                })
                .catch(error => {
                    console.error('Erro ao carregar prompt:', error.message);
                });
        }

        // Fun√ß√£o para fechar o modal de configura√ß√µes
        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('show');
        }

        // Fun√ß√£o para salvar o prompt do agente
        async function saveAgentPrompt() {
            const prompt = document.getElementById('agentPrompt').value;

            try {
                const { data, error } = await supabase
                    .from('agent_prompts')
                    .upsert({ id: 1, prompt })
                    .select();

                if (error) {
                    console.error('Erro ao salvar prompt:', error.message);
                    throw error;
                }
                alert('Prompt salvo com sucesso!');
                closeSettings();
            } catch (error) {
                console.error('Erro ao salvar o prompt:', error.message);
                alert('Erro ao salvar o prompt. Verifique se a tabela "agent_prompts" foi criada no Supabase.');
            }
        }

        // Enviar mensagem ao pressionar Enter
        document.getElementById('userInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
</body>
</html>
