<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chat Cl√≠nica Lorraine Botura - Atendimento Inteligente</title> <!-- Novo T√≠tulo -->
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400..700;1,400..700&family=Playfair+Display:ital,wght@0,400..900;1,400..900&display=swap" rel="stylesheet">
    <style>
        /* Reset e Base Styles */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { height: 100%; }
        body { min-height: 100%; display: flex; flex-direction: column; font-family: 'Lora', serif; background: linear-gradient(135deg, #F5E6E8, #D3A7B0); color: #54162B; line-height: 1.6; overflow-x: hidden; }

        /* Container Principal */
        .main-content { flex: 1; display: flex; justify-content: center; align-items: center; padding: 20px 15px; width: 100%; }

        /* Chat Container */
        .chat-container { width: 100%; max-width: 750px; background: #FFFFFF; border-radius: 15px; box-shadow: 0 10px 35px rgba(84, 22, 43, 0.2); display: flex; flex-direction: column; height: 85vh; max-height: 700px; overflow: hidden; border: 1px solid #D3A7B0; }

        /* Chat Header */
        .chat-header { padding: 18px 25px; background: #F5E6E8; border-bottom: 1px solid #D3A7B0; display: flex; justify-content: space-between; /* Mantido para alinhar t√≠tulo */ align-items: center; flex-shrink: 0; }
        .chat-header h1 { font-family: 'Playfair Display', serif; font-size: 1.6em; font-weight: 600; color: #54162B; margin: 0; /* T√≠tulo ocupa espa√ßo */ }
        /* Settings Icon removido do CSS */

        /* Chat Body */
        .chat-body { flex: 1; padding: 25px; overflow-y: auto; background: #FFFFFF; scroll-behavior: smooth; scrollbar-width: thin; scrollbar-color: #D3A7B0 #F5E6E8; }
        .chat-body::-webkit-scrollbar { width: 8px; }
        .chat-body::-webkit-scrollbar-track { background: #F5E6E8; border-radius: 10px; }
        .chat-body::-webkit-scrollbar-thumb { background-color: #D3A7B0; border-radius: 10px; border: 2px solid #F5E6E8; }
        .chat-body::-webkit-scrollbar-thumb:hover { background-color: #B4182D; }

        /* Mensagens */
        .message { margin-bottom: 18px; padding: 14px 20px; border-radius: 18px; max-width: 85%; line-height: 1.5; box-shadow: 0 3px 5px rgba(84, 22, 43, 0.08); word-wrap: break-word; clear: both; }
        .user-message { background: #D3A7B0; color: #FFFFFF; margin-left: auto; border-bottom-right-radius: 5px; float: right; }
        .bot-message { background: #F5E6E8; color: #54162B; margin-right: auto; border-bottom-left-radius: 5px; float: left; padding-bottom: 5px; }
        .bot-message.thinking { font-style: italic; opacity: 0.8; background: #e9dde0; padding-bottom: 14px; }
        .bot-message strong { color: #B4182D; font-weight: 600; }
        .bot-message a { color: #B4182D; text-decoration: none; font-weight: 600; border-bottom: 1px solid #d89eaa; transition: color 0.3s ease, border-bottom-color 0.3s ease; }
        .bot-message a:hover { color: #54162B; border-bottom-color: #54162B; }
        .bot-message ul { list-style-position: outside; padding-left: 25px; margin-top: 8px; margin-bottom: 5px; }
        .bot-message li { margin-bottom: 6px; }
        .sub-message { font-size: 0.9em; margin-top: 10px; padding: 8px 12px; background: rgba(211, 167, 176, 0.2); border-radius: 10px; display: inline-block; border: 1px solid rgba(211, 167, 176, 0.5); }

        /* Bot√µes de Op√ß√£o */
        .options-container { margin-top: 15px; padding-top: 10px; border-top: 1px dashed rgba(84, 22, 43, 0.1); display: flex; flex-direction: column; gap: 8px; }
        .option-button { display: block; width: 100%; padding: 10px 15px; background-color: #FFFFFF; color: #54162B; border: 1px solid #D3A7B0; border-radius: 8px; text-align: left; font-family: 'Lora', serif; font-size: 0.95em; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 4px rgba(84, 22, 43, 0.06); }
        .option-button:hover { background-color: #D3A7B0; color: #FFFFFF; border-color: #B4182D; transform: translateY(-1px); box-shadow: 0 4px 8px rgba(84, 22, 43, 0.1); }
        .option-button:disabled { background-color: #f0eaea; color: #a09396; border-color: #e0d0d4; cursor: not-allowed; box-shadow: none; transform: none; }
        .option-button .option-letter { font-weight: 700; margin-right: 8px; color: #B4182D; display: inline-block; min-width: 15px; }
        .option-button:hover .option-letter { color: #FFFFFF; }
        .option-button:disabled .option-letter { color: #a09396; }

        /* Chat Footer */
        .chat-footer { padding: 15px 25px; background: #F5E6E8; display: flex; align-items: center; gap: 12px; border-top: 1px solid #D3A7B0; flex-shrink: 0; }
        .chat-input { flex: 1; padding: 14px 22px; border: 1px solid #D3A7B0; background: #FFFFFF; color: #54162B; border-radius: 25px; outline: none; font-size: 1.05em; font-family: 'Lora', serif; resize: none; transition: border-color 0.3s ease, box-shadow 0.3s ease; }
        .chat-input:focus { border-color: #B4182D; box-shadow: 0 0 0 3px rgba(180, 24, 45, 0.15); }
        .chat-input::placeholder { color: #b18c94; opacity: 0.9; }
        .send-button { width: 48px; height: 48px; border: none; background: #B4182D url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgZmlsbD0iI2ZmZiIgdmlld0JveD0iMCAwIDI0IDI0Ij48cGF0aCBkPSJNM i4wMSAyMSAyMyAxMiAyLjAxIDMgMiAxMGwŸ°NSAyLTggMnpNMCAwaDI0djI0SDB6IiBmaWxsPSJub25lIi8+PHBhdGggZD0iTTIuMDEgM0wyMyAxMiAyLjAxIDIxIDIgMTBsMTUtMi0xNS0yeiIvPjwvc3ZnPg==') no-repeat center; background-size: 50%; border-radius: 50%; cursor: pointer; transition: background-color 0.3s ease, transform 0.2s ease; box-shadow: 0 4px 10px rgba(180, 24, 45, 0.2); flex-shrink: 0; }
        .send-button:hover { background-color: #54162B; transform: scale(1.05); }
        .send-button:active { transform: scale(0.95); }

        /* Rodap√© Minimalista */
        .page-footer { flex-shrink: 0; width: 100%; padding: 15px 20px; background-color: #F5E6E8; border-top: 1px solid #D3A7B0; text-align: center; margin-top: auto; }
        .social-icons { display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 10px; }
        .social-icons a { display: inline-flex; justify-content: center; align-items: center; width: 36px; height: 36px; background-color: rgba(211, 167, 176, 0.3); border-radius: 50%; transition: background-color 0.3s ease, transform 0.3s ease; border: 1px solid transparent; }
        .social-icons a svg { width: 18px; height: 18px; fill: #54162B; transition: fill 0.3s ease; }
        .social-icons a:hover { background-color: #D3A7B0; transform: translateY(-2px); border: 1px solid #B4182D; }
        .social-icons a:hover svg { fill: #FFFFFF; }
        .footer-text { font-size: 0.8em; color: #54162B; opacity: 0.8; }
        .footer-text a { color: #B4182D; text-decoration: none; font-weight: 600; }
        .footer-text a:hover { text-decoration: underline; }

        /* Modal Settings Removido */

        /* Responsividade */
        @media (max-width: 768px) {
            .main-content { padding: 10px; align-items: flex-start; padding-top: 10px; }
            .chat-container { height: calc(100vh - 90px); max-height: none; border-radius: 10px; }
            .chat-header h1 { font-size: 1.3em; }
            .chat-body { padding: 15px; }
            .message { max-width: 90%; padding: 10px 15px; margin-bottom: 15px;} /* Ajuste max-width */
            .chat-footer { padding: 10px 15px; gap: 10px;}
            .chat-input { padding: 12px 18px; font-size: 1em; }
            .send-button { width: 42px; height: 42px; }
            .page-footer { padding: 12px 15px; }
            .social-icons { gap: 15px; margin-bottom: 8px; }
            .social-icons a { width: 32px; height: 32px; }
            .social-icons a svg { width: 16px; height: 16px; }
            .footer-text { font-size: 0.75em; }
            .option-button { padding: 8px 12px; font-size: 0.9em;}
        }
         @media (max-width: 480px) {
             .main-content { padding: 5px; padding-top: 5px; }
             .chat-container { height: calc(100vh - 75px); border-radius: 5px;}
             .chat-header h1 { font-size: 1.1em; }
             .chat-header { padding: 12px 15px;}
             .chat-body { padding: 10px; }
             .message { max-width: 95%; }
             .chat-footer { padding: 8px 10px; gap: 8px; }
             .chat-input { padding: 10px 15px; font-size: 0.95em; }
             .send-button { width: 38px; height: 38px; }
             .page-footer { padding: 10px; }
             .social-icons { gap: 12px; }
             .footer-text { font-size: 0.7em; }
             .option-button { font-size: 0.85em;}
         }
    </style>
</head>
<body>

    <!-- Conte√∫do Principal -->
    <div class="main-content">
        <!-- Chat Container -->
        <div class="chat-container">
            <div class="chat-header">
                <h1>Cl√≠nica Lorraine Botura</h1>
                <!-- √çcone de Configura√ß√µes Removido -->
            </div>
            <div class="chat-body" id="chatBody">
                <div class="message bot-message thinking" style="display: none;">Processando sua solicita√ß√£o... ‚ú®</div>
            </div>
            <div class="chat-footer">
                <input type="text" class="chat-input" id="userInput" placeholder="Digite sua d√∫vida ou escolha uma op√ß√£o..." aria-label="Campo de mensagem">
                <button class="send-button" onclick="sendMessage()" aria-label="Enviar mensagem"></button>
            </div>
        </div>
    </div>

    <!-- Rodap√© -->
    <footer class="page-footer">
        <div class="social-icons">
            <a href="https://www.instagram.com/lorrainebotura/" target="_blank" aria-label="Instagram"> <svg viewBox="0 0 24 24"><path d="M7.8,2H16.2C19.4,2 22,4.6 22,7.8V16.2C22,19.4 19.4,22 16.2,22H7.8C4.6,22 2,19.4 2,16.2V7.8C2,4.6 4.6,2 7.8,2M7.6,4A3.6,3.6 0 0,0 4,7.6V16.4C4,18.39 5.61,20 7.6,20H16.4C18.39,20 20,18.39 20,16.4V7.6C20,5.61 18.39,4 16.4,4H7.6M17.25,5.5A1.25,1.25 0 0,1 18.5,6.75A1.25,1.25 0 0,1 17.25,8A1.25,1.25 0 0,1 16,6.75A1.25,1.25 0 0,1 17.25,5.5M12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9Z"/></svg> </a>
            <a href="https://www.facebook.com/lorrainebotura" target="_blank" aria-label="Facebook"> <svg viewBox="0 0 24 24"><path d="M12 2.04C6.5 2.04 2 6.53 2 12.06C2 17.06 5.66 21.21 10.44 21.96V14.96H7.9V12.06H10.44V9.81C10.44 7.31 11.93 5.96 14.22 5.96C15.31 5.96 16.45 6.15 16.45 6.15V8.62H15.19C13.95 8.62 13.56 9.39 13.56 10.18V12.06H16.34L15.89 14.96H13.56V21.96A10.01 10.01 0 0 0 22 12.06C22 6.53 17.5 2.04 12 2.04Z"/></svg> </a>
            <a href="https://wa.me/5512992061898?text=Ol√°,%20gostaria%20de%20mais%20informa√ß√µes%20da%20Cl√≠nica%20Lorraine%20Botura!" target="_blank" aria-label="WhatsApp"> <svg viewBox="0 0 24 24"><path d="M12.04 2C6.58 2 2.13 6.45 2.13 12C2.13 13.8 2.64 15.5 3.57 16.96L2 22L7.19 20.53C8.6 21.4 10.27 21.94 12.04 21.94C17.5 21.94 21.95 17.5 21.95 12C21.95 6.45 17.5 2 12.04 2M12.04 3.67C16.56 3.67 20.28 7.39 20.28 12C20.28 16.61 16.56 20.33 12.04 20.33C10.47 20.33 8.96 19.86 7.7 19.05L7.26 18.79L4.6 19.5L5.37 17L5.09 16.54C4.24 15.21 3.79 13.65 3.79 12C3.79 7.39 7.51 3.67 12.04 3.67M16.58 14.53C16.41 14.44 15.3 13.91 15.12 13.85C14.93 13.79 14.79 13.76 14.66 13.93C14.53 14.11 14.02 14.71 13.86 14.88C13.71 15.06 13.56 15.08 13.27 14.99C12.98 14.9 12.07 14.61 10.99 13.66C10.16 12.91 9.61 12.04 9.45 11.76C9.3 11.47 9.43 11.34 9.56 11.21C9.68 11.09 9.83 10.9 9.97 10.73C10.1 10.56 10.16 10.44 10.25 10.27C10.34 10.1 10.28 9.96 10.22 9.83C10.16 9.7 9.65 8.41 9.46 7.94C9.28 7.47 9.1 7.53 8.95 7.53C8.79 7.53 8.65 7.53 8.51 7.53C8.37 7.53 8.13 7.59 7.92 7.8C7.71 8.02 7.16 8.54 7.16 9.73C7.16 10.92 7.95 12.04 8.09 12.22C8.23 12.39 10.18 15.31 13.11 16.76C13.91 17.11 14.54 17.32 15.01 17.48C15.7 17.7 16.23 17.66 16.66 17.6C17.13 17.54 18.12 17 18.33 16.41C18.54 15.83 18.54 15.34 18.45 15.21C18.37 15.08 18.23 15.02 18.06 14.93C17.89 14.84 16.75 14.31 16.58 14.25" fill-rule="evenodd"/></svg> </a>
            <a href="https://lorrainebotura.com.br/" target="_blank" aria-label="Website Principal"> <svg viewBox="0 0 24 24"><path d="M10.59,13.41C11,13.8 11,14.44 10.59,14.83C10.2,15.22 9.56,15.22 9.17,14.83C7.22,12.88 7.22,9.71 9.17,7.76V7.76L12,10.59L14.83,7.76C15.22,7.37 15.86,7.37 16.25,7.76C16.64,8.15 16.64,8.79 16.25,9.18L13.41,12L16.25,14.83C16.64,15.22 16.64,15.86 16.25,16.25C15.86,16.64 15.22,16.64 14.83,16.25L12,13.41L9.17,16.25C8.78,16.64 8.14,16.64 7.75,16.25C7.36,15.86 7.36,15.22 7.75,14.83L10.59,12L7.75,9.17C7.36,8.78 7.36,8.14 7.75,7.75C8.14,7.36 8.78,7.36 9.17,7.75L12,10.59L14.83,7.75C15.22,7.36 15.86,7.36 16.25,7.75C16.64,8.14 16.64,8.78 16.25,9.17L13.41,12L16.25,14.83C16.64,15.22 16.64,15.86 16.25,16.25C15.86,16.64 15.22,16.64 14.83,16.25L12,13.41Z M19,3H5C3.89,3 3,3.9 3,5V19C3,20.1 3.9,21 5,21H19C20.1,21 21,20.1 21,19V5C21,3.9 20.1,3 19,3Z" /></svg> </a>
            <a href="https://www.google.com/search?kgmid=/g/11gpgszlsj&hl=pt-BR&q=Lorraine+Botura+Est%C3%A9tica&shndl=30&source=sh/x/loc/osrp/m5/1&kgs=719c6f2276454cec#" target="_blank" aria-label="Avalie no Google"> <svg viewBox="0 0 24 24"><path d="M21.35 11.1H12.18V13.83H18.69C18.36 17.64 15.19 19.27 12.19 19.27C8.36 19.27 5.03 16.41 5.03 12.5C5.03 8.59 8.36 5.73 12.19 5.73C15.1 5.73 17.33 7.95 17.33 7.95L19.78 5.73C19.78 5.73 16.94 3 12.19 3C6.92 3 3.06 7.03 3.06 12.5C3.06 17.97 6.92 22 12.19 22C17.61 22 21.31 18.47 21.31 13.36C21.31 12.41 21.35 11.77 21.35 11.1Z"/></svg> </a>
        </div>
        <div class="footer-text">
            ¬© 2024 Cl√≠nica Lorraine Botura. Todos os direitos reservados. | <a href="https://lorrainebotura.com.br/biografia/" target="_blank">Sobre Lorraine Botura</a>
        </div>
    </footer>

    <!-- Modal de Configura√ß√µes Removido -->

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // --- CONFIGURA√á√ïES ---
        const SUPABASE_URL = 'https://wrsjjnlpwwtrwekjhjcy.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indyc2pqbmxwd3d0cndla2poamN5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQ4MDY5MjcsImV4cCI6MjA2MDM4MjkyN30.5hjlREAHW6Zd-PKTB3eGuKSbJFHSW5s8OCGd_jr-f4o'; // ANON KEY
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        // Removido GEMINI_API_KEY e GEMINI_API_URL - N√£o estamos usando a API neste fluxo
        const WHATSAPP_NUMBER = '5512992061898';

        // --- ESTADO DA APLICA√á√ÉO ---
        let userData = { name: null, phone: null, protocol: null };
        let chatHistory = []; // Apenas hist√≥rico para Supabase, n√£o para API
        let isWaitingFor = 'name_phone';
        let currentProcedure = null;
        let isProcessing = false;

        // --- ELEMENTOS DO DOM ---
        const chatBody = document.getElementById('chatBody');
        const userInput = document.getElementById('userInput');
        const thinkingMessageDiv = chatBody.querySelector('.thinking');
        // Removido: settingsModal, agentPromptTextarea

        // --- DADOS DOS PROCEDIMENTOS (Atualizado) ---
        const procedureDetails = {
            'botox': { key: 'botox', name: 'Botox', description: 'üå∏ **Botox**<br>O Botox √© aplicado para suavizar linhas de express√£o e prevenir a forma√ß√£o de rugas. Atua relaxando a musculatura local de forma segura e controlada.', details: '<strong>Resultados esperados:</strong> apar√™ncia mais jovem e descansada, sem alterar sua express√£o natural.' },
            'labial': { key: 'labial', name: 'Preenchimento Labial', description: 'üå∏ **Preenchimento Labial**<br>O preenchimento labial √© feito com √°cido hialur√¥nico para dar mais volume, definir o contorno e hidratar os l√°bios. O procedimento √© r√°pido, com resultados imediatos e naturais.', details: '<strong>Resultados esperados:</strong> l√°bios mais volumosos, definidos e hidratados.' },
            'micro': { key: 'micro', name: 'Microagulhamento', description: 'üå∏ **Microagulhamento**<br>O microagulhamento utiliza pequenas agulhas para estimular o col√°geno e renovar a pele. √â ideal para melhorar cicatrizes, linhas finas, manchas e textura da pele.', details: '<strong>Resultados esperados:</strong> pele mais uniforme, firme e rejuvenescida.' },
            'limpeza': { key: 'limpeza', name: 'Limpeza de Pele Profunda', description: 'üå∏ **Limpeza de Pele Profunda**<br>A limpeza de pele profunda remove cravos, impurezas e c√©lulas mortas, promovendo a renova√ß√£o celular e preparando a pele para absorver melhor os ativos hidratantes.', details: '<strong>Resultados esperados:</strong> pele mais limpa, fresca e revitalizada.' },
            'laser': { key: 'laser', name: 'Depila√ß√£o a Laser', description: 'üå∏ **Depila√ß√£o a Laser**<br>A depila√ß√£o a laser elimina os pelos de forma progressiva e duradoura, atuando diretamente na raiz dos pelos com tecnologia de ponta e conforto.', details: '<strong>Resultados esperados:</strong> pele lisa, livre de pelos e muito mais pr√°tica no dia a dia.' },
            'corpo': { key: 'corpo', name: 'Tratamentos para Estrias e Celulite', description: 'üå∏ **Tratamentos para Estrias e Celulite**<br>Tratamentos personalizados que combinam t√©cnicas como laser, radiofrequ√™ncia, bioestimuladores e drenagem para suavizar a textura da pele e melhorar a apar√™ncia de estrias e celulite.', details: '<strong>Resultados esperados:</strong> pele mais uniforme, firme e bonita.' },
            'remodel': { key: 'remodel', name: 'Remodelagem Corporal', description: 'üå∏ **Remodelagem Corporal**<br>A remodelagem corporal visa reduzir medidas, modelar o contorno do corpo e melhorar a firmeza da pele, utilizando t√©cnicas como ultrassom, radiofrequ√™ncia e massagens especializadas.', details: '<strong>Resultados esperados:</strong> corpo mais definido, com curvas real√ßadas de forma natural.' },
            'peeling': { key: 'peeling', name: 'Peeling Qu√≠mico', description: 'üå∏ **Peeling Qu√≠mico**<br>O peeling qu√≠mico utiliza agentes renovadores para tratar manchas, rugas finas, acne e melhorar a textura da pele. A escolha do tipo de peeling √© personalizada conforme o tipo de pele.', details: '<strong>Resultados esperados:</strong> pele renovada, mais lisa, iluminada e uniforme.' },
            'hidragloss': { key: 'hidragloss', name: 'Hidragloss Labial', description: 'üå∏ **Hidragloss Labial**<br>Tratamento de hidrata√ß√£o profunda e revitaliza√ß√£o dos l√°bios, usando ativos potentes que melhoram o volume natural, a cor e a textura sem necessidade de preenchimento.', details: '<strong>Resultados esperados:</strong> l√°bios mais macios, vibrantes e rejuvenescidos.' }
        };
        const procedureLetterMap = {'A': 'botox', 'B': 'labial', 'C': 'micro', 'D': 'limpeza', 'E': 'laser', 'F': 'corpo', 'G': 'remodel', 'H': 'peeling', 'I': 'hidragloss'};

        // --- MAPA DE KEYWORDS PARA A√á√ïES/PROCEDIMENTOS ---
        const keywordToActionMap = {
            // Procedimentos (mapeia para a key em procedureDetails)
            'harmoniza√ß√£o': 'facial_harmony', // Precisa adicionar 'facial_harmony' em procedureDetails se quiser info espec√≠fica
            'harmonizacao': 'facial_harmony',
            'rosto': 'facial_harmony', // Gen√©rico para rosto
            'botox': 'botox',
            'rugas': 'botox', // Associa rugas a botox
            'marcas de express√£o': 'botox',
            'linhas de express√£o': 'botox',
            'testa': 'botox',
            'labial': 'labial',
            'l√°bio': 'labial',
            'l√°bios': 'labial',
            'boca': 'labial',
            'preenchimento': 'labial', // Default para labial, pode precisar de mais l√≥gica
            'microagulhamento': 'micro',
            'micro agulhamento': 'micro',
            'agulha': 'micro',
            'col√°geno': 'micro', // Associa a micro
            'limpeza': 'limpeza',
            'limpeza de pele': 'limpeza',
            'pele oleosa': 'limpeza', // Associa a limpeza
            'cravo': 'limpeza',
            'poros': 'limpeza', // Associa a limpeza
            'depila√ß√£o': 'laser',
            'laser': 'laser',
            'pelo': 'laser',
            'pelos': 'laser',
            'estrias': 'corpo',
            'celulite': 'corpo',
            'flacidez': 'corpo', // Associa a corpo ou remodelagem? Mapeando para corpo por enquanto
            'remodelagem': 'remodel',
            'modelar': 'remodel',
            'gordura': 'remodel',
            'gordura localizada': 'remodel',
            'contorno': 'remodel',
            'peeling': 'peeling',
            'manchas': 'peeling', // Associa a peeling
            'hidragloss': 'hidragloss',
            'gloss': 'hidragloss',
            '√°cido hialur√¥nico': 'labial', // Associa a labial
            'rejuvenescimento': 'botox', // Associa a botox
            // A√ß√µes Gerais
            'tratamento': 'procedure',
            'est√©tica': 'procedure',
            'procedimento': 'procedure',
            'agendar': 'schedule_general',
            'agenda': 'schedule_general',
            'marcar': 'schedule_general',
            'consulta': 'schedule_general',
            'avalia√ß√£o': 'schedule_general',
            'sess√£o': 'schedule_general',
            'pre√ßo': 'price',
            'valor': 'price',
            'quanto custa': 'price',
            'or√ßamento': 'price',
            'promo√ß√£o': 'promo',
            'desconto': 'promo',
            'oferta': 'promo',
            'endere√ßo': 'info',
            'local': 'info',
            'onde fica': 'info',
            'hor√°rio': 'info',
            'funcionamento': 'info',
            'pagamento': 'payment', // A√ß√£o direta para pagamento
            // Inten√ß√µes / Outros
            'd√∫vida': 'other_doubt',
            'ajuda': 'other_doubt',
            'atendimento': 'other_doubt', // Pode direcionar para d√∫vida geral
        };


        // --- FUN√á√ïES DE VALIDA√á√ÉO ---
        // (Mantidas)
        function validateName(name) { /* ... */ return name.trim().length > 2 && (name.includes(' ') || name.trim().length > 3); }
        function validatePhone(phone) { /* ... */ const cleaned = phone.replace(/\D/g, ''); return /^\d{10,11}$/.test(cleaned); }

        // --- FUN√á√ïES DE UTILIDADE ---
        // (Mantidas)
        function generateProtocol() { /* ... */ const now = new Date(); const ts = now.toISOString().replace(/[-T:.Z]/g, '').slice(0, 14); const rnd = String(Math.floor(1000 + Math.random() * 9000)); return `${ts}-${rnd}`; }
        function generateWhatsAppLink(context = '', procName = '', userPref = '') { /* ... */ const userPart = userData.name ? `${userData.name} (${userData.protocol || 'N/A'})` : `Protocolo: ${userData.protocol || 'N/A'}`; let txt = 'Ol√°! '; switch(context){ case 'agendamento': const pN = procName==='Avalia√ß√£o Geral'?'uma avalia√ß√£o geral':`uma avalia√ß√£o para ${procName}`; const uP = userPref?` para ${userPref}`:''; txt += `Gostaria de confirmar ${pN}${uP}. ${userPart}`; break; case 'promocoes': const prN = procName?` para ${procName}`:''; txt += `Gostaria de saber sobre promo√ß√µes atuais${prN}. ${userPart}`; break; case 'orcamento': txt += `Gostaria de um or√ßamento personalizado. ${userPart}`; break; case 'duvidas': default: txt += `Tenho d√∫vidas/Gostaria de mais informa√ß√µes. ${userPart}`; break; } return `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(txt)}`; }
        // ParseUserChoice n√£o ser√° mais t√£o usado para texto, mas mantido para refer√™ncia
        function parseUserChoice(input, optionsMap) { /* ... */ const lowerInput = input.toLowerCase().trim(); const choiceByLetter = lowerInput.toUpperCase(); if (optionsMap[choiceByLetter]) { return optionsMap[choiceByLetter].action; } for (const key in optionsMap) { const opt = optionsMap[key]; if (opt.keywords && opt.keywords.some(k => lowerInput.includes(k))) { return opt.action; } } return null; }

        // --- FUN√á√ïES DE CHAT ---
        // (Mantidas, com addMessage recebendo 'options')
         function addMessage(content, isUser, options = null) { /* ... MANTIDA (com gera√ß√£o de bot√µes) ... */
             if (!content.startsWith('‚ö†Ô∏è') && !(thinkingMessageDiv && content === thinkingMessageDiv.innerHTML) ) { chatHistory.push({ role: isUser ? 'user' : 'model', parts: [{ text: content + (options ? '\n[Op√ß√µes apresentadas]' : '') }] }); }
             const messageDiv = document.createElement('div'); messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`; messageDiv.innerHTML = content.replace(/<script.*?>.*?<\/script>/gi, '');
             if (!isUser && options) { const optionsContainer = document.createElement('div'); optionsContainer.className = 'options-container'; options.forEach(opt => { const button = document.createElement('button'); button.className = 'option-button'; button.setAttribute('data-choice', opt.action); button.onclick = () => handleButtonClick(opt.action, `${opt.letter}) ${opt.text}`); button.innerHTML = `<span class="option-letter">${opt.letter})</span> ${opt.text}`; optionsContainer.appendChild(button); }); messageDiv.appendChild(optionsContainer); }
             if (thinkingMessageDiv && chatBody.contains(thinkingMessageDiv)) { chatBody.insertBefore(messageDiv, thinkingMessageDiv); } else { chatBody.appendChild(messageDiv); } scrollToBottom();
         }
        function scrollToBottom() { /* ... MANTIDA ... */ chatBody.scrollTo({ top: chatBody.scrollHeight, behavior: 'smooth' }); }
        function showThinking(show = true) { /* ... MANTIDA ... */ if (!thinkingMessageDiv) return; thinkingMessageDiv.style.display = show ? 'block' : 'none'; if(show) scrollToBottom(); }
        function disablePreviousButtons() { /* ... MANTIDA ... */
            const previousButtons = chatBody.querySelectorAll('.option-button:not(:disabled)');
            previousButtons.forEach(button => { const messageContainer = button.closest('.message.bot-message'); const lastBotMessageWithOptions = chatBody.querySelector('.message.bot-message:has(.options-container):last-of-type'); if (messageContainer !== lastBotMessageWithOptions) { button.disabled = true; } });
        }

        // --- FUN√á√ÉO SALVAR/ATUALIZAR (UPSERT) ---
        // (Mantida)
        async function saveOrUpdateConversation() { /* ... MANTIDA ... */
            if (!userData.protocol) return; const hist = chatHistory.map(i => ({ sender: i.role, message: i.parts[0].text })); try { const { error } = await supabase.from('conversations').upsert({ protocol: userData.protocol, name: userData.name, phone: userData.phone, chat_history: hist }, { onConflict: 'protocol' }); if (error) console.error('Erro upsert:', error); } catch (err) { console.error('Catch upsert:', err); }
        }

        // --- GERADORES DE MENU COM BOT√ïES ---
        // (Mantidos da resposta anterior)
        function sendInitialMenu() { /* ... MANTIDA ... */ const txt = `Agora me diga, como posso te ajudar hoje? ‚ú®`; const opts = [ { letter: 'A', text: 'Saber sobre <strong>procedimento</strong>', action: 'procedure', keywords: ['procedimento'] }, { letter: 'B', text: '<strong>Agendar avalia√ß√£o</strong> geral', action: 'schedule_general', keywords: ['agendar'] }, { letter: 'C', text: '<strong>Informa√ß√µes da cl√≠nica</strong>', action: 'info', keywords: ['informa√ß√µes'] }, { letter: 'D', text: '<strong>Outra d√∫vida</strong>', action: 'other_doubt', keywords: ['d√∫vida'] } ]; addMessage(txt, false, opts); isWaitingFor = 'initial_choice'; }
        function sendProcedureListMenu() { /* ... MANTIDA ... */ const txt = `Maravilha, ${userData.name}! üòä Qual deles desperta seu interesse?`; const opts = Object.entries(procedureLetterMap).map(([l, k]) => ({ letter: l, text: procedureDetails[k].name, action: k, keywords: [k] })); opts.push({ letter: 'J', text: 'Outro', action: 'other_proc', keywords: ['outro'] }); addMessage(txt, false, opts); isWaitingFor = 'procedure_choice'; }
        function sendProcedureActionMenu(procKey) { /* ... MANTIDA ... */ const name = procedureDetails[procKey]?.name || 'este proc.'; const txt = `Sobre <strong>${name}</strong>, o que gostaria?`; const opts = [ { letter: 'A', text: 'Mais <strong>detalhes</strong>', action: 'details', keywords: ['detalhes'] }, { letter: 'B', text: '<strong>Agendar avalia√ß√£o</strong>', action: 'schedule_specific', keywords: ['agendar'] }, { letter: 'C', text: 'Verificar <strong>promo√ß√µes</strong>', action: 'promo', keywords: ['promo√ß√£o'] }, { letter: 'D', text: 'Ver <strong>outro procedimento</strong>', action: 'other_procedure', keywords: ['outro'] } ]; addMessage(txt, false, opts); isWaitingFor = 'procedure_action'; }
        function sendDetailsSubMenu(procKey) { /* ... MANTIDA ... */ const name = procedureDetails[procKey]?.name || 'este proc.'; const txt = `Gostaria de agendar para ${name}? üòä`; const opts = [ { letter: 'A', text: 'Sim, <strong>agendar avalia√ß√£o</strong>!', action: 'schedule_specific', keywords: ['sim', 'agendar'] }, { letter: 'B', text: `Saber <strong>promo√ß√µes</strong> p/ ${name}`, action: 'promo', keywords: ['promo√ß√£o'] }, { letter: 'C', text: `<strong>Outra d√∫vida</strong> sobre ${name}`, action: 'other_doubt_proc', keywords: ['d√∫vida'] }, { letter: 'D', text: 'Ver <strong>outros procedimentos</strong>', action: 'other_procedure', keywords: ['outro'] } ]; addMessage(txt, false, opts); isWaitingFor = 'procedure_action_after_details'; }
        function sendInfoClinicSubMenu() { /* ... MANTIDA ... */ const txt = `Precisa de mais informa√ß√µes, ${userData.name}?`; const opts = [ { letter: 'A', text: 'Formas de <strong>Pagamento</strong>', action: 'payment', keywords: ['pagamento'] }, { letter: 'B', text: 'Ver <strong>procedimentos</strong>', action: 'procedure', keywords: ['procedimento'] }, { letter: 'C', text: '<strong>Agendar avalia√ß√£o</strong>', action: 'schedule_general', keywords: ['agendar'] }, { letter: 'D', text: 'N√£o, obrigada!', action: 'end', keywords: ['n√£o'] } ]; addMessage(txt, false, opts); isWaitingFor = 'info_choice'; }
        function sendFinalConfirmationMenu() { /* ... MANTIDA ... */ const txt = `Posso te ajudar com mais algo, ${userData.name}? üòä`; const opts = [ { letter: 'A', text: 'Ver <strong>outro procedimento</strong>', action: 'procedure', keywords: ['procedimento'] }, { letter: 'B', text: '<strong>Informa√ß√µes da cl√≠nica</strong>', action: 'info', keywords: ['informa√ß√µes'] }, { letter: 'C', text: 'N√£o, obrigada!', action: 'end', keywords: ['n√£o'] } ]; addMessage(txt, false, opts); isWaitingFor = 'final_confirmation'; }
        function sendWhatsappRedirect(context = 'duvidas', procName = '', userPref = '') { /* ... MANTIDA ... */ let msg = ''; let link = ''; if (context === 'agendamento') { const pN=procName==='Avalia√ß√£o Geral'?'Avalia√ß√£o Geral':procName; link=generateWhatsAppLink(context,pN,userPref); msg=`Perfeito, ${userData.name}! üòä Para confirmar ${pN}${userPref?` para ${userPref}`:''} e hor√°rios...<br><br>‚û°Ô∏è <a href="${link}" target="_blank">Confirmar ${pN} via WhatsApp</a>`; } else if (context === 'promocoes') { link=generateWhatsAppLink(context,procName); msg=`Adoramos mimos! üíñ Para saber promo√ß√µes${procName?` para ${procName}`:''}...<br><br>‚û°Ô∏è <a href="${link}" target="_blank">Ver Promo√ß√µes no WhatsApp</a>`; } else if (context === 'orcamento') { link=generateWhatsAppLink(context); msg=`Valores personalizados... üòä Or√ßamento detalhado no WhatsApp...<br><br>‚û°Ô∏è <a href="${link}" target="_blank">Solicitar Or√ßamento via WhatsApp</a>`; } else { link=generateWhatsAppLink('duvidas'); msg=`Entendi, ${userData.name}. Para d√∫vidas espec√≠ficas...<br><br>‚û°Ô∏è <a href="${link}" target="_blank">Falar com a Equipe no WhatsApp</a>`; } addMessage(msg, false); if (context!=='agendamento' && context!=='promocoes') { isWaitingFor = 'message'; } else { setTimeout(sendFinalConfirmationMenu, 600); } }

        // --- NOVA FUN√á√ÉO PARA PROCESSAR KEYWORDS ---
        function processKeywords(text) {
            const lowerText = text.toLowerCase();
            let matchedAction = null;
            let highestPriority = -1; // Para dar prioridade (ex: 'agendar botox' vs 'botox')

            // Prioridade 1: A√ß√µes diretas (agendar, pre√ßo, info, etc.)
             const directActions = ['schedule_general', 'price', 'info', 'payment', 'promo', 'other_doubt', 'procedure'];
             for (const action of directActions) {
                const keywords = Object.entries(keywordToActionMap)
                                   .filter(([_, act]) => act === action)
                                   .map(([kw, _]) => kw);
                if (keywords.some(kw => lowerText.includes(kw))) {
                    if (1 > highestPriority) {
                         matchedAction = action;
                         highestPriority = 1;
                    }
                }
             }

             // Prioridade 0: Procedimentos espec√≠ficos (nomes e keywords associadas)
             for (const [keyword, action] of Object.entries(keywordToActionMap)) {
                 // Verifica se a action √© uma key de procedureDetails
                 if (procedureDetails[action] || action === 'facial_harmony') { // Inclui harmoniza√ß√£o mesmo sem details ainda
                     if (lowerText.includes(keyword)) {
                         if (0 > highestPriority) {
                             matchedAction = action; // Retorna a key do procedimento ('botox', 'labial')
                             highestPriority = 0;
                         }
                     }
                 }
             }


            console.log("Keyword check:", lowerText, "-> Matched Action:", matchedAction);
            return matchedAction;
        }


        // --- PROCESSAMENTO CENTRAL (ATUALIZADO COM KEYWORDS) ---
        async function processMessage(message, isButtonClick = false) {
            if (isProcessing && !isButtonClick) return;

            const inputText = isButtonClick ? message : message; // 'message' j√° √© a 'action' no clique, texto no input

            if (!isButtonClick) {
                addMessage(inputText, true); // Mostra o texto digitado
                userInput.value = '';
            }

            isProcessing = true;
            userInput.disabled = true;
            showThinking(true);
            disablePreviousButtons();

            try {
                let actionFromKeyword = null;

                // --- 0. VERIFICA KEYWORDS (APENAS PARA INPUT DIGITADO) ---
                if (!isButtonClick) {
                    actionFromKeyword = processKeywords(inputText);
                }

                // --- L√ìGICA PRINCIPAL ---
                // Se uma keyword foi encontrada E n√£o est√° na coleta inicial, age sobre ela
                if (actionFromKeyword && isWaitingFor !== 'name_phone') {
                    console.log("Processing Keyword Action:", actionFromKeyword);
                    if (procedureDetails[actionFromKeyword] || actionFromKeyword === 'facial_harmony') { // √â um procedimento?
                         currentProcedure = actionFromKeyword;
                         const desc = procedureDetails[actionFromKeyword]?.description || `üå∏ **Harmoniza√ß√£o Facial**<br>Um conjunto de procedimentos para real√ßar a beleza natural e equilibrar os tra√ßos do rosto.`; // Descri√ß√£o placeholder
                         addMessage(desc, false);
                         sendProcedureActionMenu(actionFromKeyword);
                    } else if (actionFromKeyword === 'procedure') {
                         sendProcedureListMenu();
                    } else if (actionFromKeyword === 'schedule_general') {
                         currentProcedure = 'general';
                         addMessage(`Que √≥timo saber do seu interesse... Qual <strong>dia</strong> e <strong>per√≠odo</strong>?`, false);
                         isWaitingFor = 'scheduling_preference';
                    } else if (actionFromKeyword === 'info') {
                         addMessage(`Com prazer, ${userData.name}! üòä ... üìç <strong>Endere√ßo:</strong>... ‚è∞ <strong>Hor√°rio:</strong> ...`, false);
                         sendInfoClinicSubMenu();
                    } else if (actionFromKeyword === 'payment') {
                        addMessage(`Aceitamos dinheiro, PIX, d√©bito e cr√©dito... üòä`, false);
                        // Decide o que fazer depois, talvez repetir o √∫ltimo menu? Ou menu info?
                         sendInfoClinicSubMenu(); // Repete menu info por seguran√ßa
                    } else if (actionFromKeyword === 'price') {
                         sendWhatsappRedirect('orcamento');
                    } else if (actionFromKeyword === 'promo') {
                         sendWhatsappRedirect('promocoes');
                    } else if (actionFromKeyword === 'other_doubt') {
                         sendWhatsappRedirect('duvidas');
                    } else {
                         // Keyword n√£o mapeada para uma a√ß√£o espec√≠fica conhecida aqui
                         addMessage(`Entendi que voc√™ mencionou algo sobre "${inputText}", mas n√£o sei como direcionar. Pode tentar uma das op√ß√µes ou falar com nossa equipe?`, false);
                         sendInitialMenu(); // Volta ao in√≠cio
                    }
                }
                // Se N√ÉO houve keyword ou est√° na coleta inicial, segue o fluxo normal baseado em 'isWaitingFor'
                else {
                    console.log("Processing State:", isWaitingFor, "Input/Action:", inputText);
                    // --- 1. Coleta Nome e Telefone ---
                    if (isWaitingFor === 'name_phone') { /* ... (l√≥gica mantida) ... */
                         const parts = inputText.split(/,|\s(\d{10,11})$/); let potentialName = null; let potentialPhone = null; if (parts && parts.length >= 2) { potentialName = parts[0]?.trim(); const phoneMatch = inputText.match(/(\d{10,11})\s*$/); if (phoneMatch) { potentialPhone = phoneMatch[1]; potentialName = inputText.replace(phoneMatch[0], '').trim().replace(/,$/, '').trim(); } else { potentialPhone = parts[1]?.replace(/\D/g, ''); } }
                         if (potentialName && potentialPhone && validateName(potentialName) && validatePhone(potentialPhone)) { userData.name = potentialName.split(' ').map(w=>w[0].toUpperCase()+w.slice(1).toLowerCase()).join(' '); userData.phone = potentialPhone; userData.protocol = generateProtocol(); await saveOrUpdateConversation(); addMessage(`Que prazer te receber, ${userData.name}! üíñ Seu protocolo: <strong>${userData.protocol}</strong>.`, false); sendInitialMenu(); }
                         else { addMessage(`Desculpe, n√£o consegui identificar nome e telefone. Tente novamente (Ex: Maria Silva, 11987654321). üôè`, false); }
                    }
                    // --- 2. Menu Inicial ---
                    else if (isWaitingFor === 'initial_choice') { /* ... (l√≥gica mantida, usa inputText como action) ... */
                         const action = inputText; if (action === 'procedure') { sendProcedureListMenu(); } else if (action === 'schedule_general') { currentProcedure = 'general'; addMessage(`√ìtimo! Qual <strong>dia</strong> e <strong>per√≠odo</strong>?`, false); isWaitingFor = 'scheduling_preference'; } else if (action === 'info') { addMessage(`Com prazer... üìç <strong>Endere√ßo:</strong>... ‚è∞ <strong>Hor√°rio:</strong> ...`, false); sendInfoClinicSubMenu(); } else if (action === 'other_doubt') { sendWhatsappRedirect('duvidas'); }
                         else { addMessage(`Desculpe, n√£o entendi. Por favor, clique ou digite A, B, C ou D.`, false); sendInitialMenu(); } // Repete menu
                    }
                    // --- 3. Escolha do Procedimento ---
                    else if (isWaitingFor === 'procedure_choice') { /* ... (l√≥gica mantida, usa inputText como action) ... */
                         const action = inputText; if (procedureDetails[action]) { currentProcedure = action; addMessage(procedureDetails[action].description, false); sendProcedureActionMenu(action); } else if (action === 'other_proc') { addMessage(`Qual outro procedimento?`, false); isWaitingFor = 'message'; }
                         else { addMessage(`Procedimento n√£o encontrado. Escolha uma op√ß√£o da lista.`, false); sendProcedureListMenu(); } // Repete menu
                    }
                    // --- 4. A√ß√£o dentro do Procedimento ---
                    else if (isWaitingFor === 'procedure_action') { /* ... (l√≥gica mantida, usa inputText como action) ... */
                        const action = inputText; if (action === 'details' && currentProcedure) { addMessage(procedureDetails[currentProcedure].details || `Info extra...`, false); sendDetailsSubMenu(currentProcedure); } else if (action === 'schedule_specific' && currentProcedure) { addMessage(`Agendar ${procedureDetails[currentProcedure].name}... Qual <strong>dia</strong> e <strong>per√≠odo</strong>?`, false); isWaitingFor = 'scheduling_preference'; } else if (action === 'promo') { sendWhatsappRedirect('promocoes', procedureDetails[currentProcedure]?.name); } else if (action === 'other_procedure') { sendProcedureListMenu(); }
                        else { addMessage(`Op√ß√£o inv√°lida. Escolha A, B, C ou D.`, false); sendProcedureActionMenu(currentProcedure); } // Repete menu
                    }
                     // --- 4.1 A√ß√£o AP√ìS Ver Detalhes ---
                    else if (isWaitingFor === 'procedure_action_after_details') { /* ... (l√≥gica mantida, usa inputText como action) ... */
                         const action = inputText; if (action === 'schedule_specific' && currentProcedure) { addMessage(`√ìtimo! Agendar ${procedureDetails[currentProcedure].name}... Qual <strong>dia</strong> e <strong>per√≠odo</strong>?`, false); isWaitingFor = 'scheduling_preference'; } else if (action === 'promo') { sendWhatsappRedirect('promocoes', procedureDetails[currentProcedure]?.name); } else if (action === 'other_doubt_proc') { sendWhatsappRedirect('duvidas', procedureDetails[currentProcedure]?.name); } else if (action === 'other_procedure') { sendProcedureListMenu(); }
                         else { addMessage(`Op√ß√£o inv√°lida. Escolha A, B, C ou D.`, false); sendDetailsSubMenu(currentProcedure); } // Repete sub-menu
                    }
                    // --- 5. Coleta Prefer√™ncia de Agendamento ---
                    else if (isWaitingFor === 'scheduling_preference') { /* ... (l√≥gica mantida, usa inputText como userPreference) ... */
                         const userPreference = inputText; const procName = currentProcedure==='general'?'Avalia√ß√£o Geral':procedureDetails[currentProcedure]?.name||'sua avalia√ß√£o'; sendWhatsappRedirect('agendamento', procName, userPreference);
                    }
                    // --- 6. Menu de Informa√ß√µes da Cl√≠nica ---
                    else if (isWaitingFor === 'info_choice') { /* ... (l√≥gica mantida, usa inputText como action) ... */
                         const action = inputText; if(action === 'payment') { addMessage(`Aceitamos dinheiro, PIX, d√©bito e cr√©dito... üòä`, false); sendInfoClinicSubMenu(); } else if (action === 'procedure') { sendProcedureListMenu(); } else if (action === 'schedule_general') { currentProcedure = 'general'; addMessage(`Agendar avalia√ß√£o geral! Qual <strong>dia</strong> e <strong>per√≠odo</strong>?`, false); isWaitingFor = 'scheduling_preference'; } else if (action === 'end') { addMessage(`Perfeito, ${userData.name}! ... üå∏`, false); isWaitingFor = 'message'; }
                         else { addMessage(`Op√ß√£o inv√°lida. Escolha A, B, C ou D.`, false); sendInfoClinicSubMenu();} // Repete menu
                    }
                    // --- 7. Menu Final de Confirma√ß√£o ---
                    else if (isWaitingFor === 'final_confirmation') { /* ... (l√≥gica mantida, usa inputText como action) ... */
                        const action = inputText; if (action === 'procedure') { sendProcedureListMenu(); } else if (action === 'info') { addMessage(`Claro! O que mais?`, false); sendInfoClinicSubMenu(); } else if (action === 'end') { addMessage(`Tudo bem, ${userData.name}! ... üíï At√© breve! üå∏`, false); isWaitingFor = 'message'; }
                        else { addMessage(`N√£o entendi. Escolha A, B ou C.`, false); sendFinalConfirmationMenu(); } // Repete menu
                    }
                    // --- 8. Estado Aberto ou Fallback ---
                    else { // Se isWaitingFor √© 'message' ou algum estado n√£o tratado
                        addMessage(`Desculpe, n√£o entendi o que voc√™ quis dizer com "${inputText}". Pode tentar outras palavras ou escolher uma op√ß√£o se houver?`, false);
                        // Decide qual menu reenviar ou se s√≥ espera
                        if (isWaitingFor !== 'message') { // Se estava esperando algo espec√≠fico, volta ao in√≠cio
                             sendInitialMenu();
                        } else {
                             // Se j√° estava em 'message', apenas espera nova tentativa
                        }
                    }
                }
                // Fim da L√≥gica Principal

                if (isWaitingFor !== 'name_phone') { await saveOrUpdateConversation(); }

            } catch (error) {
                console.error("Erro GERAL no processamento:", error);
                addMessage("‚ö†Ô∏è Ocorreu um erro inesperado. Tente novamente.", false);
                isWaitingFor = 'message';
            } finally {
                showThinking(false);
                isProcessing = false;
                userInput.disabled = false;
                 // Foca apenas se n√£o veio de bot√£o e se n√£o est√° esperando nome/tel
                 if (!isButtonClick && isWaitingFor !== 'name_phone') {
                    userInput.focus();
                 }
                scrollToBottom();
            }
        }

        // --- FUN√á√ÉO PARA LIDAR COM CLIQUE NO BOT√ÉO ---
        function handleButtonClick(choiceAction, choiceText) {
            if (isProcessing) return;
            // Apenas processa, n√£o adiciona a msg do usu√°rio aqui (j√° est√° no bot√£o)
            processMessage(choiceAction, true); // Passa a A√á√ÉO e marca como clique
        }

        // --- FUN√á√ÉO DE ENVIO PRINCIPAL ---
        function sendMessage() {
            const message = userInput.value.trim();
            if (message === '') return;
            processMessage(message, false); // Processa texto digitado
        }

        // --- FUN√á√ïES DO MODAL (Removidas) ---
        // function openSettings() { /* ... */ }
        // function closeSettings() { /* ... */ }
        // async function saveAgentPrompt() { /* ... */ }

        // --- INICIALIZA√á√ÉO ---
        function initializeChat() {
            chatHistory = []; userData = { name: null, phone: null, protocol: null }; isWaitingFor = 'name_phone'; currentProcedure = null; isProcessing = false; userInput.disabled = false;
            const messages = chatBody.querySelectorAll('.message:not(.thinking)'); messages.forEach(msg => msg.remove()); showThinking(false);

            addMessage('Ol√°! üå∏ Sou a assistente virtual da Cl√≠nica Lorraine Botura... informe seu <strong>nome completo</strong> e <strong>telefone com DDD</strong>, por favor?<br>(Exemplo: Maria Silva, 11987654321)', false);
            userInput.focus();
        }

        // --- EVENT LISTENER ---
        userInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });

        // --- START ---
        document.addEventListener('DOMContentLoaded', initializeChat);

    </script>

</body>
</html>
